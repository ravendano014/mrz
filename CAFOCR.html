<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OCR y Detector de Códigos de Barras por Cámara o Imagen</title>
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14; --panel:#121821; --muted:#708090; --border:#243144; --accent:#3ba0ff; --good:#24c07a; --bad:#ff5964;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:#e6edf3}
  header{padding:16px 20px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0d121a,#0b0f14)}
  h1{font-size:18px; margin:0 0 4px}
  p.subtitle{margin:0; color:var(--muted); font-size:13px}
  .container{max-width:1100px; margin:18px auto; padding:0 16px; display:grid; gap:16px}
  .grid{display:grid; grid-template-columns:1.1fr 1fr; gap:16px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px}
  .title{font-size:14px; color:#b9c4d0; margin-bottom:10px; letter-spacing:.2px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  button, label.buttonlike{
    background:#172131; border:1px solid var(--border); color:#e6edf3;
    padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px
  }
  button:hover, label.buttonlike:hover{border-color:#31405a}
  button.primary{background:var(--accent); color:#001224; border-color:#2c7ed6}
  button.good{background:var(--good); color:#00160c; border-color:#1fa466}
  button.bad{background:var(--bad); color:#240005; border-color:#d34a53}
  input[type="file"]{display:none}
  select, input[type="text"]{
    background:#0f1622; color:#e6edf3; border:1px solid var(--border); border-radius:10px; padding:9px 10px; font-weight:600
  }
  .media{display:grid; gap:8px}
  .viewport{
    display:inline-block; position:relative; width:100%; max-height:360px; aspect-ratio:4/3;
    background:#0a0a0a; border:1px solid var(--border); border-radius:12px; overflow:hidden;
  }
  video, img.preview, canvas{position:absolute; inset:0; width:100%; height:100%; object-fit:contain}
  .status{font-size:13px; color:var(--muted); margin-top:6px; min-height:18px}
  pre.json{margin:0; padding:12px; background:#0f141c; border:1px dashed var(--border); border-radius:10px; overflow:auto; max-height:260px}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:left}
  th{color:#b9c4d0; font-weight:600}
  .badge{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#0f1622}
  .ok{color:var(--good)} .warn{color:var(--bad)}
  .hint{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>OCR y Detector de Códigos de Barras</h1>
  <p class="subtitle">Extrae texto con OCR y detecta códigos de barras desde cámara o imagen.</p>
</header>

<div class="container">
  <div class="grid">
    <section class="card">
      <div class="title">Entrada (Cámara o Imagen)</div>

      <div class="media">
        <div class="viewport">
          <video id="video" playsinline muted></video>
          <img id="imgPreview" class="preview" alt="Vista previa" style="display:none" />
          <canvas id="canvasGuide"></canvas>
          <canvas id="canvasOverlay"></canvas>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="startCam" class="primary">Iniciar cámara</button>
        <button id="stopCam" class="bad" disabled>Detener cámara</button>
        <button id="captureAndExtract" class="good" disabled>Capturar &amp; Extraer</button>

        <label class="buttonlike">
          Subir imagen
          <input id="fileInput" type="file" accept="image/*" />
        </label>
        <button id="extractFromImage">Extraer de imagen</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="badge">Idioma OCR:
          <select id="langSelect" style="margin-left:8px">
            <option value="eng" selected>Inglés (eng)</option>
            <option value="spa">Español (spa)</option>
            <option value="ita">Italiano (ita)</option>
            <option value="fra">Francés (fra)</option>
          </select>
        </label>
        <input id="langCustom" type="text" placeholder="Código(s) extra: p. ej., eng+spa" size="24" />
      </div>

      <div class="row" style="margin-top:8px">
        <label><input id="beepChk" type="checkbox"> Sonido al detectar</label>
        <label><input id="detailsChk" type="checkbox" checked> Mostrar detalles (BB/Puntos)</label>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge" id="camBadge">Cámara: <strong id="camState">detenida</strong></span>
        <span class="badge">Idioma actual: <strong id="langBadge">eng</strong></span>
        <span class="hint">Formatos compatibles: <span id="formats">—</span></span>
      </div>
      <div class="status" id="status">Listo.</div>
    </section>

    <section class="card">
      <div class="title">Resultados</div>
      <div class="row" style="gap:12px; margin-bottom:10px">
        <button id="clear">Limpiar</button>
        <span id="quality" class="badge">Confianza OCR: —</span>
        <span id="barcodesFound" class="badge">Códigos detectados: 0</span>
      </div>
      <pre id="jsonOut" class="json">{}</pre>
      <div style="height:10px"></div>
      <table id="tableOut">
        <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script type="module">
  import { BarcodeDetectorPolyfill } from "https://cdn.jsdelivr.net/npm/@undecaf/barcode-detector-polyfill@latest/dist/main.js";

  const el = {};
  document.querySelectorAll('[id]').forEach(e => el[e.id] = e);

  const video   = el.video;
  const canvasGuide = el.canvasGuide;
  const canvasOverlay = el.canvasOverlay;
  const imgPrev = el.imgPreview;
  const status  = el.status;
  const jsonOut = el.jsonOut;
  const table   = el.tableOut.querySelector('tbody');
  const camBadge= el.camState;
  const langBadge = el.langBadge;
  const quality = el.quality;
  const barcodesFound = el.barcodesFound;

  const ctxOverlay = canvasOverlay.getContext('2d');
  const ctxGuide = canvasGuide.getContext('2d');

  let detector = null;
  let supportedFormats = [];
  let stream = null;
  let lastImageEl = null;
  let videoRequestId = null;

  // --- Detector de Códigos de Barras ---
  async function createBarcodeDetector() {
    supportedFormats = await BarcodeDetectorPolyfill.getSupportedFormats();
    el.formats.textContent = supportedFormats.join(', ');
    detector = new BarcodeDetectorPolyfill({ formats: supportedFormats });
  }

  // --- Sonido de beep (WebAudio) ---
  let audioCtx = null;
  let lastBeepAt = 0;
  function beep() {
    const now = performance.now();
    if (now - lastBeepAt < 600) return;
    lastBeepAt = now;

    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.value = 880;
    gain.gain.value = 0.08;
    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    setTimeout(() => osc.stop(), 150);
  }

  // --- Dibuja guía (recuadro verde con esquinas) ---
  function drawGuide() {
    const W = canvasGuide.width = canvasGuide.clientWidth;
    const H = canvasGuide.height = canvasGuide.clientHeight;
    ctxGuide.clearRect(0, 0, W, H);

    // Marco de referencia ~ 70% del ancho, 60% del alto
    const w = Math.round(W * 0.72);
    const h = Math.round(H * 0.62);
    const x = Math.round((W - w) / 2);
    const y = Math.round((H - h) / 2);
    const L = 22;

    ctxGuide.lineWidth = 3;
    ctxGuide.strokeStyle = '#00e000';
    ctxGuide.beginPath();
    // Esquinas tipo "L"
    ctxGuide.moveTo(x, y + L); ctxGuide.lineTo(x, y); ctxGuide.lineTo(x + L, y);
    ctxGuide.moveTo(x + w - L, y); ctxGuide.lineTo(x + w, y); ctxGuide.lineTo(x + w, y + L);
    ctxGuide.moveTo(x, y + h - L); ctxGuide.lineTo(x, y + h); ctxGuide.lineTo(x + L, y + h);
    ctxGuide.moveTo(x + w - L, y + h); ctxGuide.lineTo(x + w, y + h); ctxGuide.lineTo(x + w, y + h - L);
    ctxGuide.stroke();

    // Borde suave punteado
    ctxGuide.setLineDash([8, 8]);
    ctxGuide.lineDashOffset = 0;
    ctxGuide.strokeStyle = 'rgba(0,224,0,0.6)';
    ctxGuide.lineWidth = 2;
    ctxGuide.strokeRect(x, y, w, h);
    ctxGuide.setLineDash([]);
  }

  // --- Detección de Códigos de Barras ---
  async function detectBarcodes(source) {
    const sW = source.naturalWidth || source.videoWidth || source.width || canvasGuide.clientWidth;
    const sH = source.naturalHeight || source.videoHeight || source.height || canvasGuide.clientHeight;

    // Ajusta canvas de dibujo de overlays
    canvasOverlay.width = sW;  canvasOverlay.height = sH;
    ctxOverlay.clearRect(0, 0, sW, sH);

    const symbols = await detector.detect(source);

    // Dibuja polígonos sobre códigos
    for (const symbol of symbols) {
      const pts = symbol.cornerPoints || [];
      if (pts.length) {
        ctxOverlay.beginPath();
        const last = pts[pts.length - 1];
        ctxOverlay.moveTo(last.x, last.y);
        for (const p of pts) ctxOverlay.lineTo(p.x, p.y);
        ctxOverlay.lineWidth = 3;
        ctxOverlay.strokeStyle = '#3ba0ff'; // Color azul para códigos
        ctxOverlay.stroke();
      }
    }

    // Limpia detalles sensibles si no se solicitan
    const out = symbols.map(s => {
      const obj = { ...s };
      if (!el.detailsChk.checked) {
        delete obj.boundingBox;
        delete obj.cornerPoints;
      }
      return obj;
    });

    // Beep opcional
    if (el.beepChk.checked && symbols.length) beep();

    return out;
  }

  // --- Bucle de vídeo de detección de Códigos de Barras ---
  function detectVideoLoop(on) {
    if (on) {
      detectBarcodes(video).then(() => videoRequestId = requestAnimationFrame(() => detectVideoLoop(true)));
    } else {
      if (videoRequestId) cancelAnimationFrame(videoRequestId);
      videoRequestId = null;
    }
  }

  // --- Lógica de la cámara ---
  el.startCam.addEventListener('click', async ()=>{
    if (videoRequestId) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      video.srcObject = stream;
      await video.play();
      el.stopCam.disabled=false;
      el.captureAndExtract.disabled=true;
      camBadge.textContent='iniciando…';
      video.onplaying = ()=>{ el.captureAndExtract.disabled=false; camBadge.textContent='activa'; };
      imgPrev.style.display='none';
      video.style.display='block';
      setStatus('Cámara iniciada. Usando detección en vivo de códigos de barras.');
      lastImageEl = null;
      detectVideoLoop(true); // Inicia bucle de detección en vivo
    }catch(err){
      setStatus('No se pudo iniciar la cámara: ' + err.message);
    }
  });

  el.stopCam.addEventListener('click', ()=>{
    detectVideoLoop(false); // Detiene bucle de detección en vivo
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    video.pause(); video.srcObject=null;
    el.stopCam.disabled=true;
    el.captureAndExtract.disabled=true;
    camBadge.textContent='detenida';
    setStatus('Cámara detenida.');
    ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height); // Limpia overlay
    video.style.display='none';
  });

  el.captureAndExtract.addEventListener('click', async ()=>{
    if(!stream || video.readyState<2){ setStatus('La cámara no está lista.'); return; }
    lastImageEl = video;
    await runExtraction(video);
  });

  // --- Lógica de imagen (Archivo) ---
  el.fileInput.addEventListener('change', ()=>{
    el.stopCam.click(); // Asegura detener cámara si está activa
    const f = el.fileInput.files && el.fileInput.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    imgPrev.src = url; imgPrev.style.display='block';
    video.style.display='none';
    setStatus('Imagen cargada. Presiona “Extraer de imagen”.');
    lastImageEl = imgPrev;
    ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height); // Limpia overlay
  });

  el.extractFromImage.addEventListener('click', async ()=>{
    if(!lastImageEl){ setStatus('No hay imagen seleccionada. Carga una imagen o usa la cámara.'); return; }
    await runExtraction(lastImageEl);
  });

  // --- Lógica del OCR (Adaptada de CAFOCR.html) ---
  function currentLang(){
    const custom = (el.langCustom.value || '').trim();
    const lang = custom || el.langSelect.value || 'eng';
    langBadge.textContent = lang;
    return lang;
  }
  el.langSelect.addEventListener('change', currentLang);
  el.langCustom.addEventListener('input', currentLang);

  function setStatus(msg){ status.textContent = msg; }

  function preprocessToCanvas(srcEl){
    const canvas = document.createElement('canvas'); // Usar canvas temporal
    const w = srcEl.naturalWidth || srcEl.videoWidth || srcEl.width;
    const h = srcEl.naturalHeight || srcEl.videoHeight || srcEl.height;
    if(!w || !h){ throw new Error('Imagen no válida.'); }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(srcEl, 0, 0, w, h);
    const imgData = ctx.getImageData(0,0,w,h);
    const d = imgData.data;
    const contrast = 1.35, threshold = 155;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2];
      let gray = 0.2126*r + 0.7152*g + 0.0722*b;
      gray = (gray-128)*contrast + 128;
      const v = gray > threshold ? 255 : 0;
      d[i]=d[i+1]=d[i+2]=v;
    }
    ctx.putImageData(imgData,0,0);
    return canvas;
  }

  async function runOCR(srcEl){
    const lang = currentLang();
    setStatus(`Preparando OCR (${lang})…`);
    const pre = preprocessToCanvas(srcEl);

    const worker = await Tesseract.createWorker(lang, 1, {
      logger: m => {
        if(m.status) setStatus(`OCR (${lang}): ${m.status}${m.progress ? ' ' + Math.round(m.progress*100)+'%' : ''}`);
      }
    });

    try{
      const { data } = await worker.recognize(pre);
      const texto = (data.text || '').trim().replace(/\s+/g,' ');
      const digits = (texto.match(/\d+/g) || []).join('') || '';
      const digitsArr = digits ? digits.split('').map(Number) : [];
      const conf = Array.isArray(data.words) && data.words.length
        ? data.words.reduce((s,w)=>s+(w.confidence||0),0)/data.words.length
        : (data.confidence ?? 0);

      const ocrPayload = {
        idioma_ocr: lang,
        texto_bruto: texto,
        digitos: digits,
        arreglo_digitos: digitsArr,
        confianza_media: Number(conf.toFixed(2))
      };

      return ocrPayload;

    }catch(err){
      console.error('Error en OCR:', err);
      setStatus('Error en OCR: ' + err.message);
      return { error_ocr: err.message };
    }finally{
      await worker.terminate();
    }
  }

  // --- Ejecución Combinada ---
  async function runExtraction(source){
    // 1. Detección de Códigos de Barras
    const barcodes = await detectBarcodes(source);
    barcodesFound.textContent = `Códigos detectados: ${barcodes.length}`;
    barcodesFound.style.borderColor = barcodes.length > 0 ? 'var(--good)' : 'var(--border)';

    // 2. OCR
    const ocrResult = await runOCR(source);

    // 3. Consolidar Resultados
    const finalPayload = {
      codigos_barras: barcodes,
      ocr: ocrResult
    };

    // 4. Mostrar en UI
    jsonOut.textContent = JSON.stringify(finalPayload, null, 2);
    table.innerHTML = '';
    
    addRow('--- CÓDIGOS DE BARRAS ---', '');
    if (barcodes.length === 0) {
      addRow('Resultado', 'No se detectaron códigos de barras.');
    } else {
      barcodes.forEach((b, i) => {
        const value = el.detailsChk.checked ? JSON.stringify(b) : b.format + ': ' + b.rawValue;
        addRow(`Código #${i+1}`, value);
      });
    }

    addRow('--- OCR (Reconocimiento de Texto) ---', '');
    addRow('Idioma OCR', ocrResult.idioma_ocr);
    addRow('Texto bruto', ocrResult.texto_bruto || '—');
    addRow('Dígitos (solo números)', ocrResult.digitos || '—');
    addRow('Arreglo de dígitos', ocrResult.arreglo_digitos?.length ? '['+ocrResult.arreglo_digitos.join(', ')+']' : '—');
    addRow('Confianza media', ocrResult.confianza_media + '%');
    
    quality.innerHTML = `Confianza OCR: <strong>${ocrResult.confianza_media.toFixed(2)}%</strong>`;
    quality.style.borderColor = ocrResult.confianza_media >= 70 ? 'var(--good)' : 'var(--bad)';
    quality.style.color = ocrResult.confianza_media >= 70 ? 'var(--good)' : 'var(--bad)';

    setStatus('Extracción combinada finalizada.');
  }

  function addRow(k,v){
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=k;
    const td2=document.createElement('td'); td2.textContent=v;
    if(k.startsWith('---')){ td1.colSpan = 2; td1.style.fontWeight = 'bold'; td1.style.color = 'var(--accent)'; td2.style.display = 'none'; }
    tr.appendChild(td1); tr.appendChild(td2); table.appendChild(tr);
  }

  el.clear.addEventListener('click', ()=>{
    jsonOut.textContent='{}';
    table.innerHTML='';
    quality.innerHTML='Confianza OCR: —';
    quality.style.removeProperty('border-color'); quality.style.removeProperty('color');
    barcodesFound.textContent = 'Códigos detectados: 0';
    barcodesFound.style.removeProperty('border-color');
    setStatus('Limpio.');
    ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
  });

  // Habilita contexto de audio al primer gesto del usuario
  ['click','change'].forEach(evt => {
    document.addEventListener(evt, () => {
      if (!audioCtx && el.beepChk.checked) {
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
      }
    }, { once:true, capture:true });
  });

  // --- Inicialización ---
  await createBarcodeDetector();
  drawGuide();
  
  // Redibuja guía al redimensionar
  const ro = new ResizeObserver(drawGuide);
  ro.observe(document.querySelector('.viewport'));
  
  // Ocultar video/imagen al inicio
  video.style.display='none';
  imgPrev.style.display='none';

</script>
</body>
</html>
