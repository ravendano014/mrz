<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lector PDF417 con Cámara (ZXing 0.20.0 UMD)</title>
<style>
  :root{--bg:#0f172a;--card:#0b1220;--muted:#94a3b8;--accent:#22c55e;--text:#e5e7eb;--danger:#ef4444}
  body{margin:0;background:linear-gradient(180deg,#071022,#0b1220);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{max-width:1100px;margin:0 auto;padding:1.25rem 1rem .5rem}
  h1{margin:0 0 .25rem;font-size:clamp(1.15rem,2.6vw,1.6rem)}
  p.lead{margin:.25rem 0 0;color:var(--muted);font-size:.95rem}
  .panel{max-width:1100px;margin:0 auto 2rem;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);border-radius:12px;padding:1rem;box-shadow:0 6px 18px rgba(0,0,0,.45)}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:1rem}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:1rem}
  .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin:.5rem 0 0}
  button{background:var(--accent);color:#05270f;border:none;padding:.6rem .9rem;border-radius:.65rem;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .btn.danger{background:var(--danger);color:#fff}
  label{display:block;margin:.75rem 0 .35rem;color:var(--muted);font-size:.9rem}
  textarea{width:100%;padding:.7rem;border-radius:.6rem;border:1px solid rgba(255,255,255,.1);background:#0b1220;color:var(--text)}
  .video-wrap{position:relative;aspect-ratio:16/9;background:#000;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  video{width:100%;height:100%;object-fit:cover}
  canvas#snap{display:none}
  .aim{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);border:3px solid var(--accent);border-radius:10px;box-shadow:0 0 0 9999px rgba(0,0,0,.25) inset;width:72%;height:26%;}
  .mini{font-size:.85rem;color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .status.ok{color:#86efac}
  .status.bad{color:#fca5a5}
</style>
</head>
<body>
  <header>
    <h1>Lector <span style="color:var(--accent)">PDF417</span> con Cámara</h1>
    <p class="lead">Apunta el código dentro del recuadro verde, luego <strong>Capturar &amp; Decodificar</strong>. Puedes iniciar o detener la cámara en cualquier momento.</p>
  </header>

  <section class="panel grid">
    <div class="card">
      <div class="video-wrap" id="videoWrap">
        <video id="video" playsinline muted></video>
        <div class="aim" id="aim"></div>
      </div>
      <canvas id="snap"></canvas>
      <div class="toolbar">
        <button id="startBtn">Iniciar cámara</button>
        <button id="stopBtn" class="btn danger" disabled>Detener</button>
        <button id="captureBtn" disabled>Capturar &amp; Decodificar</button>
        <label class="mini" id="camStatus">Estado: <span class="status bad">apagada</span></label>
      </div>
      <label>Imagen capturada:</label>
      <div class="video-wrap" style="aspect-ratio:4/3">
        <img id="preview" style="width:100%;height:100%;object-fit:contain;background:#020617;border-radius:8px" />
      </div>
    </div>

    <div class="card">
      <label>Resultado PDF417</label>
      <textarea id="result" rows="10" class="mono"></textarea>
    </div>
  </section>

  <!-- Librería ZXing 0.20.0 UMD -->
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

  <script>
  (function(){
    const video = document.getElementById('video');
    const videoWrap = document.getElementById('videoWrap');
    const aim = document.getElementById('aim');
    const snap = document.getElementById('snap');
    const preview = document.getElementById('preview');
    const resultBox = document.getElementById('result');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const camStatus = document.getElementById('camStatus');

    let mediaStream = null;
    let reader = null;

    function ensureReader(){
      if(!window.ZXing){
        alert('Error: ZXing no cargó correctamente.');
        throw new Error('ZXing no cargado');
      }
      if(!reader){
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.PDF_417]);
        reader = new ZXing.MultiFormatReader();
        reader.setHints(hints);
      }
      return reader;
    }

    function setStatus(on){
      camStatus.innerHTML = 'Estado: ' + (on ? '<span class="status ok">encendida</span>' : '<span class="status bad">apagada</span>');
      startBtn.disabled = on;
      stopBtn.disabled = !on;
      captureBtn.disabled = !on;
    }

    async function startCamera(){
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
        video.srcObject = mediaStream;
        await video.play();
        setStatus(true);
      }catch(err){
        alert('No se pudo acceder a la cámara: ' + err.message);
        setStatus(false);
      }
    }

    function stopCamera(){
      if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
      video.srcObject = null;
      setStatus(false);
    }

    function captureAndDecode(){
      if(!mediaStream || video.readyState < 2){ alert('La cámara no está lista'); return; }
      const vw = video.videoWidth, vh = video.videoHeight;
      const wrapRect = videoWrap.getBoundingClientRect();
      const aimRect = aim.getBoundingClientRect();
      const scaleX = vw / wrapRect.width;
      const scaleY = vh / wrapRect.height;
      const cropX = Math.max(0, Math.round((aimRect.left - wrapRect.left) * scaleX));
      const cropY = Math.max(0, Math.round((aimRect.top - wrapRect.top) * scaleY));
      const cropW = Math.min(vw - cropX, Math.round(aimRect.width * scaleX));
      const cropH = Math.min(vh - cropY, Math.round(aimRect.height * scaleY));
      snap.width = cropW; snap.height = cropH;
      const ctx = snap.getContext('2d');
      ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
      preview.src = snap.toDataURL('image/png');

      try{
        const r = ensureReader();
        const luminance = new ZXing.HTMLCanvasElementLuminanceSource(snap);
        const binarizer = new ZXing.HybridBinarizer(luminance);
        const bitmap = new ZXing.BinaryBitmap(binarizer);
        const res = r.decode(bitmap);
        resultBox.value = res.getText();
      }catch(err){
        alert('No se pudo decodificar: ' + err);
        resultBox.value='';
      }
    }

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    captureBtn.addEventListener('click', captureAndDecode);
  })();
  </script>
</body>
</html>