<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document Scanner ‚Äî PDF417 & MRZ + C√°mara</title>

  <!-- ZXing (UMD) expone window.ZXing.* para c√≥digos de barras (incluye PDF417) -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <!-- Tesseract para OCR (MRZ) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-alt:#121a2b;
      --text:#e5e7eb;
      --text-dim:#bac1ce;
      --primary:#3b82f6;
      --primary-700:#1d4ed8;
      --success:#22c55e;
      --success-700:#15803d;
      --danger:#ef4444;
      --danger-700:#b91c1c;
      --muted:#1f2a44;
      --border:#20304f;
      --chip:#1e293b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --panel-alt:#f7f8fc; --text:#1f2937; --text-dim:#4b5563;
      --primary:#2563eb; --primary-700:#1e40af; --success:#16a34a; --success-700:#166534; --danger:#dc2626; --danger-700:#991b1b;
      --muted:#e8ecf7; --border:#e5e7eb; --chip:#eef2ff; --shadow: 0 8px 24px rgba(0,0,0,.08);
    }

    *{box-sizing: border-box}
    html, body{height:100%}
    body{
      margin:0 auto; max-width:1200px; padding:24px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--text); line-height:1.6;
    }
    h1{ margin:0 0 6px 0; font-size: clamp(24px, 2.5vw, 34px); letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--text-dim); font-size: clamp(13px, 1.6vw, 16px); }
    .header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding-bottom:18px; margin-bottom:18px; border-bottom:1px solid var(--border); }

    .controls{ display:flex; flex-wrap: wrap; gap:12px; margin-bottom:18px; align-items:center; }
    .btn{ appearance:none; border:1px solid transparent; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer; transition:.15s; background:var(--primary); color:white; }
    .btn:hover{ background:var(--primary-700) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn.success{ background:var(--success) } .btn.success:hover{ background:var(--success-700) }
    .btn.danger{ background:var(--danger) } .btn.danger:hover{ background:var(--danger-700) }
    .btn.ghost{ background:transparent; border-color:var(--border); color:var(--text); }
    .btn.ghost:hover{ background:var(--panel-alt) }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); color:var(--text-dim); font-size:12px; font-weight:600; }
    input[type="file"]{ padding:8px; background:var(--panel); border:1px dashed var(--border); border-radius:10px; color:var(--text-dim); max-width: 320px; }

    .image-wrap{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow); margin-bottom:18px; }
    .image-title{ display:flex; align-items:center; gap:10px; font-weight:700; margin-bottom:12px; color:var(--text-dim); }
    #preview{ display:block; max-width:100%; max-height:320px; width:auto; height:auto; border-radius:10px; border:1px solid var(--border); background: var(--panel-alt); object-fit: contain; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr } }

    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow); min-height: 420px; display:flex; flex-direction:column; }
    .panel h3{ margin:0 0 12px 0; font-size:18px; color:var(--text); }
    .muted{ color:var(--text-dim); font-size:13px; }

    .scroll-wrap{ position: relative; overflow: auto; border-radius:10px; border:1px solid var(--border); background:var(--panel-alt); flex:1; max-height: 300px; }

    table.result-table{ width: max-content; border-collapse: collapse; font-size:14px; }
    .result-table thead th{ position: sticky; top: 0; background: var(--panel); z-index: 1; color:var(--text-dim); font-weight:700; border-bottom:1px solid var(--border); }
    .result-table th, .result-table td{ padding:8px 10px; text-align:left; white-space: nowrap; border-bottom:1px dashed var(--border); }
    .result-table tbody tr:nth-child(odd){ background: rgba(255,255,255,.02); }

    .ok{ color: var(--success); font-weight:700 } .fail{ color: var(--danger); font-weight:700 }
    .status, .meta, .summary{ display:flex; gap:10px; align-items:center; margin:10px 0; padding:10px 12px; border-radius:10px; background:var(--panel-alt); border:1px solid var(--border); color:var(--text-dim); font-size:13px; }
    .status progress{ flex:1; height:10px }
    .hidden{ display:none }
    .spacer{ flex:1 }
    .kbd{ font-family: var(--mono); font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:var(--panel-alt); color:var(--text-dim); }

    /* ====== C√°mara ====== */
    .camera-wrap{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow: var(--shadow); margin-bottom:18px; }
    .video-stage{ position:relative; width:100%; max-height:420px; overflow:hidden; background:var(--panel-alt); border:1px solid var(--border); border-radius:10px; }
    video#camera{ display:block; width:100%; height:auto; transform-origin:center center; }
    .roi{ position:absolute; border:2px dashed var(--primary); background:rgba(59,130,246,.08); border-radius:8px; cursor:move; }
    .handle{ position:absolute; width:14px; height:14px; border-radius:50%; background:var(--primary); border:2px solid white; }
    .handle.br{ right:-8px; bottom:-8px; cursor:nwse-resize; }
    .handle.tr{ right:-8px; top:-8px; cursor:nesw-resize; }
    .handle.bl{ left:-8px; bottom:-8px; cursor:nesw-resize; }
    .handle.tl{ left:-8px; top:-8px; cursor:nwse-resize; }
  </style>
</head>
<body>
  <header class="header">
    <div>
      <h1>Document Scanner</h1>
      <p class="subtitle">Extrae datos de <b>PDF417</b> y texto <b>MRZ</b> de documentos ‚Äî ahora con <b>vista previa desde c√°mara</b></p>
    </div>
    <div class="controls" style="margin:0">
      <span class="chip" id="themeChip">Tema</span>
      <button class="btn ghost" id="themeToggle" title="Cambiar tema">üåô Oscuro</button>
    </div>
  </header>

  <!-- ====== Controles de C√°mara ====== -->
  <section class="camera-wrap">
    <div class="controls" style="margin-bottom:10px">
      <button id="camStart" class="btn success">Iniciar c√°mara</button>
      <button id="camStop" class="btn danger" disabled>Detener</button>
      <button id="camSwitch" class="btn ghost" disabled>Cambiar c√°mara</button>
      <select id="camSelect" class="btn ghost" style="min-width:220px" title="Seleccionar c√°mara" disabled></select>
      <span class="spacer"></span>
      <button id="zoom100" class="btn ghost" disabled>Zoom 100%</button>
      <button id="zoom150" class="btn ghost" disabled>Zoom 150%</button>
      <button id="zoom250" class="btn ghost" disabled>Zoom 250%</button>
      <button id="torchBtn" class="btn ghost" disabled>üî¶ L√°mpara</button>
      <button id="captureBtn" class="btn" disabled>üì∏ Capturar a Vista Previa</button>
    </div>

    <div class="video-stage" id="videoStage">
      <video id="camera" playsinline muted></video>
      <!-- ROI inicial centrado -->
      <div id="roi" class="roi" style="left:20%; top:15%; width:60%; height:60%">
        <div class="handle tl"></div>
        <div class="handle tr"></div>
        <div class="handle bl"></div>
        <div class="handle br"></div>
      </div>
    </div>
    <p class="muted" style="margin-top:10px">Consejo: Ajusta el <b>ROI</b> (arrastrar o redimensionar) y usa <b>Capturar a Vista Previa</b> para enviar el recorte a la secci√≥n de imagen y luego decodificar.</p>
  </section>

  <!-- ====== Carga / Vista previa de imagen ====== -->
  <section class="controls">
    <input type="file" id="file" accept="image/*"/>
    <button id="decodeBtn" class="btn success">Decodificar documento</button>
    <span class="spacer"></span>
    <span class="chip">Consejo: tambi√©n puedes arrastrar una imagen aqu√≠</span>
  </section>

  <section class="image-wrap">
    <div class="image-title">üñºÔ∏è Vista previa</div>
    <img id="preview" src="./reverse_side_sample.jpg" alt="Vista previa del documento"/>
  </section>

  <section class="grid">
    <article class="panel">
      <h3>PDF417 (Datos Parseados)</h3>
      <div id="pdf417Error" class="status hidden"></div>
      <div id="pdf417Summary" class="summary hidden"></div>
      <div id="pdf417Table"></div>
      <div class="controls" style="margin-top:10px">
        <button id="copyDuiJson" class="btn ghost">Copiar DUI JSON</button>
        <button id="copyRawText" class="btn ghost">Copiar Texto Crudo</button>
      </div>
    </article>

    <article class="panel">
      <h3>MRZ (Datos Parseados)</h3>
      <div id="mrzError" class="status hidden"></div>
      <div id="status" class="status hidden">
        <span id="statusText">Cargando‚Ä¶</span>
        <progress id="prog" value="0" max="1"></progress>
      </div>
      <div id="meta" class="meta hidden"></div>
      <div id="resultSummary" class="summary hidden"></div>
      <div id="resultTable"></div>
      <div class="controls" style="margin-top:10px">
        <button id="copyMrz" class="btn ghost">Copiar MRZ</button>
        <button id="copyJson" class="btn ghost">Copiar JSON</button>
      </div>
    </article>
  </section>

  <script>
    // ========= Helpers DOM =========
    const $ = (s)=>document.querySelector(s);
    const fileEl = $('#file');
    const preview = $('#preview');
    const decodeBtn = $('#decodeBtn');
    const statusEl = $('#status');
    const statusText = $('#statusText');
    const prog = $('#prog');
    const pdf417Error = $('#pdf417Error');
    const mrzError = $('#mrzError');
    const metaEl = $('#meta');
    const copyMrz = $('#copyMrz');
    const copyJson = $('#copyJson');
    const resultSummary = $('#resultSummary');
    const resultTable = $('#resultTable');
    const themeToggle = $('#themeToggle');

    // DUI copy
    const pdf417Summary = $('#pdf417Summary');
    const pdf417Table = $('#pdf417Table');
    const copyDuiJson = $('#copyDuiJson');
    const copyRawText = $('#copyRawText');

    // C√°mara DOM
    const camStart = $('#camStart');
    const camStop = $('#camStop');
    const camSwitch = $('#camSwitch');
    const camSelect = $('#camSelect');
    const cameraEl = $('#camera');
    const videoStage = $('#videoStage');
    const roiEl = $('#roi');
    const zoom100 = $('#zoom100');
    const zoom150 = $('#zoom150');
    const zoom250 = $('#zoom250');
    const torchBtn = $('#torchBtn');
    const captureBtn = $('#captureBtn');

    let currentImageBlob = null;
    let currentParsedData = null;
    let currentDuiJSON = null;
    let currentDuiRawText = null;
    let isProcessing = false;

    // C√°mara state
    let stream = null;
    let currentDeviceId = null;
    let deviceList = [];
    let currentScale = 1;
    let torchOn = false;

    // ========= Tema (Dark/Light) =========
    const getPreferredTheme = () => {
      const saved = localStorage.getItem('docscanner.theme');
      if (saved) return saved;
      return matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    const applyTheme = (t) => {
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('docscanner.theme', t);
      themeToggle.textContent = t === 'dark' ? '‚òÄÔ∏è Claro' : 'üåô Oscuro';
    };
    applyTheme(getPreferredTheme());
    themeToggle.addEventListener('click', ()=>{
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });

    // ========= Drag & drop =========
    ['dragenter','dragover'].forEach(evt =>
      document.addEventListener(evt, e => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; })
    );
    document.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files?.[0];
      if (!file) return;
      loadFile(file);
    });

    // ========= Archivo =========
    fileEl.addEventListener('change', (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      loadFile(f);
    });
    function loadFile(f){
      const url = URL.createObjectURL(f);
      preview.src = url;
      currentImageBlob = f;
      resetResults();
    }

    // ========= Copiar =========
    copyMrz.addEventListener('click', async () => {
      const mrzLines = currentParsedData?.raw?.join('\n');
      if (!mrzLines || /A√∫n no/.test(mrzLines)) return;
      try{
        await navigator.clipboard.writeText(mrzLines);
        copyMrz.textContent = '¬°MRZ copiado!';
        setTimeout(()=>copyMrz.textContent='Copiar MRZ', 1100);
      }catch(err){ console.error(err); }
    });
    copyJson.addEventListener('click', async () => {
      if (!currentParsedData) return;
      try{
        const jsonToCopy = JSON.stringify(currentParsedData, null, 2);
        await navigator.clipboard.writeText(jsonToCopy);
        copyJson.textContent = '¬°JSON copiado!';
        setTimeout(()=>copyJson.textContent='Copiar JSON', 1100);
      }catch(err){ console.error(err); }
    });
    copyDuiJson.addEventListener('click', async () => {
      if (!currentDuiJSON) return;
      try{
        await navigator.clipboard.writeText(JSON.stringify(currentDuiJSON, null, 2));
        copyDuiJson.textContent = '¬°DUI JSON copiado!';
        setTimeout(()=>copyDuiJson.textContent='Copiar DUI JSON', 1100);
      }catch(err){ console.error(err); }
    });
    copyRawText.addEventListener('click', async () => {
      if (!currentDuiRawText) return;
      try{
        await navigator.clipboard.writeText(currentDuiRawText);
        copyRawText.textContent = '¬°Texto crudo copiado!';
        setTimeout(()=>copyRawText.textContent='Copiar Texto Crudo', 1100);
      }catch(err){ console.error(err); }
    });

    // ========= Decodificar =========
    decodeBtn.addEventListener('click', async () => {
      if (isProcessing) return;
      if (!currentImageBlob && !preview.src){
        alert('Primero selecciona una imagen o captura desde la c√°mara.');
        return;
      }
      isProcessing = true;
      decodeBtn.disabled = true;
      try{
        resetResults();
        await ensureImageLoaded(preview);
        await processPDF417();
        await processMRZ();
      }catch(err){
        console.error('Error general:', err);
      }finally{
        isProcessing = false;
        decodeBtn.disabled = false;
      }
    });

    // ========= C√°mara: helpers =========
    async function listCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        deviceList = devices.filter(d=>d.kind==='videoinput');
        camSelect.innerHTML = '';
        deviceList.forEach((d,i)=>{
          const opt = document.createElement('option');
          opt.value = d.deviceId; opt.textContent = d.label || `C√°mara ${i+1}`;
          camSelect.appendChild(opt);
        });
        camSelect.disabled = deviceList.length === 0;
        camSwitch.disabled = deviceList.length <= 1;
      }catch(e){ console.warn('enumerateDevices:', e); }
    }

    function enableCamUI(enabled){
      camStop.disabled = !enabled;
      camSwitch.disabled = !enabled || deviceList.length<=1;
      camSelect.disabled = !enabled || deviceList.length===0;
      zoom100.disabled = zoom150.disabled = zoom250.disabled = !enabled;
      torchBtn.disabled = !enabled;
      captureBtn.disabled = !enabled;
    }

    async function startCamera(){
      try{
        if (stream) stopCamera();
        // Preferir trasera en m√≥viles si no hay selecci√≥n
        const facing = currentDeviceId ? undefined : { ideal: 'environment' };
        const constraints = {
          video: {
            deviceId: currentDeviceId ? { exact: currentDeviceId } : undefined,
            facingMode: facing,
            width: { ideal: 1920 },
            height:{ ideal: 1080 }
          },
          audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraEl.srcObject = stream;
        await cameraEl.play();
        await listCameras();
        // Seleccionar en el combo la activa
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        currentDeviceId = settings.deviceId || currentDeviceId;
        if (currentDeviceId){ camSelect.value = currentDeviceId; }
        enableCamUI(true);
        setZoom(1);
      }catch(e){
        console.error('startCamera:', e);
        alert('No se pudo iniciar la c√°mara: ' + (e.message||e));
      }
    }

    function stopCamera(){
      if (stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      cameraEl.srcObject = null;
      enableCamUI(false);
      torchOn = false;
    }

    async function switchCamera(){
      if (!deviceList.length) return;
      const idx = deviceList.findIndex(d=>d.deviceId===currentDeviceId);
      const nextIdx = (idx + 1) % deviceList.length;
      currentDeviceId = deviceList[nextIdx].deviceId;
      await startCamera();
    }

    function setZoom(scale){
      currentScale = scale;
      cameraEl.style.transform = `scale(${scale})`;
    }

    async function toggleTorch(){
      try{
        if (!stream) return;
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities?.();
        if (!caps || !caps.torch){
          alert('La linterna no est√° soportada por esta c√°mara/navegador.');
          return;
        }
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        torchBtn.textContent = torchOn ? 'üî¶ L√°mpara (ON)' : 'üî¶ L√°mpara';
      }catch(e){
        console.warn('torch:', e);
        alert('No se pudo cambiar la linterna: ' + (e.message||e));
      }
    }

    function getRoiRect(){
      const stageRect = videoStage.getBoundingClientRect();
      const roiRect = roiEl.getBoundingClientRect();
      const x = roiRect.left - stageRect.left;
      const y = roiRect.top - stageRect.top;
      return { x, y, w: roiRect.width, h: roiRect.height, stageRect };
    }

    async function captureToPreview(){
      if (!stream) return;
      const video = cameraEl;
      // Tama√±o real del frame del video
      const vw = video.videoWidth; const vh = video.videoHeight;
      if (!vw || !vh){ alert('La c√°mara a√∫n no est√° lista.'); return; }

      // Relaci√≥n entre el tama√±o mostrado y el tama√±o real
      const stage = videoStage.getBoundingClientRect();
      const vidRect = video.getBoundingClientRect();
      const scaleX = vw / vidRect.width;
      const scaleY = vh / vidRect.height;

      // ROI relativo al stage
      const { x, y, w, h } = getRoiRect();
      // Convertir ROI mostrado -> coordenadas en video
      const sx = (x - (vidRect.left - stage.left)) * scaleX;
      const sy = (y - (vidRect.top - stage.top)) * scaleY;
      const sw = w * scaleX;
      const sh = h * scaleY;

      const canvas = document.createElement('canvas');
      canvas.width = Math.max(1, Math.min(vw, sw|0));
      canvas.height = Math.max(1, Math.min(vh, sh|0));
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL('image/png');
      preview.src = dataURL;
      currentImageBlob = null; // usamos el dataURL
      resetResults();
    }

    // ====== ROI: mover / redimensionar ======
    let dragging = false, resizing = false, handleType = null, startX=0, startY=0, startRect=null;

    roiEl.addEventListener('pointerdown', (e)=>{
      const target = e.target;
      if (target.classList.contains('handle')){
        resizing = true; dragging = false;
        handleType = [...target.classList].find(c=>['tl','tr','bl','br'].includes(c));
      } else {
        dragging = true; resizing = false; handleType = null;
      }
      startX = e.clientX; startY = e.clientY;
      const r = roiEl.getBoundingClientRect();
      const s = videoStage.getBoundingClientRect();
      startRect = { left:r.left - s.left, top:r.top - s.top, width:r.width, height:r.height };
      roiEl.setPointerCapture(e.pointerId);
    });

    roiEl.addEventListener('pointermove', (e)=>{
      if (!dragging && !resizing) return;
      const dx = e.clientX - startX; const dy = e.clientY - startY;
      let { left, top, width, height } = startRect;
      const stageW = videoStage.clientWidth, stageH = videoStage.clientHeight;

      if (dragging){
        left = Math.min(Math.max(0, left + dx), stageW - width);
        top  = Math.min(Math.max(0, top  + dy), stageH - height);
      }
      if (resizing){
        if (handleType==='br'){ width += dx; height += dy; }
        if (handleType==='tr'){ width += dx; height -= dy; top += dy; }
        if (handleType==='bl'){ width -= dx; left += dx; height += dy; }
        if (handleType==='tl'){ width -= dx; left += dx; height -= dy; top += dy; }
        width = Math.min(Math.max(40, width), stageW - left);
        height= Math.min(Math.max(40, height), stageH - top);
      }
      roiEl.style.left = left + 'px';
      roiEl.style.top  = top  + 'px';
      roiEl.style.width= width+ 'px';
      roiEl.style.height=height+ 'px';
    });

    roiEl.addEventListener('pointerup', (e)=>{ dragging = resizing = false; handleType=null; roiEl.releasePointerCapture(e.pointerId); });

    // ========= Eventos de c√°mara =========
    camStart.addEventListener('click', async ()=>{
      await startCamera();
    });
    camStop.addEventListener('click', ()=>{ stopCamera(); });
    camSwitch.addEventListener('click', async ()=>{ await switchCamera(); });
    camSelect.addEventListener('change', async (e)=>{ currentDeviceId = e.target.value || null; await startCamera(); });
    zoom100.addEventListener('click', ()=> setZoom(1));
    zoom150.addEventListener('click', ()=> setZoom(1.5));
    zoom250.addEventListener('click', ()=> setZoom(2.5));
    torchBtn.addEventListener('click', ()=> toggleTorch());
    captureBtn.addEventListener('click', ()=> captureToPreview());

    // ========= PDF417 con @zxing/library (UMD) =========
    async function processPDF417(){
      pdf417Error.classList.add('hidden');
      try{
        await ensureImageLoaded(preview);
        const reader = new ZXing.BrowserPDF417Reader();
        let result = null;
        try{
          result = await reader.decodeFromImageElement(preview);
        }catch(e1){
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = preview.naturalWidth || preview.width;
          canvas.height = preview.naturalHeight || preview.height;
          if (!canvas.width || !canvas.height) throw e1;
          ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);
          result = await reader.decodeFromCanvas(canvas);
        }
        tryAutoParseDUIFromPDF417(result);
      }catch(err){
        pdf417Error.classList.remove('hidden');
        pdf417Error.textContent = 'PDF417 Error: ' + (err?.message || err);
        pdf417Table.innerHTML = '<p class="muted">No se pudo decodificar PDF417.</p>';
      }
    }

    function ensureImageLoaded(img){
      return new Promise((resolve, reject)=>{
        if (img.complete && img.naturalWidth > 0) return resolve();
        img.onload = ()=> resolve();
        img.onerror = (e)=> reject(e);
      });
    }

    // ========= DUI Auto-Parse (desde texto de PDF417) =========
    function tryAutoParseDUIFromPDF417(resultObj){
      const rawText = extractRawTextFromPdf417(resultObj);
      currentDuiRawText = rawText || null;
      if (!rawText){
        pdf417Summary.classList.add('hidden');
        pdf417Table.innerHTML = '<p class="muted">No se encontr√≥ Texto crudo del PDF417 para parsear.</p>';
        currentDuiJSON = null; return;
      }
      const parsed = parseDUIFromRaw(rawText);
      if (!parsed){
        pdf417Summary.classList.add('hidden');
        pdf417Table.innerHTML = '<p class="muted">El Texto crudo no coincide con el formato esperado (separado por <code>||</code>).</p>';
        currentDuiJSON = null; return;
      }
      currentDuiJSON = parsed.toJSON;
      pdf417Summary.classList.remove('hidden');
      pdf417Summary.innerHTML = "<strong>Resultados</strong> ‚Äî <span class='ok'>DUI (PDF417 imagen) parseado.</span>";
      pdf417Table.innerHTML = renderKVTable(parsed.fields);
    }

    function extractRawTextFromPdf417(obj){
      try{
        if (!obj) return null;
        if (typeof obj.getText === 'function'){
          const t = obj.getText();
          if (t && typeof t === 'string' && t.trim()) return t.trim();
        }
        if (typeof obj === 'string'){
          try { obj = JSON.parse(obj); } catch(e){ if (obj.includes('||')) return obj.trim(); return null; }
        }
        if (Array.isArray(obj)){
          for (const it of obj){ const t = extractRawTextFromPdf417(it); if (t) return t; }
        }
        const candidates = [ obj?.text, obj?.Text, obj?.rawText, obj?.RawText, obj?.result?.text, obj?.result?.rawText, obj?.[0]?.text, obj?.[0]?.rawText ];
        for (const c of candidates){ if (typeof c === 'string' && c.trim()) return c.trim(); }
        for (const k of Object.keys(obj)){ const v = obj[k]; if (typeof v === 'string' && v.includes('||')) return v.trim(); }
      }catch(e){ console.warn('extractRawTextFromPdf417 error:', e); }
      return null;
    }

    function parseDUIFromRaw(raw){
      if (!raw || typeof raw !== 'string') return null;
      const parts = raw.split('||');
      if (parts.length < 17) return null;
      const FIELDS = [
        'N√∫mero de DUI','Primer Apellido','Segundo Apellido y Nombres','N√∫mero de Emisi√≥n','Firma Digital','Lugar de Nacimiento','Municipio','Profesi√≥n u Oficio','Sexo','Fecha de Nacimiento','Fecha de Emisi√≥n','C√≥digo de Zona','Categor√≠a','Estdo Familiar','Nacionalidad','Segunda Firma Digital','C√≥digo de Verificaci√≥n'
      ];
      const obj = {}; FIELDS.forEach((name, idx)=>{ obj[name] = (parts[idx] ?? '').trim(); });
      return { fields: obj, toJSON: obj, raw };
    }

    function renderKVTable(obj){
      let html = '<div class="scroll-wrap">';
      html += '<table class="result-table"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>';
      for (const [k,v] of Object.entries(obj)){
        const vv = (v ?? '') === '' ? '<span class="muted">‚Äî</span>' : escapeHtml(String(v));
        html += `<tr><td><strong>${escapeHtml(k)}</strong></td><td>${vv}</td></tr>`;
      }
      html += '</tbody></table></div>';
      return html;
    }

    // ========= MRZ (OCR + parseo) =========
    async function processMRZ(){
      mrzError.classList.add('hidden');
      statusEl.classList.remove('hidden');
      statusText.textContent = 'Cargando modelo‚Ä¶';
      prog.value = 0;
      try{
        const result = await Tesseract.recognize(
          currentImageBlob || preview.src,
          'eng',
          { logger: m => { if (m.status) statusText.textContent = m.status; if (m.progress != null) prog.value = m.progress; }, tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<' }
        );
        statusText.textContent = 'Analizando texto‚Ä¶';
        const raw = (result.data?.text || '').replace(/\u0000/g,'');
        const cleaned = normalizeOCR(raw);
        const block = findMRZBlock(cleaned);
        metaEl.classList.remove('hidden');
        metaEl.innerHTML = toKV({ 'Confianza OCR': (result.data?.confidence != null) ? result.data.confidence.toFixed(1)+'%' : '‚Äî', 'Tipo MRZ detectado': block?.type || 'Indeterminado', 'L√≠neas MRZ crudas': block ? block.lines.join(' | ') : '‚Äî' });
        let parsed = {};
        if (block?.type === 'TD3-2x44') parsed = parseTD3(block.lines);
        else if (block?.type === 'TD1-3x30') parsed = parseTD1(block.lines);
        else if (block?.type === 'TD2-2x36') parsed = parseTD2(block.lines);
        currentParsedData = generateFormattedJSON(parsed, block);
        displayResultsInTable(parsed, block?.type);
        statusText.textContent = 'Listo';
      }catch(err){
        statusText.textContent = 'Error';
        mrzError.classList.remove('hidden');
        mrzError.textContent = 'MRZ Error: ' + (err?.message || err);
        resultTable.innerHTML = '<p class="muted">No se pudo decodificar MRZ.</p>';
      }
    }

    // ========= Utilidades =========
    function toKV(obj){ return Object.entries(obj).map(([k,v])=> `<div><b>${escapeHtml(k)}</b></div><div>${escapeHtml(String(v))}</div>`).join(''); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    const MRZ_CHARS = /^[A-Z0-9<]+$/;
    function normalizeOCR(text){ return text.replace(/[\u2014\u2013\-]/g,'-').replace(/[\u00D8]/g,'O').replace(/[\u00A0\t]+/g,' ').replace(/[\r]+/g,'\n').split('\n').map(l=>l.trim().toUpperCase()).join('\n'); }
    function padTo(s,n){ return (s + '<'.repeat(Math.max(0, n - s.length))).slice(0,n) }
    function looksLikeMRZLine(s){ const t = s.replace(/\s+/g,''); return t.length >= 28 && MRZ_CHARS.test(t); }
    function findMRZBlock(cleaned){
      const lines = cleaned.split(/\n+/).map(l=>l.replace(/\s+/g,'')).filter(l => l.length >= 20 && /[A-Z0-9]/.test(l));
      if (!lines.length) return null;
      const candidates = [];
      for (let i=0;i<lines.length;i++){
        const a = lines[i], b = lines[i+1], c = lines[i+2];
        if (a && b && MRZ_CHARS.test(a) && MRZ_CHARS.test(b)){
          const scoreTD3 = scoreBlock([a,b],44);
          candidates.push({type:'TD3-2x44', lines:[padTo(a,44), padTo(b,44)], score:scoreTD3});
        }
        if (a && b && MRZ_CHARS.test(a) && MRZ_CHARS.test(b)){
          const scoreTD2 = scoreBlock([a,b],36);
          candidates.push({type:'TD2-2x36', lines:[padTo(a,36), padTo(b,36)], score:scoreTD2});
        }
        if (a && b && c && MRZ_CHARS.test(a) && MRZ_CHARS.test(b) && MRZ_CHARS.test(c)){
          const scoreTD1 = scoreBlock([a,b,c],30);
          candidates.push({type:'TD1-3x30', lines:[padTo(a,30), padTo(b,30), padTo(c,30)], score:scoreTD1});
        }
      }
      if (!candidates.length) return null;
      candidates.sort((x,y)=> y.score - x.score);
      return candidates[0];
    }
    function scoreBlock(lines, targetLen){ let s=0; for (const l of lines){ const len = l.length; const near = 1 - Math.min(1, Math.abs(targetLen - len)/targetLen); const charset = MRZ_CHARS.test(l) ? 1 : 0; s += (near*.7 + charset*.3);} return s/lines.length; }
    function valOf(ch){ if (ch === '<') return 0; if (ch >= '0' && ch <= '9') return ch.charCodeAt(0) - 48; if (ch >= 'A' && ch <= 'Z') return ch.charCodeAt(0) - 55; return 0; }
    function mrzCheck(str){ const w=[7,3,1]; let sum=0; for (let i=0;i<str.length;i++) sum += valOf(str[i]) * w[i%3]; return String(sum % 10); }
    function tidy(s){ return s.replace(/<+/g,' ').trim().replace(/\s+/g,' ') }
    function yymmddToISO(s){ if (!/^[0-9]{6}$/.test(s)) return null; const yy = parseInt(s.slice(0,2),10); const mm = parseInt(s.slice(2,4),10); const dd = parseInt(s.slice(4,6),10); const yyyy = (yy >= 50 ? 1900 + yy : 2000 + yy); if (mm < 1 || mm > 12 || dd < 1 || dd > 31) return null; return `${String(yyyy).padStart(4,'0')}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`; }

    function parseTD3(lines){ if (!lines || lines.length !== 2) return {}; const L1 = padTo(lines[0],44); const L2 = padTo(lines[1],44); const docType = L1.slice(0,2).replace('<',''); const issuing = L1.slice(2,5); const nameRaw = L1.slice(5); const [surname, givenAndMore] = nameRaw.split('<<'); const given = (givenAndMore || '').replace(/<+/g,' ').trim(); const passportNumber = L2.slice(0,9); const passportCheck = L2[9]; const nationality = L2.slice(10,13); const birthYYMMDD = L2.slice(13,19); const birthCheck = L2[19]; const sex = L2[20]; const expYYMMDD = L2.slice(21,27); const expCheck = L2[27]; const optData = L2.slice(28,42); const finalCheck = L2[43]; const composite = passportNumber + passportCheck + nationality + birthYYMMDD + birthCheck + sex + expYYMMDD + expCheck + optData; return { format:'TD3-2x44 (Passport)', documentType:docType, issuingCountry:issuing, surname: tidy(surname||''), givenNames: tidy(given||''), documentNumber: passportNumber, documentNumberCheck: passportCheck, nationality, birthDate: yymmddToISO(birthYYMMDD), birthCheck, sex: (sex==='M'||sex==='F')?sex:sex, expiryDate: yymmddToISO(expYYMMDD), expiryCheck: expCheck, optionalData: optData.replace(/<+$/,''), compositeCheck: finalCheck, checks:{ documentNumber: mrzCheck(passportNumber) === passportCheck, birthDate: mrzCheck(birthYYMMDD) === birthCheck, expiryDate: mrzCheck(expYYMMDD) === expCheck, composite: mrzCheck(composite) === finalCheck } } }
    function parseTD1(lines){ if (!lines || lines.length !== 3) return {}; const A = padTo(lines[0],30); const B = padTo(lines[1],30); const C = padTo(lines[2],30); const docType = A.slice(0,1); const issuing = A.slice(2,5); const docNum = A.slice(5,14).replace(/<+$/,''); const docCheck = A[14]; const opt1 = A.slice(15,30); const birthYYMMDD = B.slice(0,6); const birthCheck = B[6]; const sex = B[7]; const expYYMMDD = B.slice(8,14); const expCheck = B[14]; const nationality = B.slice(15,18); const opt2 = B.slice(18,29); const opt2Check = B[29]; const [surname, givenRest] = C.split('<<'); return { format:'TD1-3x30 (ID)', documentType:docType, issuingCountry:issuing, documentNumber:docNum, documentNumberCheck:docCheck, nationality, birthDate:yymmddToISO(birthYYMMDD), birthCheck, sex:(sex==='M'||sex==='F')?sex:sex, expiryDate:yymmddToISO(expYYMMDD), expiryCheck:expCheck, optionalData:(opt1+opt2).replace(/<+$/,''), optionalCheck:opt2Check, surname: tidy(surname||''), givenNames: tidy((givenRest||'').replace(/<+/g,' ')), checks:{ documentNumber: mrzCheck(docNum) === docCheck, birthDate: mrzCheck(birthYYMMDD) === birthCheck, expiryDate: mrzCheck(expYYMMDD) === expCheck } } }
    function parseTD2(lines){ if (!lines || lines.length !== 2) return {}; const A = padTo(lines[0],36); const B = padTo(lines[1],36); const docType = A.slice(0,2).replace('<',''); const issuing = A.slice(2,5); const namesRaw = A.slice(5); const [surname, givenRest] = namesRaw.split('<<'); const docNum = B.slice(0,9); const docCheck = B[9]; const nationality = B.slice(10,13); const birthYYMMDD = B.slice(13,19); const birthCheck = B[19]; const sex = B[20]; const expYYMMDD = B.slice(21,27); const expCheck = B[27]; const opt = B.slice(28,35); const finalCheck = B[35]; const composite = docNum + docCheck + nationality + birthYYMMDD + birthCheck + sex + expYYMMDD + expCheck + opt; return { format:'TD2-2x36 (Travel Document)', documentType:docType, issuingCountry:issuing, surname: tidy(surname||''), givenNames: tidy((givenRest||'').replace(/<+/g,' ')), documentNumber:docNum, documentNumberCheck:docCheck, nationality, birthDate:yymmddToISO(birthYYMMDD), birthCheck, sex:(sex==='M'||sex==='F')?sex:sex, expiryDate:yymmddToISO(expYYMMDD), expiryCheck:expCheck, optionalData: opt.replace(/<+$/,''), compositeCheck: finalCheck, checks:{ documentNumber: mrzCheck(docNum) === docCheck, birthDate: mrzCheck(birthYYMMDD) === birthCheck, expiryDate: mrzCheck(expYYMMDD) === expCheck, composite: mrzCheck(composite) === finalCheck } } }

    function generateFormattedJSON(parsed, block){ if (!parsed || Object.keys(parsed).length === 0) return { error:"Could not extract MRZ data" }; const formatType = parsed.format ? parsed.format.split('-')[0] : 'Unknown'; return { format: formatType, raw: block ? block.lines : [], documentCode: parsed.documentType || '', issuingState: parsed.issuingCountry || '', documentNumber: parsed.documentNumber || '', documentNumberCheck: parsed.documentNumberCheck || '', optionalData1: parsed.optionalData || '', birthDate: parsed.birthDate || '', birthDateCheck: parsed.birthCheck || '', sex: parsed.sex || '', expiryDate: parsed.expiryDate || '', expiryDateCheck: parsed.expiryCheck || '', nationality: parsed.nationality || '', optionalData2: '', finalCheck: parsed.compositeCheck || parsed.optionalCheck || '', surname: parsed.surname || '', givenNames: parsed.givenNames || '', checks: parsed.checks || {} } }

    function displayResultsInTable(parsed, formatType){
      if (!parsed || Object.keys(parsed).length === 0){ resultSummary.classList.add('hidden'); resultTable.innerHTML = '<p class="muted">No fue posible extraer datos MRZ.</p>'; return; }
      let valid=0,total=0; if (parsed.checks){ Object.values(parsed.checks).forEach(ch=>{ if (typeof ch === 'boolean'){ total++; if (ch) valid++; } }); }
      resultSummary.classList.remove('hidden');
      resultSummary.innerHTML = '<strong>Detectado ' + (formatType || 'formato desconocido') + '. Checksums: '+valid+'/'+total+' OK</strong>';
      let html = '<div class="scroll-wrap">';
      html += '<table class="result-table"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>';
      const prettyKey = k => k.replace(/([A-Z])/g,' $1').replace(/^./, s=>s.toUpperCase()).replace('Given Names','Nombres').replace('Surname','Apellidos');
      const formatValue = (key, value)=>{ if (key==='checks' || key==='format') return ''; if ((key==='birthDate' || key==='expiryDate') && value){ return value; } if (key.endsWith('Check') && key!=='compositeCheck' && key!=='optionalCheck'){ const base = key.replace('Check',''); const ok = parsed.checks && parsed.checks[base]; return '<span class="'+(ok?'ok':'fail')+'">'+(ok?'‚úî v√°lido':'‚úñ fall√≥')+'</span>'; } return value || ''; };
      Object.entries(parsed).forEach(([k,v])=>{ if (k==='checks' || k==='format') return; const fv = formatValue(k,v); if (fv==='') return; html += `<tr><td><strong>${prettyKey(k)}</strong></td><td>${fv}</td></tr>`; });
      if (parsed.compositeCheck){ const ok = parsed.checks && parsed.checks.composite; html += `<tr><td><strong>Composite Check</strong></td><td><span class="${ok?'ok':'fail'}">${ok?'‚úî v√°lido':'‚úñ fall√≥'}</span></td></tr>`; }
      html += '</tbody></table></div>';
      resultTable.innerHTML = html;
    }

    function resetResults(){
      pdf417Error.classList.add('hidden'); pdf417Error.textContent = '';
      mrzError.classList.add('hidden'); mrzError.textContent = '';
      statusEl.classList.add('hidden');
      metaEl.classList.add('hidden'); metaEl.innerHTML = '';
      resultSummary.classList.add('hidden'); resultSummary.innerHTML = '';
      resultTable.innerHTML = '';
      pdf417Summary.classList.add('hidden'); pdf417Summary.innerHTML = '';
      pdf417Table.innerHTML = '';
      currentParsedData = null; currentDuiJSON = null; currentDuiRawText = null;
    }

    // ===== Inicial =====
    if (!('mediaDevices' in navigator)){
      camStart.disabled = true; camStop.disabled = true; camSwitch.disabled = true; camSelect.disabled = true; captureBtn.disabled = true; torchBtn.disabled = true; zoom100.disabled = zoom150.disabled = zoom250.disabled = true;
    }
  </script>
</body>
</html>
