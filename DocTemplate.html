<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF417 & MRZ – Scanner + Editor ROIs (Cámara Pro, Lupa, Crop)</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --line:#1e2a44; --txt:#e7ecf5; --muted:#9fb0cb; --accent:#2a6df5; --ok:#0f6; --warn:#bb6f00;}
    html,body{height:100%}
    body{margin:0;padding:24px;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
    h1{margin:0 0 8px;font-size:1.35rem}
    h2{margin:0 0 10px;font-size:1.1rem;color:#cfe0ff}
    .app{max-width:1320px;margin:0 auto}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:1200px){.grid{grid-template-columns:540px 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:0;background:var(--accent);color:#fff;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    button.secondary{background:#2b3b60}
    button.ghost{background:transparent;border:1px solid #2b3b60}
    button.warn{background:var(--warn)}
    select,input[type="range"],input[type="number"],input[type="text"]{background:#0f1726;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:8px 10px}
    textarea{background:#0f1726;border:1px solid var(--line);border-radius:10px;color:var(--txt);padding:10px;min-height:110px;width:100%}
    .hint{color:var(--muted);font-size:.9rem}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .result-table{width:100%;border-collapse:collapse;margin-top:8px}
    .result-table th,.result-table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .ok{color:var(--ok)} .fail{color:#f36}
    .img-stage{position:relative;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#0b1120;padding:8px;touch-action:none}
    #imagePreview{max-width:100%;max-height:720px;display:none;touch-action:none}
    #roiCanvas{position:absolute;top:0;left:0;pointer-events:auto;touch-action:none}
    .panel{background:#0f1726;border:1px solid var(--line);border-radius:12px;padding:10px}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:6px 10px}
    .json-pre{background:#0f1726;border:1px solid var(--line);border-radius:10px;padding:10px;max-height:300px;overflow:auto}
    .roi-list{max-height:240px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .roi-item{display:flex;justify-content:space-between;gap:10px;padding:8px 10px;border-bottom:1px solid var(--line);cursor:pointer}
    .roi-item.active{background:#162139;border-left:3px solid var(--accent)}
    .pill{background:#2b3b60;border-radius:999px;padding:2px 8px;font-size:.75rem}
    .prop-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    /* Cámara "a pantalla completa" del contenedor, respetando aspecto real */
    .scanner-overlay{position:relative}
    #videoWrap{
      width:100%;
      /* la altura se calcula con aspect-ratio real del stream vía style="aspect-ratio: W/H" */
      border-radius:12px;border:1px solid var(--line);background:#000;overflow:hidden;
    }
    #video{
      width:100%; height:100%;
      object-fit:contain; /* ocupa todo el ancho sin deformarse */
      display:block;
    }
    .scanner-frame{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:85%;height:60%;border:3px solid var(--ok);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.5);pointer-events:none}

    /* Lupa */
    #magnifier{position:absolute;display:none;width:200px;height:200px;border-radius:50%;border:2px solid var(--accent);overflow:hidden;pointer-events:none;box-shadow:0 0 0 3px rgba(42,109,245,.25); background:#000;}
    #magnifier canvas{position:absolute;top:0;left:0; width:100%; height:100%;}

    .range-row{display:grid;grid-template-columns:120px 1fr 60px;gap:8px;align-items:center}

    /* Crop */
    .crop-toolbar .spacer{flex:1}
    .badge{background:#243250;color:#cfe0ff;border:1px solid #335; padding:2px 8px;border-radius:999px;font-size:.75rem}
  </style>
</head>
<body>
<div class="app">
  <h1>PDF417 & MRZ – Scanner + Editor de ROIs</h1>
  <p class="hint">Cámara con aspecto real del stream, <b>lupa circular</b> nítida y <b>Crop</b> interactivo con traslado de ROIs.</p>

  <div class="grid">
    <div>
      <!-- CÁMARA -->
      <div class="card">
        <h2>1) Cámara (PDF417) – Captura Pro</h2>
        <div class="row">
          <select id="resSelect" title="Resolución">
            <option value="1280x720">1280×720 (720p)</option>
            <option value="1920x1080">1920×1080 (1080p)</option>
          </select>
          <select id="cameraSelect" title="Cámara" style="min-width:200px"></select>
          <button id="switchCamButton" class="ghost">Cambiar cámara</button>
          <button id="startButton">Iniciar Cámara</button>
          <button id="resetButton" class="secondary">Detener</button>
          <button id="capturePhotoButton" class="ghost">Capturar Foto</button>
          <button id="torchButton" class="ghost" title="Linterna">Linterna: OFF</button>
          <span id="arBadge" class="badge" style="display:none"></span>
        </div>
        <div id="camControls" class="panel" style="margin-top:10px;display:none">
          <h3 style="margin:0 0 6px">Controles del dispositivo</h3>
          <div id="camSliders" class="col"></div>
        </div>
        <div class="scanner-overlay" style="margin-top:10px;position:relative">
          <div id="videoWrap" style="aspect-ratio:16/9;">
            <video id="video" playsinline muted></video>
          </div>
          <!-- Marco más grande, sin leyenda -->
          <div class="scanner-frame"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="hint"><input type="checkbox" id="beepCheckbox" checked /> Sonido al detectar</label>
        </div>
      </div>

      <!-- IMAGEN -->
      <div class="card" style="margin-top:16px">
        <h2>2) Cargar/Capturar Imagen</h2>
        <div class="row">
          <input type="file" id="fileInput" accept="image/*" style="display:none" />
          <button id="selectImageButton" class="secondary">Seleccionar Imagen</button>
          <button id="processImageButton" class="ok" style="background:#0a6" disabled>Procesar Imagen (PDF417)</button>
          <button id="processMRZButton" class="warn" disabled>Procesar MRZ (OCR)</button>
          <button id="toggleMagnifier" class="ghost">Activar Lupa</button>
        </div>

        <!-- Mejoras -->
        <div id="enhancePanel" class="panel" style="margin-top:10px">
          <h3 style="margin:0 0 8px">3) Mejorar Imagen (pre-OCR/Decode)</h3>
          <div class="row">
            <label class="hint"><input type="checkbox" id="chkGrayscale" /> Escala de grises</label>
            <label class="hint"><input type="checkbox" id="chkBinarize" /> Binarización adaptativa</label>
            <label class="hint"><input type="checkbox" id="chkSharpen" /> Sharpen</label>
            <label class="hint"><input type="checkbox" id="chkBoost" /> Aumentar contraste</label>
          </div>
          <div class="range-row">
            <span class="hint">Intensidad</span>
            <input type="range" id="rngIntensity" min="0" max="100" value="40" />
            <span id="lblIntensity" class="hint">40</span>
          </div>
          <p class="hint" style="margin:6px 0 0">Se aplican a los <b>recortes ROI</b> y a la imagen completa cuando usas “Procesar MRZ/PDF417”.</p>
        </div>

        <div class="row crop-toolbar" style="margin-top:10px">
          <button id="btnCropActivate" class="ghost">Activar Crop</button>
          <button id="btnCropApply" class="secondary" disabled>Aplicar</button>
          <button id="btnCropCancel" class="secondary" disabled>Cancelar</button>
          <span class="spacer"></span>
          <span id="cropInfo" class="hint"></span>
        </div>

        <div id="stageWrap" class="img-stage" style="margin-top:10px;display:none">
          <img id="imagePreview" alt="Vista previa" />
          <canvas id="roiCanvas"></canvas>
          <div id="magnifier"><canvas id="magCanvas"></canvas></div>
        </div>
        <p class="hint" style="margin-top:8px">La imagen <b>permanece</b> después de extraer/parsear, hasta cargar o capturar otra.</p>
      </div>

      <!-- DUI RAW -->
      <div class="card" style="margin-top:16px">
        <h2>4) Parsear Texto Crudo (DUI)</h2>
        <p class="hint">Usa por defecto el texto crudo más reciente de PDF417; si no existe, usa el cuadro de abajo.</p>
        <textarea id="rawInput" placeholder="Pega aquí el texto crudo con separadores '||' si no proviene del PDF417."></textarea>
        <div class="row" style="margin-top:8px">
          <button id="parseRawButton">Parsear Texto Crudo (DUI)</button>
        </div>
      </div>
    </div>

    <div>
      <!-- RESULTADOS -->
      <div class="card">
        <h2>Resultados</h2>
        <div class="kv">
          <b>Estado:</b> <span id="status">Esperando…</span>
        </div>
        <div id="extractedDataTable" style="display:none;margin-top:10px">
          <table class="result-table">
            <thead><tr><th>Campo</th><th>Valor</th></tr></thead>
            <tbody id="dataTableBody"></tbody>
          </table>
        </div>
        <h3 style="margin:12px 0 6px">JSON</h3>
        <pre id="result" class="json-pre"></pre>
        <h3 style="margin:12px 0 6px">Texto Crudo</h3>
        <pre id="result2" class="json-pre"></pre>
      </div>

      <!-- ROIs -->
      <div class="card" style="margin-top:16px">
        <h2>Editor de ROIs</h2>
        <div class="panel">
          <div class="row">
            <button id="btnAddROI" class="ghost">+ Nueva ROI</button>
            <button id="btnDeleteROI" class="ghost">Eliminar ROI</button>
            <button id="btnExtractSelected" class="secondary">Extraer Seleccionada</button>
            <button id="btnExtractAll" class="ok" style="background:#0a6">Extraer Todas</button>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnExportTpl">Exportar Plantilla</button>
            <button id="btnImportTpl" class="secondary">Importar</button>
            <input type="file" id="tplFile" accept=".json" />
          </div>
          <p class="hint" style="margin-top:6px">Tipos: <b>text</b>, <b>image</b>, <b>barcode</b>, <b>pdf417</b>, <b>mrz</b>.</p>
        </div>

        <div class="panel" style="margin-top:10px">
          <h3 style="margin:0 0 6px">ROIs</h3>
          <div id="roiList" class="roi-list"></div>
        </div>

        <div class="panel" style="margin-top:10px">
          <h3 style="margin:0 0 6px">Propiedades</h3>
          <div class="prop-grid">
            <label>Nombre<br><input id="propName" type="text" /></label>
            <label>Tipo<br>
              <select id="propType">
                <option>text</option><option>image</option><option>barcode</option><option>pdf417</option><option>mrz</option>
              </select>
            </label>
            <label>X (px)<br><input id="propX" type="number" step="1" /></label>
            <label>Y (px)<br><input id="propY" type="number" step="1" /></label>
            <label>Ancho (px)<br><input id="propW" type="number" step="1" /></label>
            <label>Alto (px)<br><input id="propH" type="number" step="1" /></label>
          </div>
          <div class="row" style="margin-top:8px"><button id="btnApplyProps" class="secondary">Aplicar</button></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ZXing + Tesseract -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script>
/* ==========================
   Utilidades UI
========================== */
const $ = sel => document.querySelector(sel);
function beep() {
  const cb = $('#beepCheckbox'); if (!cb || !cb.checked) return;
  try{ const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880;
    o.connect(g); g.connect(ctx.destination); g.gain.value=.25; o.start(); setTimeout(()=>{o.stop();ctx.close();},250);
  }catch{}
}
function setStatus(msg, cls='') {
  const el = $('#status'); el.textContent = msg; el.className = cls;
}

/* ==========================
   Estado global
========================== */
let codeReader = new ZXing.BrowserMultiFormatReader();
let selectedDeviceId = null;
let isScanning = false;
let lastPDF417Raw = "";
let track = null; // MediaStreamTrack
let stream = null;

const video = $('#video');
const videoWrap = $('#videoWrap');
const imgEl = $('#imagePreview');
const stageWrap = $('#stageWrap');
const canvas = $('#roiCanvas');
const ctx = canvas.getContext('2d');
let scaleX=1, scaleY=1;

const IS_TOUCH = ('ontouchstart' in window) || (navigator.maxTouchPoints>0);
const HANDLE_SIZE = IS_TOUCH ? 18 : 8;

/* ==========================
   Mejoras (pre-procesado)
========================== */
const enhance = { grayscale:false, binarize:false, sharpen:false, boost:false, intensity:40 };
$('#chkGrayscale').addEventListener('change', e=> enhance.grayscale = e.target.checked);
$('#chkBinarize').addEventListener('change', e=> enhance.binarize = e.target.checked);
$('#chkSharpen').addEventListener('change', e=> enhance.sharpen = e.target.checked);
$('#chkBoost').addEventListener('change', e=> enhance.boost = e.target.checked);
$('#rngIntensity').addEventListener('input', e=> { enhance.intensity = +e.target.value; $('#lblIntensity').textContent = e.target.value; });

function applyEnhancementsToCanvas(cnv){
  if(!(enhance.grayscale||enhance.binarize||enhance.sharpen||enhance.boost)) return cnv;
  const w=cnv.width,h=cnv.height; const cx=cnv.getContext('2d');
  let img = cx.getImageData(0,0,w,h); let d=img.data;

  if (enhance.grayscale || enhance.binarize) {
    for(let i=0;i<d.length;i+=4){ const y=0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; d[i]=d[i+1]=d[i+2]=y; }
  }
  if (enhance.boost) {
    const k = 1 + (enhance.intensity/100)*1.25;
    for(let i=0;i<d.length;i+=4){
      d[i]=Math.max(0,Math.min(255,(d[i]-128)*k+128));
      d[i+1]=Math.max(0,Math.min(255,(d[i+1]-128)*k+128));
      d[i+2]=Math.max(0,Math.min(255,(d[i+2]-128)*k+128));
    }
  }
  if (enhance.binarize) {
    let sum=0; for(let i=0;i<d.length;i+=4) sum+=d[i];
    const avg = sum/(d.length/4);
    const k = 0.2 + (enhance.intensity/100)*0.6;
    const thr = avg*(0.9 + k*0.2);
    for(let i=0;i<d.length;i+=4){ const v=d[i]>=thr?255:0; d[i]=d[i+1]=d[i+2]=v; }
  }
  cx.putImageData(img,0,0);

  if (enhance.sharpen) {
    const k = 0.5 + (enhance.intensity/100)*1.5;
    const tmp = document.createElement('canvas'); tmp.width=w; tmp.height=h;
    const tx = tmp.getContext('2d'); tx.drawImage(cnv,0,0);
    const src = tx.getImageData(0,0,w,h); const sd=src.data;
    const out = cx.getImageData(0,0,w,h); const od=out.data;
    const idx = (x,y)=> (y*w+x)*4;
    for(let y=1;y<h-1;y++){
      for(let x=1;x<w-1;x++){
        for(let ch=0; ch<3; ch++){
          const p = idx(x,y)+ch;
          const v = 8*sd[p]
            - sd[idx(x-1,y-1)+ch]-sd[idx(x,y-1)+ch]-sd[idx(x+1,y-1)+ch]
            - sd[idx(x-1,y)+ch]    -sd[idx(x+1,y)+ch]
            - sd[idx(x-1,y+1)+ch]-sd[idx(x,y+1)+ch]-sd[idx(x+1,y+1)+ch];
          od[p] = Math.max(0, Math.min(255, sd[p] + k*v/8 ));
        }
        od[idx(x,y)+3]=255;
      }
    }
    cx.putImageData(out,0,0);
  }
  return cnv;
}

/* ==========================
   Cámara + aspecto real del stream
========================== */
async function enumerateCameras(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    const sel = $('#cameraSelect'); sel.innerHTML='';
    vids.forEach((d,i)=>{
      const o=document.createElement('option');
      o.value=d.deviceId; o.textContent=d.label || `Cámara ${i+1}`;
      sel.appendChild(o);
    });
    if (!selectedDeviceId && vids[0]) selectedDeviceId = vids[0].deviceId;
    if (selectedDeviceId) sel.value = selectedDeviceId;
  }catch(e){ /* puede requerir permiso previo */ }
}

async function startCamera(){
  if (isScanning) { setStatus("La cámara ya está activa."); return; }
  try{
    const [w,h] = ($('#resSelect').value||'1280x720').split('x').map(Number);
    const camId = $('#cameraSelect').value || selectedDeviceId || undefined;

    const constraints = {
      video: camId ? { deviceId:{ exact: camId }, width:{ ideal:w }, height:{ ideal:h } }
                   : { width:{ ideal:w }, height:{ ideal:h }, facingMode:{ ideal:'environment' } },
      audio:false
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream; await video.play();
    isScanning = true; setStatus(`Cámara iniciada (${w}×${h}).`);
    await enumerateCameras();
    selectedDeviceId = stream.getVideoTracks()[0]?.getSettings?.().deviceId || selectedDeviceId;

    track = stream.getVideoTracks()[0];
    setupCameraControls(track);

    // Ajustar aspect-ratio real del stream cuando conozcamos dimensiones
    const applyAspect = ()=>{
      const vw = video.videoWidth || w, vh = video.videoHeight || h;
      if (vw && vh){
        videoWrap.style.aspectRatio = `${vw} / ${vh}`; // CSS aspect-ratio
        const arBadge = $('#arBadge'); arBadge.style.display='inline-block'; arBadge.textContent = `AR ${vw}:${vh}`;
      }
    };
    if (video.readyState >= 2) applyAspect();
    video.addEventListener('loadedmetadata', applyAspect, { once:true });

    // Decodificar en vivo PDF417
    codeReader.decodeFromVideoElementContinuously(video, (result, err) => {
      if (result) {
        lastPDF417Raw = result.text || "";
        $('#result2').textContent = lastPDF417Raw;
        if (lastPDF417Raw.includes("||")) {
          const parsed = parseRawDUI(lastPDF417Raw);
          $('#result').textContent = JSON.stringify(parsed,null,2);
          tableOut(parsed); setStatus("DUI (PDF417 cámara) parseado.", "ok"); beep(); return;
        }
        if (result.format === 10){
          const parsed = parseUSDL(result.text);
          $('#result').textContent = JSON.stringify(parsed,null,2);
          tableOut(parsed); setStatus("PDF417 detectado (cámara).", "ok"); beep();
        }
      } else if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error(err); setStatus("Error cámara: "+err.message,'fail');
      }
    });
  }catch(e){
    console.error(e); setStatus("No se pudo iniciar la cámara: "+e.message,'fail');
  }
}
function resetCamera(){
  try{
    codeReader.reset();
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; }
    isScanning=false; setStatus("Cámara detenida.");
    $('#camControls').style.display='none';
  }catch(e){/* noop */}
}
$('#startButton').addEventListener('click', startCamera);
$('#resetButton').addEventListener('click', resetCamera);
$('#capturePhotoButton').addEventListener('click', capturePhotoFromCamera);

// Cambiar cámara (ciclo)
$('#switchCamButton').addEventListener('click', async ()=>{
  try{
    const sel = $('#cameraSelect');
    if (!sel.options.length){ await enumerateCameras(); }
    if (!sel.options.length){ setStatus('No se encontraron cámaras.','fail'); return; }
    const idx = sel.selectedIndex >= 0 ? sel.selectedIndex : 0;
    const next = (idx + 1) % sel.options.length;
    selectedDeviceId = sel.options[next].value;
    sel.selectedIndex = next;
    if (isScanning) { resetCamera(); }
    await startCamera();
    setStatus('Cámara cambiada.','ok');
  }catch(e){ setStatus('No se pudo cambiar de cámara: '+e.message,'fail'); }
});
if (navigator.mediaDevices?.enumerateDevices) enumerateCameras();

/* Controles de cámara (zoom/torch/exposición...) */
function setupCameraControls(track){
  const cap = track.getCapabilities?.(); if (!cap) return;
  const sliders = $('#camSliders'); sliders.innerHTML='';
  $('#camControls').style.display='block';

  function addSlider(name, prop, min, max, step=1, valInit){
    const row = document.createElement('div'); row.className='range-row';
    const label = document.createElement('span'); label.className='hint'; label.textContent = name;
    const input = document.createElement('input'); input.type='range'; input.min=min; input.max=max; input.step=step; input.value = valInit ?? (min+max)/2;
    const out = document.createElement('span'); out.className='hint'; out.textContent = input.value;
    input.addEventListener('input', async ()=>{
      out.textContent = input.value;
      try{ await track.applyConstraints({ advanced:[{ [prop]: Number(input.value) }] }); }catch(e){ /*ignore*/ }
    });
    row.appendChild(label); row.appendChild(input); row.appendChild(out); sliders.appendChild(row);
  }
  // Torch
  const torchBtn = $('#torchButton');
  let torchOn = false;
  torchBtn.onclick = async ()=>{
    if (!cap.torch){ setStatus("Torch no soportado por este dispositivo.","fail"); return; }
    try{
      torchOn = !torchOn;
      await track.applyConstraints({ advanced:[{ torch: torchOn }] });
      torchBtn.textContent = `Linterna: ${torchOn?'ON':'OFF'}`;
      setStatus(torchOn?"Linterna encendida.":"Linterna apagada.");
    }catch(e){ setStatus("No se pudo cambiar la linterna: "+e.message,'fail'); }
  };

  if (cap.zoom) addSlider('Zoom','zoom',cap.zoom.min, cap.zoom.max, cap.zoom.step||0.1, track.getSettings?.().zoom ?? cap.zoom.min);
  if (cap.exposureCompensation) addSlider('Exposición','exposureCompensation', cap.exposureCompensation.min, cap.exposureCompensation.max, cap.exposureCompensation.step||0.1, track.getSettings?.().exposureCompensation ?? 0);
  if (cap.brightness) addSlider('Brillo','brightness', cap.brightness.min, cap.brightness.max, cap.brightness.step||1, track.getSettings?.().brightness ?? 0);
  if (cap.contrast) addSlider('Contraste','contrast', cap.contrast.min, cap.contrast.max, cap.contrast.step||1, track.getSettings?.().contrast ?? 0);
  if (cap.whiteBalanceMode && cap.whiteBalanceMode.length){
    track.applyConstraints({ advanced:[{ whiteBalanceMode:'continuous' }] }).catch(()=>{});
  }
}

/* ==========================
   Imagen: cargar + persistir
========================== */
$('#selectImageButton').addEventListener('click', ()=> $('#fileInput').click());
$('#fileInput').addEventListener('change', e=>{
  const f = e.target.files?.[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = async ev => { await loadImageToStage(ev.target.result, false); };
  fr.readAsDataURL(f);
});

async function loadImageToStage(dataURL){
  imgEl.src = dataURL;
  await new Promise(res=> imgEl.onload = res);
  stageWrap.style.display='block';
  imgEl.style.display='block';
  canvas.width = imgEl.clientWidth; canvas.height = imgEl.clientHeight;
  canvas.style.width = imgEl.clientWidth+'px'; canvas.style.height = imgEl.clientHeight+'px';
  canvas.style.left = imgEl.offsetLeft+'px'; canvas.style.top = imgEl.offsetTop+'px';
  scaleX = imgEl.naturalWidth / imgEl.clientWidth;
  scaleY = imgEl.naturalHeight / imgEl.clientHeight;
  $('#processImageButton').disabled=false;
  $('#processMRZButton').disabled=false;
  configureMagnifierCanvas();
  drawCanvas();
}

/* ==========================
   Lupa circular (nítida y robusta)
========================== */
const mag = $('#magnifier'), magCanvas = $('#magCanvas'), mgx = magCanvas.getContext('2d');
let magOn = false, magZoom = 2.0;
function configureMagnifierCanvas(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const cssSize = 200; // px
  mag.style.width = cssSize+'px'; mag.style.height = cssSize+'px';
  magCanvas.width = Math.round(cssSize * dpr);
  magCanvas.height = Math.round(cssSize * dpr);
}
$('#toggleMagnifier').addEventListener('click', ()=>{
  magOn = !magOn;
  mag.style.display = magOn ? 'block' : 'none';
  $('#toggleMagnifier').textContent = magOn ? 'Desactivar Lupa' : 'Activar Lupa';
});
function updateMagnifier(clientX, clientY){
  if (!magOn || !imgEl.src) return;
  const rect = stageWrap.getBoundingClientRect();
  const x = clientX - rect.left, y = clientY - rect.top;

  mag.style.left = (x - mag.clientWidth/2) + 'px';
  mag.style.top  = (y - mag.clientHeight/2) + 'px';

  const r = magCanvas.width/2;
  mgx.clearRect(0,0,magCanvas.width,magCanvas.height);
  mgx.save();
  mgx.beginPath(); mgx.arc(r,r,r,0,Math.PI*2); mgx.clip();

  // calcular fuente en naturales
  const srcW = (magCanvas.width / magZoom) * scaleX;
  const srcH = (magCanvas.height / magZoom) * scaleY;
  const srcX = (x*scaleX) - srcW/2;
  const srcY = (y*scaleY) - srcH/2;

  // dibujar llenando el círculo
  mgx.imageSmoothingEnabled = true;
  mgx.drawImage(imgEl, srcX, srcY, srcW, srcH, 0, 0, magCanvas.width, magCanvas.height);
  mgx.restore();
}
stageWrap.addEventListener('mousemove', e=> updateMagnifier(e.clientX, e.clientY));
stageWrap.addEventListener('wheel', e=>{ if(!magOn) return; e.preventDefault(); magZoom = Math.max(1, Math.min(8, magZoom + (e.deltaY<0?0.2:-0.2))); updateMagnifier(e.clientX,e.clientY); }, {passive:false});
stageWrap.addEventListener('touchmove', e=>{
  if (!magOn) return;
  if (e.touches.length===2){
    const dx = e.touches[1].clientX - e.touches[0].clientX;
    const dy = e.touches[1].clientY - e.touches[0].clientY;
    const dist = Math.hypot(dx,dy);
    magZoom = Math.max(1, Math.min(8, dist/80));
    updateMagnifier(e.touches[0].clientX, e.touches[0].clientY);
    e.preventDefault();
  } else if (e.touches.length===1){
    updateMagnifier(e.touches[0].clientX, e.touches[0].clientY);
  }
}, {passive:false});

/* ==========================
   Parser / DUI / MRZ
========================== */
function tableOut(obj){
  const tbody = $('#dataTableBody'); tbody.innerHTML='';
  Object.entries(obj||{}).forEach(([k,v])=>{
    const tr=document.createElement('tr'); const td1=document.createElement('td'), td2=document.createElement('td');
    td1.textContent=k; td2.textContent = (v??''); tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
  });
  $('#extractedDataTable').style.display='block';
}
function parseUSDL(str){
  const CodeToKey = {
    DCA:"jurisdictionVehicleClass", DCB:"jurisdictionRestrictionCodes", DCD:"jurisdictionEndorsementCodes",
    DBA:"dateOfExpiry", DCS:"lastName", DAC:"firstName", DAD:"middleName", DBD:"dateOfIssue", DBB:"dateOfBirth",
    DBC:"sex", DAY:"eyeColor", DAU:"height", DAG:"addressStreet", DAI:"addressCity", DAJ:"addressState",
    DAK:"addressPostalCode", DAQ:"documentNumber", DCF:"documentDiscriminator", DCG:"issuer"
  };
  const props={};
  const lines = str.trim().split('\n').map(l => l.replace(/[^\t\n\r -~]/g, '').trim());
  let started=false;
  lines.forEach(line=>{
    if(!started){ if(line.startsWith('ANSI ')) started=true; return; }
    const code=line.slice(0,3), value=line.slice(3), key=CodeToKey[code];
    if(!key) return; let v=value;
    if(code==='DBC') v=(value==='1'?'M':'F');
    if(key.startsWith('date') && /^\d{8}$/.test(value)) v=`${value.slice(4)}-${value.slice(0,2)}-${value.slice(2,4)}`;
    props[key]=v;
  }); return props;
}
const DUI_FIELDS=["Número de DUI","Primer Apellido","Segundo Apellido y Nombres","Número de Emisión","Firma Digital","Lugar de Nacimiento","Municipio","Profesión u Oficio","Sexo","Fecha de Nacimiento","Fecha de Emisión","Código de Zona","Categoría","Estdo Familiar","Nacionalidad","Segunda Firma Digital","Código de Verificación"];
function parseRawDUI(raw){ const parts=(raw||'').trim().replace(/\r/g,'').split('||').map(s=>s.trim()); const out={}; DUI_FIELDS.forEach((l,i)=> out[l]=parts[i]??""); return out; }
function mrzCheckDigit(data){const w=[7,3,1];const map=c=>c==='<'?0:(c>='0'&&c<='9')?c.charCodeAt(0)-48:(c>='A'&&c<='Z')?c.charCodeAt(0)-55:0;let s=0;for(let i=0;i<data.length;i++)s+=map(data[i])*w[i%3];return String(s%10);}
function normalizeMRZLines(text){
  const clean=text.toUpperCase().replace(/[^\nA-Z0-9<]/g,'').split(/\n+/).map(l=>l.replace(/ /g,'').trim()).filter(l=>l.length>=24);
  const cand=[];
  for(let i=0;i<clean.length;i++){
    const L=clean[i];
    if(L.length>=40 && i+1<clean.length){ if(clean[i+1].length>=40) cand.push({typeGuess:'TD3',lines:[L.padEnd(44,'<').slice(0,44),clean[i+1].padEnd(44,'<').slice(0,44)]});}
    if(L.length>=32 && i+1<clean.length){ if(clean[i+1].length>=32) cand.push({typeGuess:'TD2',lines:[L.padEnd(36,'<').slice(0,36),clean[i+1].padEnd(36,'<').slice(0,36)]});}
    if(L.length>=26 && i+2<clean.length){
      const a=clean[i+1],b=clean[i+2];
      if(a && b && a.length>=26 && b.length>=26) cand.push({typeGuess:'TD1',lines:[L.padEnd(30,'<').slice(0,30),a.padEnd(30,'<').slice(0,30),b.padEnd(30,'<').slice(0,30)]});
    }
  }
  cand.sort((A,B)=> ((B.lines.join('').match(/</g)||[]).length) - ((A.lines.join('').match(/</g)||[]).length));
  return cand[0]||null;
}
function parseTD3(L){const A=L[0],B=L[1];const t=A.slice(0,2).replace(/</g,''), c=A.slice(2,5).replace(/</g,''); const np=A.slice(5).split('<<'); const s=np[0].replace(/</g,''), g=(np[1]||'').replace(/</g,' ').trim(); const dn=B.slice(0,9), dnc=B[9]; const nat=B.slice(10,13).replace(/</g,''), bd=B.slice(13,19), bdc=B[19], sx=B[20], ex=B.slice(21,27), exc=B[27], opt=B.slice(28,42), comp=B[43]; return {mrzType:'TD3',documentType:t,issuingCountry:c,surname:s,givenNames:g,documentNumber:dn.replace(/</g,''),documentNumberCheck:mrzCheckDigit(dn)===dnc,nationality:nat,birthDate:bd,birthDateCheck:mrzCheckDigit(bd)===bdc,sex:sx,expiryDate:ex,expiryDateCheck:mrzCheckDigit(ex)===exc,optional:opt.replace(/</g,''),compositeCheck:mrzCheckDigit(dn+dnc+bd+bdc+ex+exc+opt)===comp};}
function parseTD2(L){const A=L[0],B=L[1];const t=A.slice(0,2).replace(/</g,''), c=A.slice(2,5).replace(/</g,''); const np=A.slice(5).split('<<'); const s=np[0].replace(/</g,''), g=(np[1]||'').replace(/</g,' ').trim(); const dn=B.slice(0,9), dnc=B[9]; const nat=B.slice(10,13).replace(/</g,''), bd=B.slice(13,19), bdc=B[19], sx=B[20], ex=B.slice(21,27), exc=B[27], opt=B.slice(28,35), comp=B[35]; return {mrzType:'TD2',documentType:t,issuingCountry:c,surname:s,givenNames:g,documentNumber:dn.replace(/</g,''),documentNumberCheck:mrzCheckDigit(dn)===dnc,nationality:nat,birthDate:bd,birthDateCheck:mrzCheckDigit(bd)===bdc,sex:sx,expiryDate:ex,expiryDateCheck:mrzCheckDigit(ex)===exc,optional:opt.replace(/</g,''),compositeCheck:mrzCheckDigit(dn+dnc+bd+bdc+ex+exc+opt)===comp};}
function parseTD1(L){const A=L[0],B=L[1],C=L[2];const t=A.slice(0,2).replace(/</g,''), c=A.slice(2,5).replace(/</g,''); const dn=A.slice(5,14), dnc=A[14], opt1=A.slice(15,30); const bd=B.slice(0,6), bdc=B[6], sx=B[7], ex=B.slice(8,14), exc=B[14], nat=B.slice(15,18).replace(/</g,''), opt2=B.slice(18,29), comp=B[29]; const np=C.split('<<'); const s=np[0].replace(/</g,''), g=(np[1]||'').replace(/</g,' ').trim(); return {mrzType:'TD1',documentType:t,issuingCountry:c,documentNumber:dn.replace(/</g,''),documentNumberCheck:mrzCheckDigit(dn)===dnc,birthDate:bd,birthDateCheck:mrzCheckDigit(bd)===bdc,sex:sx,expiryDate:ex,expiryDateCheck:mrzCheckDigit(ex)===exc,nationality:nat,optional:(opt1+opt2).replace(/</g,''),surname:s,givenNames:g,compositeCheck:mrzCheckDigit(dn+dnc+bd+bdc+ex+exc+opt1+opt2)===comp};}
function parseMRZ(o){if(!o) return {error:'No MRZ'}; const L=o.lines; if(L.length===2 && L[0].length===44) return parseTD3(L); if(L.length===2 && L[0].length===36) return parseTD2(L); if(L.length===3 && L[0].length===30) return parseTD1(L); return {error:'Formato no reconocido'};}

/* ==========================
   Procesar imagen completa con mejoras
========================== */
function drawImageToCanvasWithEnhancements(img){
  const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight;
  const cctx = c.getContext('2d'); cctx.drawImage(img,0,0);
  return applyEnhancementsToCanvas(c);
}
function cropROIToCanvas(roi){
  const sx = Math.round(roi.x*scaleX), sy=Math.round(roi.y*scaleY);
  const sw = Math.max(1, Math.round(roi.w*scaleX)), sh=Math.max(1, Math.round(roi.h*scaleY));
  const c = document.createElement('canvas'); c.width=sw; c.height=sh;
  const cctx = c.getContext('2d'); cctx.imageSmoothingEnabled=true; cctx.drawImage(imgEl, sx, sy, sw, sh, 0,0,sw,sh);
  return applyEnhancementsToCanvas(c);
}

/* ==========================
   Procesar PDF417 / MRZ desde imagen
========================== */
$('#processImageButton').addEventListener('click', ()=>{
  if (!imgEl.src) { setStatus('Carga/captura una imagen primero.','fail'); return; }
  setStatus('Procesando imagen (PDF417)…');
  const procCanvas = drawImageToCanvasWithEnhancements(imgEl);
  const tmpImg = new Image();
  tmpImg.onload=()=>{
    codeReader.decodeFromImageElement(tmpImg).then(result=>{
      lastPDF417Raw = result?.text || "";
      $('#result2').textContent = lastPDF417Raw;
      if (lastPDF417Raw.includes('||')){
        const parsed = parseRawDUI(lastPDF417Raw);
        $('#result').textContent = JSON.stringify(parsed,null,2); tableOut(parsed);
        setStatus('DUI (PDF417 imagen) parseado.','ok'); beep(); return;
      }
      if (result && result.format===10){
        const parsed = parseUSDL(result.text);
        $('#result').textContent = JSON.stringify(parsed,null,2); tableOut(parsed);
        setStatus('PDF417 detectado en imagen.','ok'); beep();
      } else {
        setStatus('No se detectó PDF417.','fail'); $('#extractedDataTable').style.display='none';
      }
    }).catch(err=>{ console.error(err); setStatus('Error: '+err.message,'fail'); });
  };
  tmpImg.src = procCanvas.toDataURL('image/png');
});
$('#processMRZButton').addEventListener('click', async ()=>{
  if (!imgEl.src) { setStatus('Carga/captura una imagen primero.','fail'); return; }
  setStatus('OCR MRZ en imagen…');
  try{
    const procCanvas = drawImageToCanvasWithEnhancements(imgEl);
    const { data } = await Tesseract.recognize(procCanvas, 'eng', { tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<', preserve_interword_spaces:'1' });
    const raw=(data.text||'').toUpperCase().replace(/[^\nA-Z0-9< ]/g,'');
    $('#result2').textContent = raw;
    const linesObj = normalizeMRZLines(raw);
    if (!linesObj){ setStatus('No se detectó MRZ.','fail'); $('#result').textContent=''; $('#extractedDataTable').style.display='none'; return; }
    const parsed = parseMRZ(linesObj);
    if (parsed.error){ setStatus('MRZ detectado, pero no se pudo parsear.','fail'); $('#result').textContent = JSON.stringify({mrzLines:linesObj.lines},null,2); $('#extractedDataTable').style.display='none'; return; }
    $('#result').textContent = JSON.stringify({mrzLines:linesObj.lines, parsed},null,2);
    tableOut(parsed); setStatus(`MRZ (${parsed.mrzType}) extraído y parseado.`,'ok'); beep();
  }catch(e){ console.error(e); setStatus('Error OCR MRZ: '+e.message,'fail'); }
});

/* ==========================
   DUI - botón
========================== */
$('#parseRawButton').addEventListener('click', ()=>{
  const src = (lastPDF417Raw && lastPDF417Raw.trim()) ? lastPDF417Raw : $('#rawInput').value;
  if (!src || !src.trim()) { setStatus('No hay texto crudo disponible.','fail'); return; }
  const parsed = parseRawDUI(src);
  $('#result').textContent = JSON.stringify(parsed,null,2);
  $('#result2').textContent = src;
  tableOut(parsed); setStatus('Texto crudo DUI parseado.','ok'); beep();
});

/* ==========================
   ROI Editor (táctil)
========================== */
const ROIs=[]; let activeROIId=null; let roiCounter=1;
function drawCanvas(){
  if (!imgEl.src) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
  canvas.width=imgEl.clientWidth; canvas.height=imgEl.clientHeight;
  scaleX = imgEl.naturalWidth/imgEl.clientWidth; scaleY = imgEl.naturalHeight/imgEl.clientHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Fondo semitransparente (si crop activo, se maneja aparte)
  if (!cropState.active){
    ctx.save(); ctx.fillStyle="rgba(0,0,0,.12)"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore();
  }

  // ROIs
  ROIs.forEach(r=>{
    const active=r.id===activeROIId;
    ctx.save();
    ctx.strokeStyle=active? '#2a6df5':'#0f6'; ctx.lineWidth=active?2.5:2;
    ctx.fillStyle='rgba(42,109,245,.10)';
    ctx.beginPath(); ctx.rect(r.x,r.y,r.w,r.h); ctx.fill(); ctx.stroke();
    const hs=getHandles(r); ctx.fillStyle=active?'#2a6df5':'#0f6';
    hs.forEach(h=> ctx.fillRect(h.x-HANDLE_SIZE/2,h.y-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE));
    ctx.fillStyle='#e7ecf5'; ctx.font='12px ui-monospace,monospace';
    ctx.fillText(`${r.name} [${r.type}]`, r.x+6, Math.max(12, r.y-6));
    ctx.restore();
  });

  // Dibujo del Crop si activo
  if (cropState.active){
    drawCropOverlay();
  }
}
function getHandles(r){
  const {x,y,w,h}=r;
  return [
    {x:x,y:y,pos:'nw'},{x:x+w/2,y:y,pos:'n'},{x:x+w,y:y,pos:'ne'},
    {x:x,y:y+h/2,pos:'w'},{x:x+w,y:y+h/2,pos:'e'},
    {x:x,y:y+h,pos:'sw'},{x:x+w/2,y:y+h,pos:'s'},{x:x+w,y:y+h,pos:'se'}
  ];
}
function ptIn(px,py,x,y,w,h){ return px>=x && py>=y && px<=x+w && py<=y+h; }
function hitHandle(r, mx,my){ return getHandles(r).find(h=> ptIn(mx,my,h.x-HANDLE_SIZE/2,h.y-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE))?.pos||null; }

function addROI(){
  if(!imgEl.src){ setStatus('Carga/captura una imagen para crear ROIs.','fail'); return; }
  const w=Math.max(40, Math.floor(canvas.width*0.25));
  const h=Math.max(40, Math.floor(canvas.height*0.18));
  const roi={ id:'roi_'+(roiCounter++), name:'roi_'+(roiCounter-1), type:'text', x:Math.floor((canvas.width-w)/2), y:Math.floor((canvas.height-h)/2), w, h };
  ROIs.push(roi); activeROIId=roi.id; refreshROIList(); drawCanvas(); fillProp(roi);
}
function delROI(){
  if(!activeROIId) return;
  const i=ROIs.findIndex(r=>r.id===activeROIId); if(i>=0) ROIs.splice(i,1);
  activeROIId = ROIs[0]?.id || null; refreshROIList(); drawCanvas(); if(activeROIId) fillProp(getActive()); else clearProp();
}
function getActive(){ return ROIs.find(r=>r.id===activeROIId)||null; }
function refreshROIList(){
  const list=$('#roiList'); list.innerHTML='';
  ROIs.forEach(r=>{
    const div=document.createElement('div'); div.className='roi-item'+(r.id===activeROIId?' active':'');
    div.innerHTML=`<div><b>${r.name}</b> <span class="pill">${r.type}</span></div><div class="hint">(${r.x},${r.y}) ${r.w}×${r.h}</div>`;
    div.onclick=()=>{ activeROIId=r.id; refreshROIList(); drawCanvas(); fillProp(r); };
    list.appendChild(div);
  });
}
function fillProp(r){
  $('#propName').value=r.name; $('#propType').value=r.type;
  $('#propX').value=Math.round(r.x); $('#propY').value=Math.round(r.y);
  $('#propW').value=Math.round(r.w); $('#propH').value=Math.round(r.h);
}
function clearProp(){ ['propName','propType','propX','propY','propW','propH'].forEach(id=> $('#'+id).value=''); }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function applyProps(){
  const r=getActive(); if(!r) return;
  r.name=($('#propName').value||r.id).trim(); r.type=$('#propType').value;
  r.x=clamp(parseInt($('#propX').value||r.x,10),0,canvas.width-1);
  r.y=clamp(parseInt($('#propY').value||r.y,10),0,canvas.height-1);
  r.w=clamp(parseInt($('#propW').value||r.w,10),10,canvas.width-r.x);
  r.h=clamp(parseInt($('#propH').value||r.h,10),10,canvas.height-r.y);
  refreshROIList(); drawCanvas();
}
$('#btnAddROI').addEventListener('click', addROI);
$('#btnDeleteROI').addEventListener('click', delROI);
$('#btnApplyProps').addEventListener('click', applyProps);

let dragState = { mode:null, startX:0, startY:0, startRect:null, handle:null };
let pinchState = null;
function canvasToLocal(clientX,clientY){ const r=canvas.getBoundingClientRect(); return {x:clientX-r.left, y:clientY-r.top}; }

canvas.addEventListener('mousedown', e=>{ const p=canvasToLocal(e.clientX,e.clientY); startInteract(p.x,p.y); });
window.addEventListener('mousemove', e=>{ if(!dragState.mode && !pinchState) return; const p=canvasToLocal(e.clientX,e.clientY); moveInteract(p.x,p.y); });
window.addEventListener('mouseup', ()=> endInteract());
canvas.addEventListener('touchstart', e=>{
  if (e.touches.length===1){
    const t=e.touches[0]; const p=canvasToLocal(t.clientX,t.clientY); startInteract(p.x,p.y); e.preventDefault();
  } else if (e.touches.length===2){
    const t1=e.touches[0], t2=e.touches[1];
    const p1=canvasToLocal(t1.clientX,t1.clientY), p2=canvasToLocal(t2.clientX,t2.clientY);
    const dist=Math.hypot(p2.x-p1.x,p2.y-p1.y); const roi=getActive(); if(!roi) return;
    pinchState={ startDist:dist, startRect:{...roi}, centerX:(p1.x+p2.x)/2, centerY:(p1.y+p2.y)/2 };
    dragState.mode=null; e.preventDefault();
  }
},{passive:false});
canvas.addEventListener('touchmove', e=>{
  if(e.touches.length===1 && dragState.mode){
    const t=e.touches[0]; const p=canvasToLocal(t.clientX,t.clientY); moveInteract(p.x,p.y); e.preventDefault();
  } else if(e.touches.length===2 && pinchState){
    const t1=e.touches[0], t2=e.touches[1];
    const p1=canvasToLocal(t1.clientX,t1.clientY), p2=canvasToLocal(t2.clientX,t2.clientY);
    const scale=Math.max(0.2, Math.min(5, Math.hypot(p2.x-p1.x,p2.y-p1.y)/(pinchState.startDist||1)));
    const roi=getActive(); if(!roi) return; const s=pinchState.startRect;
    let nw=clamp(s.w*scale,10,canvas.width), nh=clamp(s.h*scale,10,canvas.height);
    let nx=pinchState.centerX - (pinchState.centerX - s.x)*scale;
    let ny=pinchState.centerY - (pinchState.centerY - s.y)*scale;
    nx=clamp(nx,0,canvas.width-nw); ny=clamp(ny,0,canvas.height-nh);
    roi.x=Math.round(nx); roi.y=Math.round(ny); roi.w=Math.round(nw); roi.h=Math.round(nh);
    fillProp(roi); drawCanvas(); e.preventDefault();
  }
},{passive:false});
canvas.addEventListener('touchend', (e)=>{ if(pinchState && (!e.touches || e.touches.length===0)) pinchState=null; endInteract(); }, {passive:false});

function startInteract(x,y){
  if (cropState.active){ startCropInteract(x,y); return; }

  for(let i=ROIs.length-1;i>=0;i--){
    const r=ROIs[i]; const h=hitHandle(r,x,y);
    if(h){ activeROIId=r.id; refreshROIList(); fillProp(r);
      dragState={mode:'resize',startX:x,startY:y,startRect:{...r},handle:h}; drawCanvas(); return; }
  }
  for(let i=ROIs.length-1;i>=0;i--){
    const r=ROIs[i]; if(ptIn(x,y,r.x,r.y,r.w,r.h)){ activeROIId=r.id; refreshROIList(); fillProp(r);
      dragState={mode:'move',startX:x,startY:y,startRect:{...r},handle:null}; drawCanvas(); return; }
  }
  activeROIId=null; refreshROIList(); clearProp(); drawCanvas();
}
function moveInteract(x,y){
  if (cropState.active){ moveCropInteract(x,y); return; }

  const r=getActive(); if(!r || !dragState.mode) return;
  const dx=x-dragState.startX, dy=y-dragState.startY;
  if(dragState.mode==='move'){
    r.x=clamp(dragState.startRect.x+dx,0,canvas.width-r.w);
    r.y=clamp(dragState.startRect.y+dy,0,canvas.height-r.h);
  } else if(dragState.mode==='resize'){
    let {x:sx,y:sy,w:sw,h:sh}=dragState.startRect; let nx=sx,ny=sy,nw=sw,nh=sh; const h=dragState.handle;
    if(h.includes('n')){ ny=clamp(sy+dy,0,sy+sh-10); nh=sh-(ny-sy); }
    if(h.includes('s')){ nh=clamp(sh+dy,10,canvas.height-sy); }
    if(h.includes('w')){ nx=clamp(sx+dx,0,sx+sw-10); nw=sw-(nx-sx); }
    if(h.includes('e')){ nw=clamp(sw+dx,10,canvas.width-sx); }
    r.x=nx; r.y=ny; r.w=nw; r.h=nh;
  }
  fillProp(r); drawCanvas();
}
function endInteract(){ dragState={mode:null,startX:0,startY:0,startRect:null,handle:null}; }

/* ==========================
   Plantillas
========================== */
$('#btnExportTpl').addEventListener('click', ()=>{
  if(!ROIs.length){ setStatus('No hay ROIs para exportar.','fail'); return; }
  const name = prompt('Nombre de la plantilla:','plantilla_rois') || 'plantilla_rois';
  const payload={ templateName:name, imageInfo:{ naturalWidth:imgEl.naturalWidth||null, naturalHeight:imgEl.naturalHeight||null },
    rois: ROIs.map(r=>({id:r.id,name:r.name,type:r.type, relX:r.x/canvas.width, relY:r.y/canvas.height, relW:r.w/canvas.width, relH:r.h/canvas.height})) };
  const blob=new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name+'.json'; document.body.appendChild(a); a.click(); a.remove();
  setStatus('Plantilla exportada.','ok');
});
$('#btnImportTpl').addEventListener('click', ()=> $('#tplFile').click());
$('#tplFile').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=()=>{ try{
      const tpl=JSON.parse(fr.result); if(!tpl.rois||!Array.isArray(tpl.rois)) throw new Error('Plantilla inválida');
      ROIs.length=0;
      tpl.rois.forEach(r=> ROIs.push({ id:r.id||('roi_'+(roiCounter++)), name:r.name||('roi_'+(roiCounter-1)), type:r.type||'text',
        x:Math.round((r.relX||0)*canvas.width), y:Math.round((r.relY||0)*canvas.height),
        w:Math.round((r.relW||.3)*canvas.width), h:Math.round((r.relH||.2)*canvas.height) }));
      activeROIId=ROIs[0]?.id||null; refreshROIList(); drawCanvas(); if(activeROIId) fillProp(getActive()); setStatus('Plantilla importada.','ok');
    }catch(err){ setStatus('Error plantilla: '+err.message,'fail'); }
    e.target.value='';
  };
  fr.readAsText(f);
});

/* ==========================
   Extracción por ROI
========================== */
$('#btnExtractSelected').addEventListener('click', ()=> extractFromROI(getActive()));
$('#btnExtractAll').addEventListener('click', async ()=>{
  if(!ROIs.length){ setStatus('No hay ROIs.','fail'); return; }
  const res={}; for(const r of ROIs){ res[r.name] = await extractFromROI(r) || {error:'Sin resultado'}; }
  $('#result').textContent = JSON.stringify(res,null,2); setStatus('Extracción en lote finalizada.','ok');
});

async function extractFromROI(r){
  if(!r){ setStatus('Selecciona una ROI.','fail'); return; }
  if(!imgEl.src){ setStatus('Carga/captura una imagen.','fail'); return; }
  try{
    if (r.type==='image'){
      const c=cropROIToCanvas(r); const dataUrl=c.toDataURL('image/png');
      const out={type:'image', name:r.name, base64:dataUrl};
      $('#result').textContent=JSON.stringify(out,null,2);
      tableOut({ROI:r.name,Tipo:'image','Base64 (preview)':dataUrl.slice(0,64)+'…'}); setStatus(`Captura base64 (${r.name}).`,'ok'); beep(); return out;
    }
    if (r.type==='text'){
      setStatus(`OCR (text) en ${r.name}…`);
      const c=cropROIToCanvas(r);
      const {data}=await Tesseract.recognize(c,'eng',{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789<>:/-.,#()@ ',preserve_interword_spaces:'1'});
      const raw=(data.text||'').trim(); const out={type:'text', name:r.name, raw};
      $('#result2').textContent=raw; tableOut({ROI:r.name,Tipo:'text',Texto:raw}); setStatus(`OCR completo (${r.name}).`,'ok'); beep(); return out;
    }
    if (r.type==='barcode'){
      setStatus(`Decodificando barcode en ${r.name}…`);
      const c=cropROIToCanvas(r); const dataUrl=c.toDataURL('image/png'); const im=new Image();
      const res = await new Promise((resolve,reject)=>{ im.onload=()=> codeReader.decodeFromImageElement(im).then(resolve).catch(reject); im.onerror=reject; im.src=dataUrl; });
      const out={type:'barcode', name:r.name, format:res?.format, text:res?.text||''};
      $('#result2').textContent=out.text; tableOut({ROI:r.name,Tipo:'barcode',Formato:res?.format,Texto:out.text}); setStatus(`Barcode extraído (${r.name}).`,'ok'); beep(); return out;
    }
    if (r.type==='pdf417'){
      setStatus(`Decodificando PDF417 en ${r.name}…`);
      const c=cropROIToCanvas(r); const dataUrl=c.toDataURL('image/png'); const im=new Image();
      const res = await new Promise((resolve,reject)=>{ im.onload=()=> codeReader.decodeFromImageElement(im).then(resolve).catch(reject); im.onerror=reject; im.src=dataUrl; });
      const raw=res?.text||''; lastPDF417Raw = raw;
      let parsed={}; if(raw.includes('||')) parsed=parseRawDUI(raw); else if(res && res.format===10) parsed=parseUSDL(raw);
      const out={type:'pdf417', name:r.name, raw, parsed};
      $('#result').textContent=JSON.stringify(parsed,null,2); $('#result2').textContent=raw; if(parsed && Object.keys(parsed).length) tableOut(parsed);
      setStatus(`PDF417 extraído (${r.name}).`,'ok'); beep(); return out;
    }
    if (r.type==='mrz'){
      setStatus(`OCR (MRZ) en ${r.name}…`);
      const c=cropROIToCanvas(r);
      const {data}=await Tesseract.recognize(c,'eng',{tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',preserve_interword_spaces:'1'});
      const raw=(data.text||'').toUpperCase().replace(/[^\nA-Z0-9< ]/g,'');
      const linesObj=normalizeMRZLines(raw); let payload={};
      if (linesObj){ const p=parseMRZ(linesObj); payload = p.error? {error:p.error,mrzLines:linesObj.lines} : {mrzLines:linesObj.lines,parsed:p}; }
      else payload={error:'No MRZ lines'};
      const out={type:'mrz', name:r.name, raw, ...payload};
      $('#result').textContent=JSON.stringify(out,null,2); $('#result2').textContent=raw;
      if(out.parsed) tableOut(out.parsed);
      setStatus(`MRZ procesado (${r.name}).`,'ok'); beep(); return out;
    }
    setStatus('Tipo de ROI no soportado.','fail');
  }catch(e){ console.error(e); setStatus('Error extracción: '+e.message,'fail'); }
}

/* ==========================
   Captura desde cámara a imagen
========================== */
async function capturePhotoFromCamera(){
  if (!video.videoWidth) { setStatus("Inicia la cámara antes de capturar.",'fail'); return; }
  const shot = document.createElement('canvas');
  shot.width=video.videoWidth; shot.height=video.videoHeight;
  shot.getContext('2d').drawImage(video,0,0,shot.width,shot.height);
  const dataURL = shot.toDataURL('image/png');
  await loadImageToStage(dataURL);
  setStatus("Foto capturada y cargada.","ok"); beep();
}

/* ==========================
   CROP interactivo
========================== */
const cropState = {
  active:false,
  rect:null, // {x,y,w,h}
  mode:null, startX:0, startY:0, startRect:null, handle:null
};
function defaultCropRect(){
  const w = Math.floor(canvas.width*0.8);
  const h = Math.floor(canvas.height*0.8);
  return { x:Math.floor((canvas.width-w)/2), y:Math.floor((canvas.height-h)/2), w, h };
}
function drawCropOverlay(){
  const r = cropState.rect;
  // oscurecer todo menos el recorte
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,.55)';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.globalCompositeOperation = 'destination-out';
  ctx.fillStyle='rgba(0,0,0,1)';
  ctx.fillRect(r.x,r.y,r.w,r.h);
  ctx.restore();

  // borde y handlers
  ctx.save();
  ctx.strokeStyle='#2a6df5'; ctx.lineWidth=2.5;
  ctx.setLineDash([8,6]);
  ctx.strokeRect(r.x,r.y,r.w,r.h);
  ctx.setLineDash([]);
  const hs = getHandles(r);
  ctx.fillStyle='#2a6df5';
  hs.forEach(h=> ctx.fillRect(h.x-HANDLE_SIZE/2,h.y-HANDLE_SIZE/2,HANDLE_SIZE,HANDLE_SIZE));
  ctx.restore();

  $('#cropInfo').textContent = `Crop: (${r.x},${r.y}) ${r.w}×${r.h}`;
}
function startCropInteract(x,y){
  const r = cropState.rect;
  const handle = hitHandle(r,x,y);
  if (handle){
    cropState.mode='resize'; cropState.handle=handle;
    cropState.startX=x; cropState.startY=y; cropState.startRect={...r};
    return;
  }
  if (ptIn(x,y,r.x,r.y,r.w,r.h)){
    cropState.mode='move'; cropState.handle=null;
    cropState.startX=x; cropState.startY=y; cropState.startRect={...r};
    return;
  }
  // click fuera: reposicionar centro
  const cw = r.w, ch = r.h;
  let nx = clamp(x - cw/2, 0, canvas.width - cw);
  let ny = clamp(y - ch/2, 0, canvas.height - ch);
  cropState.rect.x = nx; cropState.rect.y = ny;
  drawCanvas();
}
function moveCropInteract(x,y){
  if (!cropState.mode) return;
  const dx = x - cropState.startX, dy = y - cropState.startY;
  const s = cropState.startRect;
  if (cropState.mode==='move'){
    let nx = clamp(s.x + dx, 0, canvas.width - s.w);
    let ny = clamp(s.y + dy, 0, canvas.height - s.h);
    cropState.rect.x = nx; cropState.rect.y = ny;
  }else if (cropState.mode==='resize'){
    let nx=s.x, ny=s.y, nw=s.w, nh=s.h;
    const h = cropState.handle;
    if(h.includes('n')){ ny=clamp(s.y+dy,0,s.y+s.h-20); nh=s.h-(ny-s.y); }
    if(h.includes('s')){ nh=clamp(s.h+dy,20,canvas.height-s.y); }
    if(h.includes('w')){ nx=clamp(s.x+dx,0,s.x+s.w-20); nw=s.w-(nx-s.x); }
    if(h.includes('e')){ nw=clamp(s.w+dx,20,canvas.width-s.x); }
    cropState.rect.x=nx; cropState.rect.y=ny; cropState.rect.w=nw; cropState.rect.h=nh;
  }
  drawCanvas();
}
function setCropUI(enabled){
  $('#btnCropApply').disabled = !enabled;
  $('#btnCropCancel').disabled = !enabled;
  $('#btnCropActivate').textContent = enabled ? 'Desactivar Crop' : 'Activar Crop';
}
$('#btnCropActivate').addEventListener('click', ()=>{
  if (!imgEl.src){ setStatus('Carga/captura una imagen primero.','fail'); return; }
  cropState.active = !cropState.active;
  if (cropState.active){
    cropState.rect = defaultCropRect();
    setCropUI(true);
  }else{
    setCropUI(false); $('#cropInfo').textContent='';
  }
  drawCanvas();
});
$('#btnCropCancel').addEventListener('click', ()=>{
  if (!cropState.active) return;
  cropState.active=false; setCropUI(false); $('#cropInfo').textContent=''; drawCanvas();
});
$('#btnCropApply').addEventListener('click', async ()=>{
  if (!cropState.active) return;
  const r = cropState.rect;
  // calcular en coordenadas naturales
  const sx = Math.round(r.x * scaleX), sy = Math.round(r.y * scaleY);
  const sw = Math.max(1, Math.round(r.w * scaleX)), sh = Math.max(1, Math.round(r.h * scaleY));

  // hacer recorte
  const c = document.createElement('canvas'); c.width=sw; c.height=sh;
  const cx = c.getContext('2d'); cx.drawImage(imgEl, sx, sy, sw, sh, 0, 0, sw, sh);
  const dataURL = cx.canvas.toDataURL('image/png');

  // trasladar/clipear ROIs al nuevo origen
  adjustROIsAfterCrop(r);

  // cargar nueva imagen recortada
  await loadImageToStage(dataURL);

  cropState.active=false; setCropUI(false); $('#cropInfo').textContent='';
  setStatus('Recorte aplicado. ROIs trasladados/filtrados.','ok'); beep();
});

function adjustROIsAfterCrop(r){
  // r está en coords de canvas (px en pantalla)
  const newROIs = [];
  for (const a of ROIs){
    // nueva posición relativa al nuevo origen (r.x, r.y)
    const nx = a.x - r.x, ny = a.y - r.y, nw = a.w, nh = a.h;

    // intersección con [0,0,r.w,r.h]
    const ix = clamp(nx, 0, r.w);
    const iy = clamp(ny, 0, r.h);
    const ix2 = clamp(nx+nw, 0, r.w);
    const iy2 = clamp(ny+nh, 0, r.h);
    const iw = Math.max(0, ix2 - ix);
    const ih = Math.max(0, iy2 - iy);

    if (iw >= 8 && ih >= 8){ // descarta sin área o demasiado pequeño
      newROIs.push({ ...a, x:Math.round(ix), y:Math.round(iy), w:Math.round(iw), h:Math.round(ih) });
    }
  }
  ROIs.length = 0;
  newROIs.forEach(n => ROIs.push(n));
  activeROIId = ROIs[0]?.id || null;
  refreshROIList();
}

/* ==========================
   Otros
========================== */
$('#torchButton').addEventListener('click', ()=>{/* handler real en setupCameraControls() */});
</script>
</body>
</html>
