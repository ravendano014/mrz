<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>PDF417 & MRZ – Scanner y Lector de Imagen</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; padding: 24px; background: #0b1220; color: #e7ecf5; }
    h1 { font-size: 1.4rem; margin: 0 0 8px; }
    h2 { font-size: 1.2rem; margin: 0 0 12px; color: #cfe0ff; }
    h3 { font-size: 1.1rem; margin: 0 0 10px; color: #cfe0ff; }
    p { margin: 6px 0 14px; color:#b9c2d0 }
    .app { max-width: 1080px; margin: 0 auto; }
    .card { background: #121a2b; border: 1px solid #1e2a44; border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1100px){ .grid { grid-template-columns: 480px 1fr; } }
    label.inline { display: inline-flex; align-items: center; gap: 8px; background:#0f1726; border:1px dashed #2b3b60; padding: 10px 12px; border-radius: 12px; cursor: pointer; }
    input[type=file]{ display:none }
    button { appearance: none; border: 0; background: #2a6df5; color: white; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    button.secondary { background: #2b3b60 }
    button.success { background: #0a6; }
    button.warn { background: #bb6f00; }
    img { max-width: 100%; height: auto; border-radius: 12px; border:1px solid #1e2a44; background:#0b1120 }
    .row { display:flex; gap:10px; flex-wrap: wrap; align-items:center }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .92rem; }
    textarea { width: 100%; min-height: 120px; resize: vertical; border-radius: 12px; padding: 10px; border:1px solid #1e2a44; background:#0f1726; color:#e7ecf5 }
    pre { background:#0f1726; border:1px solid #1e2a44; padding:12px; border-radius:12px; overflow:auto }
    .badge { font-size: .75rem; background:#0f6; color:#021; padding:3px 8px; border-radius:999px; }
    .hint { font-size: .85rem; color:#9fb0cb }
    .kv { display:grid; grid-template-columns: 180px 1fr; gap:6px 10px; }
    .kv b{color:#cfe0ff}
    .mrz-guide { background: #0f1726; border: 1px solid #1e2a44; border-radius: 8px; padding: 8px 12px; margin: 8px 0 16px; font-size: 0.85rem; }
    .result-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .result-table th, .result-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #1e2a44; }
    .result-table th { background: #0f1726; color: #cfe0ff; font-weight: 600; }
    .result-table tr:last-child td { border-bottom: none; }
    .check-ok { color: #0f6; }
    .check-fail { color: #f06; }
    .result-summary { background: #0f1726; border: 1px solid #1e2a44; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .json-container { margin-top: 16px; }
    .json-container h4 { margin: 0 0 8px; }
    .json-pre { background: #0f1726; border: 1px solid #1e2a44; border-radius: 12px; padding: 12px; max-height: 300px; overflow-y: auto; font-size: 0.85rem; }
    .hidden { display: none; }
    #video { width: 100%; height: 300px; border-radius: 12px; border: 1px solid #1e2a44; background: #0b1120; position: relative; }
    #imagePreview { max-width: 100%; max-height: 300px; display: none; margin-top: 10px; }
    .section { margin-bottom: 24px; }
    .button-group { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
    select { background: #0f1726; border: 1px solid #1e2a44; border-radius: 10px; padding: 10px 12px; color: #e7ecf5; width: 100%; max-width: 400px; }
    #sourceSelectPanel { margin-bottom: 16px; }
    .scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    .scanner-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 50%; border: 3px solid #0f6; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; }
    .scanner-frame::before { content: "Coloque el código PDF417 dentro de este marco"; position: absolute; top: -30px; color: #0f6; font-size: 14px; text-align: center; width: 100%; }
    .beep-option { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
    .beep-option input[type="checkbox"] { width: 18px; height: 18px; accent-color: #2a6df5; }
  </style>
</head>
<body>
  <div class="app">
    <h1>PDF417 & MRZ – Scanner y Lector de Imagen</h1>
    <p class="hint">Escanea PDF417 con cámara, procesa una imagen para <b>PDF417</b>/<b>MRZ</b> o pega el <b>Texto Crudo (DUI)</b> para parsear directamente.</p>

    <div class="grid">
      <div>
        <!-- CÁMARA PDF417 -->
        <div class="card section">
          <h2>1. Escanear desde Cámara (PDF417)</h2>
          <div class="button-group">
            <button id="startButton">Iniciar Cámara</button>
            <button id="resetButton" class="secondary">Detener Cámara</button>
          </div>
          <div class="beep-option">
            <input type="checkbox" id="beepCheckbox" checked />
            <label for="beepCheckbox">Reproducir sonido al detectar código</label>
          </div>
          <div id="sourceSelectPanel" class="hidden">
            <label for="sourceSelect">Seleccionar cámara:</label>
            <select id="sourceSelect"></select>
          </div>
          <div style="position: relative;">
            <video id="video" muted playsinline></video>
            <div class="scanner-overlay">
              <div class="scanner-frame"></div>
            </div>
          </div>
        </div>

        <!-- IMAGEN -->
        <div class="card section">
          <h2>2. Cargar Imagen</h2>
          <div class="button-group">
            <input type="file" id="fileInput" accept="image/*" class="hidden" />
            <button id="selectImageButton" class="secondary">Seleccionar Imagen</button>
            <button id="processImageButton" class="success" disabled>Procesar Imagen (PDF417)</button>
            <button id="processMRZButton" class="warn" disabled>Procesar MRZ (OCR)</button>
          </div>
          <div class="mrz-guide">
            <b>Sugerencias MRZ:</b> recorta o carga una imagen donde las líneas MRZ estén rectas y legibles. El OCR se limita a caracteres <span class="mono">A–Z, 0–9, &lt;</span>.
          </div>
          <div>
            <img id="imagePreview" alt="Vista previa de la imagen" />
          </div>
        </div>

        <!-- TEXTO CRUDO DUI -->
        <div class="card section">
          <h2>3. Parsear Texto Crudo (DUI)</h2>
          <p class="hint">
            Este botón usa automáticamente el <b>texto crudo detectado del PDF417</b> (Procesar Imagen o Cámara).
            Si no hay texto crudo disponible, se usará lo que pegues abajo.
          </p>
          <textarea id="rawInput" placeholder="Opcional: Pega texto crudo si no proviene del PDF417 (formato con '||')"></textarea>
          <div class="button-group" style="margin-top:10px;">
            <button id="parseRawButton">Parsear Texto Crudo (DUI)</button>
          </div>
        </div>
      </div>

      <!-- RESULTADOS -->
      <div>
        <div class="card section">
          <h2>Resultados</h2>
          <div class="result-summary">
            <div class="kv">
              <b>Estado:</b> <span id="status">Esperando...</span>
            </div>
          </div>

          <div id="extractedDataTable" class="hidden">
            <h4>Datos Extraídos (Parseados):</h4>
            <table class="result-table">
              <thead>
                <tr><th>Campo</th><th>Valor</th></tr>
              </thead>
              <tbody id="dataTableBody"></tbody>
            </table>
          </div>

          <div class="json-container">
            <h4>Datos en Formato JSON:</h4>
            <pre class="json-pre" id="result"></pre>
          </div>

          <div class="json-container">
            <h4>Texto Crudo:</h4>
            <pre class="json-pre" id="result2"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ZXing para PDF417 -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <!-- Tesseract.js para OCR MRZ -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

  <script>
    /* ========= utilidades ========= */
    function playBeep() {
      const beepCheckbox = document.getElementById('beepCheckbox');
      if (!beepCheckbox.checked) return;
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
        oscillator.frequency.value = 800; oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        const audio = new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==");
        audio.play().catch(()=>{});
      }
    }
    function updateStatus(message, type = "info") {
      const el = document.getElementById("status");
      el.textContent = message;
      el.className = "";
      if (type === "success") el.classList.add("check-ok");
      else if (type === "error") el.classList.add("check-fail");
    }
    function displayDataInTable(data) {
      const body = document.getElementById('dataTableBody');
      const container = document.getElementById('extractedDataTable');
      body.innerHTML = '';
      for (const [k, v] of Object.entries(data)) {
        const tr = document.createElement('tr');
        const tdK = document.createElement('td'); tdK.textContent = k;
        const tdV = document.createElement('td'); tdV.textContent = (v ?? '');
        tr.appendChild(tdK); tr.appendChild(tdV); body.appendChild(tr);
      }
      container.classList.remove('hidden');
    }

    /* ========= Parser PDF417 (USDL) ========= */
    const parseUSDL = str => {
      const CodeToKey = {
        DCA:"jurisdictionVehicleClass", DCB:"jurisdictionRestrictionCodes", DCD:"jurisdictionEndorsementCodes",
        DBA:"dateOfExpiry", DCS:"lastName", DAC:"firstName", DAD:"middleName", DBD:"dateOfIssue", DBB:"dateOfBirth",
        DBC:"sex", DAY:"eyeColor", DAU:"height", DAG:"addressStreet", DAI:"addressCity", DAJ:"addressState",
        DAK:"addressPostalCode", DAQ:"documentNumber", DCF:"documentDiscriminator", DCG:"issuer",
        DDE:"lastNameTruncated", DDF:"firstNameTruncated", DDG:"middleNameTruncated",
        DAZ:"hairColor", DAH:"addressStreet2", DCI:"placeOfBirth", DCJ:"auditInformation", DCK:"inventoryControlNumber",
        DBN:"otherLastName", DBG:"otherFirstName", DBS:"otherSuffixName", DCU:"nameSuffix",
        DCE:"weightRange", DCL:"race", DCM:"standardVehicleClassification", DCN:"standardEndorsementCode",
        DCO:"standardRestrictionCode", DCP:"jurisdictionVehicleClassificationDescription",
        DCQ:"jurisdictionEndorsementCodeDescription", DCR:"jurisdictionRestrictionCodeDescription",
        DDA:"complianceType", DDB:"dateCardRevised", DDC:"dateOfExpiryHazmatEndorsement",
        DDD:"limitedDurationDocumentIndicator", DAW:"weightLb", DAX:"weightKg", DDH:"dateAge18",
        DDI:"dateAge19", DDJ:"dateAge21", DDK:"organDonor", DDL:"veteran"
      };
      const parse = (str, options={suppressErrors:true}) => {
        const props = {};
        const lines = str.trim().split("\n").map(l => l.match(/[\011\012\015\040-\177]*/g).join("").trim());
        let started=false;
        lines.slice(0,-1).forEach(line=>{
          if(!started){ if(line.indexOf("ANSI ")===0){ started=true;} return; }
          let code=line.slice(0,3), value=line.slice(3), key=CodeToKey[code];
          if(!key){ if(!options.suppressErrors) throw new Error("unknown code: "+code); return; }
          if(code==="DBC") value = (value==="1"?"M":"F");
          if(key.indexOf("date")===0) value = `${value.slice(4)}-${value.slice(0,2)}-${value.slice(2,4)}`;
          props[key]=value;
        });
        return props;
      };
      return parse(str,{suppressErrors:true});
    };

    /* ========= MRZ OCR + Parser ========= */
    function mrzCheckDigit(data) {
      const weights = [7, 3, 1];
      const mapChar = (c) => {
        if (c === '<') return 0;
        if (c >= '0' && c <= '9') return c.charCodeAt(0) - 48;
        if (c >= 'A' && c <= 'Z') return c.charCodeAt(0) - 55;
        return 0;
      };
      let sum = 0;
      for (let i = 0; i < data.length; i++) {
        sum += mapChar(data[i]) * weights[i % 3];
      }
      return String(sum % 10);
    }
    function normalizeMRZLines(text) {
      const clean = text
        .toUpperCase()
        .replace(/[^\nA-Z0-9<]/g, '')
        .split(/\n+/)
        .map(l => l.replace(/ /g,'').trim())
        .filter(l => l.length >= 24);
      const candidates = [];
      for (let i=0;i<clean.length;i++){
        const l = clean[i];
        if (l.length >= 40 && l.length <= 48 && i+1 < clean.length && clean[i+1].length >= 40 && clean[i+1].length <= 48) {
          candidates.push({typeGuess:'TD3', lines:[l.padEnd(44,'<').slice(0,44), clean[i+1].padEnd(44,'<').slice(0,44)]});
        }
        if (l.length >= 32 && l.length <= 40 && i+1 < clean.length && clean[i+1].length >= 32 && clean[i+1].length <= 40) {
          candidates.push({typeGuess:'TD2', lines:[l.padEnd(36,'<').slice(0,36), clean[i+1].padEnd(36,'<').slice(0,36)]});
        }
        if (l.length >= 26 && l.length <= 34 && i+2 < clean.length && clean[i+1] && clean[i+2]) {
          if (clean[i+1].length >= 26 && clean[i+1].length <= 34 && clean[i+2].length >= 26 && clean[i+2].length <= 34) {
            candidates.push({typeGuess:'TD1', lines:[
              l.padEnd(30,'<').slice(0,30),
              clean[i+1].padEnd(30,'<').slice(0,30),
              clean[i+2].padEnd(30,'<').slice(0,30)
            ]});
          }
        }
      }
      candidates.sort((a,b)=>{
        const dens = s => (s.join('').match(/</g) || []).length;
        return dens(b.lines)-dens(a.lines);
      });
      return candidates.length ? candidates[0] : null;
    }
    function parseTD3(lines) {
      const L1 = lines[0], L2 = lines[1];
      const docType = L1.slice(0,2).replace(/</g,'');
      const issuingCountry = L1.slice(2,5).replace(/</g,'');
      const namePart = L1.slice(5).split('<<');
      const surname = namePart[0].replace(/</g,'');
      const givenNames = (namePart[1]||'').replace(/</g,' ').trim();
      const docNumber = L2.slice(0,9);
      const docNumberCD = L2[9];
      const nationality = L2.slice(10,13).replace(/</g,'');
      const birth = L2.slice(13,19);
      const birthCD = L2[19];
      const sex = L2[20];
      const expiry = L2.slice(21,27);
      const expiryCD = L2[27];
      const optional = L2.slice(28,42);
      const compositeCheck = L2[43];
      const docNumberOK = mrzCheckDigit(docNumber) === docNumberCD;
      const birthOK = mrzCheckDigit(birth) === birthCD;
      const expiryOK = mrzCheckDigit(expiry) === expiryCD;
      const compositeOK = mrzCheckDigit(docNumber + docNumberCD + birth + birthCD + expiry + expiryCD + optional) === compositeCheck;
      return {
        mrzType: 'TD3',
        documentType: docType,
        issuingCountry,
        surname,
        givenNames,
        documentNumber: docNumber.replace(/</g,''),
        documentNumberCheck: docNumberOK,
        nationality,
        birthDate: birth,
        birthDateCheck: birthOK,
        sex,
        expiryDate: expiry,
        expiryDateCheck: expiryOK,
        optional: optional.replace(/</g,'') || '',
        compositeCheck: compositeOK
      };
    }
    function parseTD2(lines) {
      const L1 = lines[0], L2 = lines[1];
      const docType = L1.slice(0,2).replace(/</g,'');
      const issuingCountry = L1.slice(2,5).replace(/</g,'');
      const namePart = L1.slice(5).split('<<');
      const surname = namePart[0].replace(/</g,'');
      const givenNames = (namePart[1]||'').replace(/</g,' ').trim();
      const docNumber = L2.slice(0,9);
      const docNumberCD = L2[9];
      const nationality = L2.slice(10,13).replace(/</g,'');
      const birth = L2.slice(13,19);
      const birthCD = L2[19];
      const sex = L2[20];
      const expiry = L2.slice(21,27);
      const expiryCD = L2[27];
      const optional = L2.slice(28,35);
      const compositeCheck = L2[35];
      const docNumberOK = mrzCheckDigit(docNumber) === docNumberCD;
      const birthOK = mrzCheckDigit(birth) === birthCD;
      const expiryOK = mrzCheckDigit(expiry) === expiryCD;
      const compositeCheckOK = mrzCheckDigit(docNumber + docNumberCD + birth + birthCD + expiry + expiryCD + optional) === compositeCheck;
      return {
        mrzType: 'TD2',
        documentType: docType,
        issuingCountry,
        surname,
        givenNames,
        documentNumber: docNumber.replace(/</g,''),
        documentNumberCheck: docNumberOK,
        nationality,
        birthDate: birth,
        birthDateCheck: birthOK,
        sex,
        expiryDate: expiry,
        expiryDateCheck: expiryOK,
        optional: optional.replace(/</g,'') || '',
        compositeCheck: compositeCheckOK
      };
    }
    function parseTD1(lines) {
      const L1 = lines[0], L2 = lines[1], L3 = lines[2];
      const docType = L1.slice(0,2).replace(/</g,'');
      const issuingCountry = L1.slice(2,5).replace(/</g,'');
      const docNumber = L1.slice(5,14);
      const docNumberCD = L1[14];
      const optional1 = L1.slice(15,30);
      const birth = L2.slice(0,6);
      const birthCD = L2[6];
      const sex = L2[7];
      const expiry = L2.slice(8,14);
      const expiryCD = L2[14];
      const nationality = L2.slice(15,18).replace(/</g,'');
      const optional2 = L2.slice(18,29);
      const compositeCheck = L2[29];
      const namePart = L3.split('<<');
      const surname = namePart[0].replace(/</g,'');
      const givenNames = (namePart[1]||'').replace(/</g,' ').trim();
      const docNumberOK = mrzCheckDigit(docNumber) === docNumberCD;
      const birthOK = mrzCheckDigit(birth) === birthCD;
      const expiryOK = mrzCheckDigit(expiry) === expiryCD;
      const compositeOK = mrzCheckDigit(docNumber + docNumberCD + birth + birthCD + expiry + expiryCD + optional1 + optional2) === compositeCheck;
      return {
        mrzType: 'TD1',
        documentType: docType,
        issuingCountry,
        documentNumber: docNumber.replace(/</g,''),
        documentNumberCheck: docNumberOK,
        birthDate: birth,
        birthDateCheck: birthOK,
        sex,
        expiryDate: expiry,
        expiryDateCheck: expiryOK,
        nationality,
        optional: (optional1 + optional2).replace(/</g,'') || '',
        surname,
        givenNames,
        compositeCheck: compositeOK
      };
    }
    function parseMRZ(linesObj) {
      if (!linesObj) return { error: "No se detectaron líneas MRZ válidas." };
      const { typeGuess, lines } = linesObj;
      if (typeGuess === 'TD3' && lines.length === 2) return parseTD3(lines);
      if (typeGuess === 'TD2' && lines.length === 2) return parseTD2(lines);
      if (typeGuess === 'TD1' && lines.length === 3) return parseTD1(lines);
      if (lines.length === 2 && lines[0].length === 44 && lines[1].length === 44) return parseTD3(lines);
      if (lines.length === 2 && lines[0].length === 36 && lines[1].length === 36) return parseTD2(lines);
      if (lines.length === 3 && lines[0].length === 30 && lines[1].length === 30 && lines[2].length === 30) return parseTD1(lines);
      return { error: "Formato MRZ no reconocido." };
    }

      /* ========= DUI Texto Crudo ========= */
    const DUI_FIELDS = [
      "Número de DUI",
      "Primer Apellido",
      "Segundo Apellido y Nombres",
      "Número de Emisión",
      "Firma Digital",
      "Lugar de Nacimiento",
      "Municipio",
      "Profesión u Oficio",
      "Sexo",
      "Fecha de Nacimiento",
      "Fecha de Emisión",
      "Código de Zona",
      "Categoría",
      "Estdo Familiar",
      "Nacionalidad",
      "Segunda Firma Digital",
      "Código de Verificación"
    ];
    function parseRawDUI(raw) {
      const text = (raw || "").trim().replace(/\r/g,'');
      const parts = text.split("||").map(s => s.trim());
      const out = {};
      DUI_FIELDS.forEach((label, idx) => { out[label] = (parts[idx] ?? ""); });
      return out;
    }

    /* ========= Estado global ========= */
    let selectedDeviceId;
    let codeReader;
    let selectedImageFile = null;
    let isScanning = false;
    let lastPDF417Raw = ""; // guarda el texto crudo más reciente de PDF417

    /* ========= Inicialización ========= */
    (async () => {
      try {
        codeReader = new ZXing.BrowserMultiFormatReader();
        const videoInputDevices = await codeReader.getVideoInputDevices();
        const sourceSelect = document.getElementById("sourceSelect");
        selectedDeviceId = videoInputDevices?.[0]?.deviceId;

        if ((videoInputDevices || []).length > 1) {
          videoInputDevices.forEach(d => {
            const opt = document.createElement("option");
            opt.text = d.label; opt.value = d.deviceId; sourceSelect.appendChild(opt);
          });
          sourceSelect.onchange = () => { selectedDeviceId = sourceSelect.value; };
          document.getElementById("sourceSelectPanel").classList.remove("hidden");
        }
        setupEventListeners();
      } catch (err) {
        updateStatus("Error: " + err.message, "error");
        console.error(err);
      }
    })();

    function setupEventListeners() {
      document.getElementById("startButton").addEventListener("click", startCamera);
      document.getElementById("resetButton").addEventListener("click", resetCamera);
      document.getElementById("selectImageButton").addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });
      document.getElementById("fileInput").addEventListener("change", handleImageSelection);
      document.getElementById("processImageButton").addEventListener("click", processImagePDF417);
      document.getElementById("processMRZButton").addEventListener("click", processImageMRZ);

      // Botón Parsear DUI: usa primero el texto crudo proveniente de PDF417
      document.getElementById("parseRawButton").addEventListener("click", () => {
        const fallback = document.getElementById("rawInput").value;
        const sourceRaw = (lastPDF417Raw && lastPDF417Raw.trim()) ? lastPDF417Raw : fallback;

        if (!sourceRaw || !sourceRaw.trim()) {
          updateStatus("No hay texto crudo disponible (ni de PDF417 ni del textarea).", "error");
          return;
        }
        const parsed = parseRawDUI(sourceRaw);
        document.getElementById("result").textContent = JSON.stringify(parsed, null, 2);
        document.getElementById("result2").textContent = sourceRaw;
        displayDataInTable(parsed);
        updateStatus(
          (lastPDF417Raw && lastPDF417Raw.trim()) 
            ? "Texto crudo (DUI) parseado desde PDF417."
            : "Texto crudo (DUI) parseado desde textarea.",
          "success"
        );
        document.querySelectorAll('.json-container').forEach(el => el.style.display = 'block');
        playBeep();
      });
    }

    /* ========= Cámara PDF417 ========= */
    function startCamera() {
      if (isScanning) { updateStatus("La cámara ya está en funcionamiento", "info"); return; }
      isScanning = true;
      updateStatus("Escaneando con la cámara (PDF417)...", "info");
      codeReader.decodeFromVideoDevice(selectedDeviceId, "video", (result, err) => {
        if (result) {
          lastPDF417Raw = result.text || "";
          document.getElementById("result2").textContent = lastPDF417Raw;

          // << AUTO-PARSE DUI >>
          if (lastPDF417Raw.includes("||")) {
            const parsed = parseRawDUI(lastPDF417Raw);
            document.getElementById("result").textContent = JSON.stringify(parsed, null, 2);
            displayDataInTable(parsed);
            updateStatus("Texto crudo (DUI) auto-parseado desde PDF417 (cámara).", "success");
            document.querySelectorAll('.json-container').forEach(el => el.style.display = 'block');
            playBeep();
            return; // preferimos DUI si viene en crudo
          }

          if (result.format === 10) { // PDF417
            const parsedData = parseUSDL(result.text);
            document.getElementById("result").textContent = JSON.stringify(parsedData, null, 2);
            displayDataInTable(parsedData);
            updateStatus("Código PDF417 detectado y procesado", "success");
            document.querySelectorAll('.json-container').forEach(el => el.style.display = 'block');
            playBeep();
          } else {
            updateStatus("Formato detectado: " + result.format, "info");
          }
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
          console.error(err);
          updateStatus("Error: " + err.message, "error");
        }
      });
    }
    function resetCamera() {
      if (codeReader) codeReader.reset();
      isScanning = false;
      document.getElementById("result").textContent = "";
      document.getElementById("result2").textContent = "";
      document.getElementById("extractedDataTable").classList.add("hidden");
      updateStatus("Cámara detenida", "info");
    }

    /* ========= Imagen: manejo común ========= */
    function handleImageSelection(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      selectedImageFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.getElementById("imagePreview");
        img.src = ev.target.result;
        img.style.display = 'block';
        document.getElementById("processImageButton").disabled = false;
        document.getElementById("processMRZButton").disabled = false;
        updateStatus("Imagen cargada. Lista para procesar.", "info");
      };
      reader.readAsDataURL(file);
    }

    /* ========= Proceso: PDF417 desde imagen ========= */
    function processImagePDF417() {
      if (!selectedImageFile) { updateStatus("Selecciona una imagen primero.", "error"); return; }
      const img = document.getElementById("imagePreview");
      updateStatus("Procesando imagen (PDF417)...", "info");

      codeReader.decodeFromImageElement(img)
        .then(result => {
          lastPDF417Raw = result?.text || "";
          document.getElementById("result2").textContent = lastPDF417Raw;

          // << AUTO-PARSE DUI >>
          if (lastPDF417Raw && lastPDF417Raw.includes("||")) {
            const parsedDUI = parseRawDUI(lastPDF417Raw);
            document.getElementById("result").textContent = JSON.stringify(parsedDUI, null, 2);
            displayDataInTable(parsedDUI);
            updateStatus("Texto crudo (DUI) auto-parseado desde PDF417 (imagen).", "success");
            document.querySelectorAll('.json-container').forEach(el => el.style.display = 'block');
            playBeep();
            return; // preferimos DUI si viene en crudo
          }

          if (result && result.format === 10) {
            const parsed = parseUSDL(result.text);
            document.getElementById("result").textContent = JSON.stringify(parsed, null, 2);
            displayDataInTable(parsed);
            updateStatus("Código PDF417 detectado y procesado", "success");
            document.querySelectorAll('.json-container').forEach(el => el.style.display = 'block');
            playBeep();
          } else {
            updateStatus("No se detectó PDF417 en la imagen.", "error");
            document.getElementById("extractedDataTable").classList.add("hidden");
          }
        })
        .catch(err => {
          console.error(err);
          updateStatus("Error al procesar la imagen: " + err.message, "error");
          document.getElementById("result2").textContent = "";
          document.getElementById("extractedDataTable").classList.add("hidden");
          lastPDF417Raw = ""; // limpiar porque falló
        });
    }

    /* ========= Proceso: MRZ desde imagen (OCR) ========= */
    async function processImageMRZ() {
      if (!selectedImageFile) { updateStatus("Selecciona una imagen primero.", "error"); return; }
      const img = document.getElementById("imagePreview");
      updateStatus("Ejecutando OCR (MRZ)...", "info");

      try {
        const { data } = await Tesseract.recognize(img, 'eng', {
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<',
          preserve_interword_spaces: '1'
        });
        const raw = (data.text || '').toUpperCase().replace(/[^\nA-Z0-9< ]/g,'');
        document.getElementById("result2").textContent = raw;

        const linesObj = normalizeMRZLines(raw);
        if (!linesObj) {
          updateStatus("No se localizaron líneas MRZ válidas en el OCR.", "error");
          document.getElementById("extractedDataTable").classList.add("hidden");
          document.getElementById("result").textContent = "";
          return;
        }

        const parsed = parseMRZ(linesObj);
        if (parsed.error) {
          updateStatus("MRZ detectado, pero no se pudo parsear: " + parsed.error, "error");
          document.getElementById("extractedDataTable").classList.add("hidden");
          document.getElementById("result").textContent = JSON.stringify({ mrzLines: linesObj.lines }, null, 2);
          return;
        }

        document.getElementById("result").textContent = JSON.stringify({ mrzLines: linesObj.lines, parsed }, null, 2);
        displayDataInTable(parsed);
        updateStatus(`MRZ (${parsed.mrzType}) extraído y parseado`, "success");
        document.querySelectorAll('.json-container').forEach(el => el.style.display = 'block');
        playBeep();
      } catch (err) {
        console.error(err);
        updateStatus("Error en OCR MRZ: " + err.message, "error");
        document.getElementById("extractedDataTable").classList.add("hidden");
        document.getElementById("result").textContent = "";
      }
    }
  </script>
</body>
</html>


