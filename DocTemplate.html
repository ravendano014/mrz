<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de ROIs - DUI El Salvador</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; --text:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(180deg,#0b1220,#111827);color:var(--text);min-height:100vh}
    header{padding:1.25rem 1rem 0.5rem;max-width:1000px;margin:auto}
    h1{margin:0 0 .25rem;font-size:clamp(1.25rem,2.5vw,1.6rem)}
    p.lead{margin:.25rem 0 1rem;color:var(--muted)}
    .wrap{max-width:1000px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
    .grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.35)}
    .card h2{font-size:1rem;margin:0 0 .25rem;color:#cbd5e1}
    .pad{padding:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0 0}
    button, .btn{appearance:none;border:1px solid #1f2937;background:#0b1220;color:var(--text);padding:.6rem .9rem;border-radius:10px;cursor:pointer}
    button:hover{border-color:#374151}
    .primary{background:var(--accent);border-color:transparent;color:#052e16;font-weight:700}
    .danger{background:var(--danger);color:#fff;border-color:transparent}
    .muted{color:var(--muted)}

    .stage{position:relative;border-radius:16px;overflow:auto;background:#000;max-height:80vh}
    video{width:100%;display:block;max-height:60vh;object-fit:cover}
    canvas.hidden{display:none}

    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .out{white-space:pre-wrap; word-break:break-word; background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:.75rem; min-height:3.5rem}

    dl{margin:.25rem 0;display:grid;grid-template-columns:max-content 1fr;gap:.25rem .75rem}
    dt{color:#9ca3af}
    dd{margin:0}
    .hint{font-size:.92rem;color:#a3e635}
    footer{opacity:.7;text-align:center;padding:1rem}
    a{color:#93c5fd}
    
    /* Estilos para la tabla de resultados */
    .results-table {width:100%;border-collapse:collapse;margin-top:.5rem;font-size:.875rem}
    .results-table th, .results-table td {padding:.5rem;text-align:left;border-bottom:1px solid #1f2937}
    .results-table th {color:#9ca3af;font-weight:600;width:40%}
    .results-table tr:last-child td {border-bottom:none}
    .check-ok {color:#22c55e}
    .check-fail {color:#ef4444}
    .format-guide {background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:.5rem .75rem;margin:.5rem 0;font-size:.85rem}
    .json-container {position:relative}
    .copy-json-btn {position:absolute;top:.5rem;right:.5rem}

    /* Estilos espec√≠ficos para la aplicaci√≥n de ROIs */
    #canvasContainer {
        position: relative;
        border-radius: 8px;
        overflow: auto;
        background: #000;
        min-height: 300px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        border: 1px solid #1f2937;
        max-height: 80vh;
    }
    
    #roiCanvas {
        display: block;
        max-width: none;
    }
    
    .roi-box {
        position: absolute;
        border: 2px solid;
        cursor: move;
        opacity: 0.7;
        font-size: 10px;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 2px;
        box-sizing: border-box;
        overflow: hidden;
        font-weight: bold;
        resize: both;
        overflow: auto;
        border-radius: 4px;
    }
    
    .roi-box.selected {
        border-width: 3px;
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        z-index: 100;
    }
    
    .roi-box.resizing {
        cursor: grabbing;
    }
    
    .data-field-box {
        border-color: #ef4444;
        background-color: rgba(239, 68, 68, 0.2);
    }
    
    .label-box {
        border-color: #22c55e;
        background-color: rgba(34, 197, 94, 0.2);
    }
    
    .static-text-box {
        border-color: #3b82f6;
        background-color: rgba(59, 130, 246, 0.2);
    }
    
    .roi-area-box {
        border-color: #a855f7;
        background-color: rgba(168, 85, 247, 0.2);
    }
    
    .mrz-box {
        border-color: #f59e0b;
        background-color: rgba(245, 158, 11, 0.2);
    }
    
    .pdf417-box {
        border-color: #ec4899;
        background-color: rgba(236, 72, 153, 0.2);
    }
    
    .qr-box {
        border-color: #10b981;
        background-color: rgba(16, 185, 129, 0.2);
    }
    
    .barcode-box {
        border-color: #8b5cf6;
        background-color: rgba(139, 92, 246, 0.2);
    }
    
    .url-box {
        border-color: #06b6d4;
        background-color: rgba(6, 182, 212, 0.2);
    }
    
    .delete-button {
        background-color: #ef4444;
        color: white;
        font-size: 12px;
        padding: 5px;
        position: absolute;
        top: -10px;
        right: -10px;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        border: none;
    }
    
    .add-roi-panel {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #1f2937;
        border-radius: 8px;
        background-color: #0b1220;
    }
    
    .add-roi-form {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
    }
    
    .add-roi-form select, .add-roi-form input {
        padding: 8px;
        border: 1px solid #1f2937;
        border-radius: 8px;
        flex: 1;
        min-width: 150px;
        background: #0b1220;
        color: var(--text);
    }
    
    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
        font-size: 0.85rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid;
    }
    
    .instructions {
        margin-top: 1rem;
        font-size: 0.85rem;
        color: var(--muted);
    }
    
    .instructions ul {
        padding-left: 1.2rem;
        margin: 0.5rem 0;
    }
    
    .instructions li {
        margin-bottom: 0.25rem;
    }
    
    .placeholder-text {
        color: var(--muted);
        text-align: center;
        padding: 2rem;
    }
    
    input[type="file"] {
        display: block;
        margin-bottom: 1rem;
        padding: 10px;
        border: 1px dashed #1f2937;
        border-radius: 8px;
        width: 100%;
        box-sizing: border-box;
        background: #0b1220;
        color: var(--text);
    }
    
    .template-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .template-controls button {
        flex: 1;
        min-width: 150px;
    }
    
    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
        padding: 0.5rem;
        background: #0b1220;
        border-radius: 8px;
        border: 1px solid #1f2937;
        font-size: 0.85rem;
    }
    
    .roi-count {
        color: var(--muted);
    }
    
    .selected-roi {
        color: var(--accent);
    }
    
    .image-info {
        display: flex;
        justify-content: space-between;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--muted);
    }
    
    /* Estilos para la secci√≥n de OCR */
    .ocr-section {
        margin-top: 1rem;
        border-top: 1px solid #1f2937;
        padding-top: 1rem;
    }
    
    .ocr-controls {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .ocr-results {
        margin-top: 1rem;
    }
    
    .progress-bar {
        width: 100%;
        height: 4px;
        background: #1f2937;
        border-radius: 2px;
        margin: 0.5rem 0;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: var(--accent);
        transition: width 0.3s ease;
    }
    
    .progress-text {
        font-size: 0.8rem;
        color: var(--muted);
        text-align: center;
    }
    
    .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        border-bottom: 1px solid #1f2937;
    }
    
    .result-item:last-child {
        border-bottom: none;
    }
    
    .result-field {
        font-weight: 600;
        color: #cbd5e1;
    }
    
    .result-value {
        color: var(--text);
    }
    
    .confidence {
        font-size: 0.7rem;
        color: var(--muted);
        margin-left: 0.5rem;
    }
    
    .confidence.high {
        color: #22c55e;
    }
    
    .confidence.medium {
        color: #eab308;
    }
    
    .confidence.low {
        color: #ef4444;
    }
    
    /* Estilos para im√°genes base64 */
    .image-preview {
        max-width: 100px;
        max-height: 100px;
        border-radius: 4px;
        border: 1px solid #1f2937;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .image-preview:hover {
        transform: scale(1.5);
        z-index: 100;
        position: relative;
    }
    
    .base64-container {
        max-height: 100px;
        overflow: auto;
        background: #0b1220;
        border: 1px solid #1f2937;
        border-radius: 4px;
        padding: 0.25rem;
        font-size: 0.7rem;
        font-family: monospace;
        word-break: break-all;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        max-width: 90%;
        max-height: 90%;
        border-radius: 8px;
    }
    
    .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 2rem;
        height: 2rem;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    .tab-container {
        margin-top: 1rem;
    }
    
    .tab-buttons {
        display: flex;
        border-bottom: 1px solid #1f2937;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .tab-button {
        padding: 0.5rem 1rem;
        background: transparent;
        border: none;
        color: var(--muted);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        white-space: nowrap;
    }
    
    .tab-button.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Estilos para datos parseados */
    .parsed-data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        font-size: 0.8rem;
    }
    
    .parsed-data-table th, .parsed-data-table td {
        padding: 0.25rem 0.5rem;
        border: 1px solid #1f2937;
        text-align: left;
    }
    
    .parsed-data-table th {
        background: #0b1220;
        color: #9ca3af;
        font-weight: 600;
    }
    
    .url-link {
        color: #93c5fd;
        text-decoration: none;
        word-break: break-all;
    }
    
    .url-link:hover {
        text-decoration: underline;
    }
    
    .raw-data {
        background: #0b1220;
        border: 1px solid #1f2937;
        border-radius: 4px;
        padding: 0.5rem;
        font-family: monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 100px;
        overflow: auto;
    }
    
    .code-status {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-weight: 600;
    }
    
    .status-success {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }
    
    .status-error {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }
    
    .status-warning {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    /* Nuevos estilos para el panel de propiedades */
    .properties-panel {
        margin-top: 1rem;
        padding: 1rem;
        border: 1px solid #1f2937;
        border-radius: 8px;
        background-color: #0b1220;
        display: none;
    }
    
    .properties-panel.active {
        display: block;
    }
    
    .properties-panel h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: #cbd5e1;
        font-size: 1rem;
    }
    
    .property-group {
        margin-bottom: 1rem;
    }
    
    .property-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #9ca3af;
        font-size: 0.85rem;
    }
    
    .property-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #1f2937;
        border-radius: 6px;
        background: #0b1220;
        color: var(--text);
        box-sizing: border-box;
    }
    
    .property-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .property-row .property-input {
        flex: 1;
    }
    
    .update-button {
        width: 100%;
        margin-top: 0.5rem;
    }
    
    .no-selection {
        text-align: center;
        color: var(--muted);
        padding: 1rem;
    }
    </style>
</head>
<body>
    <header>
        <h1>Editor de ROIs - DUI El Salvador</h1>
        <p class="lead">Superposici√≥n y edici√≥n de Regiones de Inter√©s para Documento √önico de Identidad</p>
    </header>

    <div class="wrap">
        <div class="grid">
            <div class="card">
                <div class="pad">
                    <h2>Visualizador de ROIs</h2>
                    <p class="muted">Sube una imagen del DUI para visualizar y ajustar las Regiones de Inter√©s</p>
                    
                    <input type="file" id="imageUpload" accept="image/*">
                    
                    <div id="canvasContainer" class="stage">
                        <canvas id="roiCanvas" class="hidden"></canvas>
                        <p id="placeholderText" class="placeholder-text">Sube una imagen para comenzar</p>
                    </div>
                    
                    <div class="image-info">
                        <div id="imageDimensions">Tama√±o: -</div>
                        <div id="imageScale">Escala: 1:1</div>
                    </div>
                    
                    <div class="status-bar">
                        <div class="roi-count" id="roiCount">0 ROIs cargadas</div>
                        <div class="selected-roi" id="selectedRoi">Ninguna ROI seleccionada</div>
                    </div>
                    
                    <div class="controls">
                        <button id="saveButton" class="primary" onclick="saveTemplateToJSON()">üíæ Guardar Plantilla</button>
                        <button id="exportTemplate" onclick="exportTemplate()">üì§ Exportar</button>
                        <button id="importTemplate" onclick="document.getElementById('templateUpload').click()">üì• Importar</button>
                        <input type="file" id="templateUpload" accept=".json" style="display: none;" onchange="importTemplate(event)">
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="pad">
                    <h2>Gesti√≥n de ROIs</h2>
                    <p class="muted">Agregar, eliminar y configurar Regiones de Inter√©s</p>
                    
                    <!-- Panel de propiedades de ROI seleccionada -->
                    <div id="propertiesPanel" class="properties-panel">
                        <h3>Propiedades de ROI</h3>
                        <div id="noSelectionMessage" class="no-selection">
                            Selecciona una ROI para ver y editar sus propiedades
                        </div>
                        <div id="propertiesForm" style="display: none;">
                            <div class="property-group">
                                <label class="property-label">Nombre del campo</label>
                                <input type="text" id="propertyName" class="property-input" placeholder="Nombre del campo">
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Tipo de campo</label>
                                <select id="propertyType" class="property-input">
                                    <option value="data_field">Campo de Datos</option>
                                    <option value="label">Etiqueta</option>
                                    <option value="static_text">Texto Est√°tico</option>
                                    <option value="roi">√Årea de Imagen</option>
                                    <option value="mrz">MRZ</option>
                                    <option value="pdf417">PDF417</option>
                                    <option value="qr">QR Code</option>
                                    <option value="barcode">Barcode</option>
                                    <option value="url">URL</option>
                                </select>
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Contenido</label>
                                <input type="text" id="propertyContent" class="property-input" placeholder="Contenido">
                            </div>
                            
                            <div class="property-group">
                                <label class="property-label">Coordenadas</label>
                                <div class="property-row">
                                    <input type="number" id="propertyX" class="property-input" placeholder="X">
                                    <input type="number" id="propertyY" class="property-input" placeholder="Y">
                                </div>
                                <div class="property-row">
                                    <input type="number" id="propertyWidth" class="property-input" placeholder="Ancho">
                                    <input type="number" id="propertyHeight" class="property-input" placeholder="Alto">
                                </div>
                            </div>
                            
                            <button id="updatePropertiesBtn" class="primary update-button" onclick="updateSelectedROI()">üîÑ Actualizar ROI</button>
                        </div>
                    </div>
                    
                    <div class="add-roi-panel">
                        <h3>Agregar Nueva ROI</h3>
                        <div class="add-roi-form">
                            <select id="roiType">
                                <option value="data_field">Campo de Datos</option>
                                <option value="label">Etiqueta</option>
                                <option value="static_text">Texto Est√°tico</option>
                                <option value="roi">√Årea de Imagen</option>
                                <option value="mrz">MRZ</option>
                                <option value="pdf417">PDF417</option>
                                <option value="qr">QR Code</option>
                                <option value="barcode">Barcode</option>
                                <option value="url">URL</option>
                            </select>
                            <input type="text" id="roiName" placeholder="Nombre del campo">
                            <input type="text" id="roiContent" placeholder="Contenido">
                            <button id="addROIButton" class="primary" onclick="addNewROI()">‚ûï Agregar ROI</button>
                        </div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(239, 68, 68, 0.2); border-color: #ef4444;"></div>
                            <span>Campo de Datos</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(34, 197, 94, 0.2); border-color: #22c55e;"></div>
                            <span>Etiqueta</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(59, 130, 246, 0.2); border-color: #3b82f6;"></div>
                            <span>Texto Est√°tico</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(168, 85, 247, 0.2); border-color: #a855f7;"></div>
                            <span>√Årea de Imagen</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(245, 158, 11, 0.2); border-color: #f59e0b;"></div>
                            <span>MRZ</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(236, 72, 153, 0.2); border-color: #ec4899;"></div>
                            <span>PDF417</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(16, 185, 129, 0.2); border-color: #10b981;"></div>
                            <span>QR Code</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(139, 92, 246, 0.2); border-color: #8b5cf6;"></div>
                            <span>Barcode</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: rgba(6, 182, 212, 0.2); border-color: #06b6d4;"></div>
                            <span>URL</span>
                        </div>
                    </div>
                    
                    <div class="ocr-section">
                        <h3>Extracci√≥n de Datos</h3>
                        <p class="muted">Extrae texto, im√°genes y datos codificados de las ROIs</p>
                        
                        <div class="tab-container">
                            <div class="tab-buttons">
                                <button class="tab-button active" onclick="switchTab('textTab')">üìù Texto</button>
                                <button class="tab-button" onclick="switchTab('imageTab')">üñºÔ∏è Im√°genes</button>
                                <button class="tab-button" onclick="switchTab('codesTab')">üî£ C√≥digos</button>
                                <button class="tab-button" onclick="switchTab('advancedTab')">‚ö° Avanzado</button>
                            </div>
                            
                            <div id="textTab" class="tab-content active">
                                <div class="ocr-controls">
                                    <button id="extractTextBtn" class="primary" onclick="extractTextFromROIs()">üîç Extraer Texto</button>
                                    <button id="clearTextResultsBtn" onclick="clearOCRResults()">üóëÔ∏è Limpiar</button>
                                </div>
                                
                                <div id="ocrProgress" style="display: none;">
                                    <div class="progress-text" id="progressStatus">Procesando...</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="ocr-results">
                                    <h4>Resultados de Texto</h4>
                                    <div id="ocrResultsTable" class="results-table-container">
                                        <table class="results-table">
                                            <thead>
                                                <tr>
                                                    <th>Campo</th>
                                                    <th>Texto Extra√≠do</th>
                                                    <th>Confianza</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ocrResultsBody">
                                                <tr>
                                                    <td colspan="3" style="text-align: center; color: var(--muted);">No hay resultados a√∫n</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="imageTab" class="tab-content">
                                <div class="ocr-controls">
                                    <button id="extractImagesBtn" class="primary" onclick="extractImagesFromROIs()">üì∏ Capturar Im√°genes</button>
                                    <button id="clearImageResultsBtn" onclick="clearImageResults()">üóëÔ∏è Limpiar</button>
                                </div>
                                
                                <div id="imageProgress" style="display: none;">
                                    <div class="progress-text" id="imageProgressStatus">Procesando...</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="imageProgressFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="ocr-results">
                                    <h4>Im√°genes Capturadas</h4>
                                    <div id="imageResultsTable" class="results-table-container">
                                        <table class="results-table">
                                            <thead>
                                                <tr>
                                                    <th>Campo</th>
                                                    <th>Vista Previa</th>
                                                    <th>Tama√±o</th>
                                                    <th>Base64</th>
                                                </tr>
                                            </thead>
                                            <tbody id="imageResultsBody">
                                                <tr>
                                                    <td colspan="4" style="text-align: center; color: var(--muted);">No hay im√°genes capturadas</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="codesTab" class="tab-content">
                                <div class="ocr-controls">
                                    <button id="extractCodesBtn" class="primary" onclick="extractCodesFromROIs()">üîç Extraer C√≥digos</button>
                                    <button id="clearCodesResultsBtn" onclick="clearCodesResults()">üóëÔ∏è Limpiar</button>
                                </div>
                                
                                <div id="codesProgress" style="display: none;">
                                    <div class="progress-text" id="codesProgressStatus">Procesando...</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="codesProgressFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="ocr-results">
                                    <h4>C√≥digos Detectados</h4>
                                    <div id="codesResultsTable" class="results-table-container">
                                        <table class="results-table">
                                            <thead>
                                                <tr>
                                                    <th>Campo</th>
                                                    <th>Tipo</th>
                                                    <th>Datos Extra√≠dos</th>
                                                    <th>Estado</th>
                                                </tr>
                                            </thead>
                                            <tbody id="codesResultsBody">
                                                <tr>
                                                    <td colspan="4" style="text-align: center; color: var(--muted);">No hay c√≥digos detectados</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="advancedTab" class="tab-content">
                                <div class="ocr-controls">
                                    <button id="extractAllBtn" class="primary" onclick="extractAllFromROIs()">üöÄ Extraer Todo</button>
                                    <button id="clearAllResultsBtn" onclick="clearAllResults()">üóëÔ∏è Limpiar Todo</button>
                                </div>
                                
                                <div id="advancedProgress" style="display: none;">
                                    <div class="progress-text" id="advancedProgressStatus">Procesando...</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="advancedProgressFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="ocr-results">
                                    <h4>Datos MRZ y PDF417 Parseados</h4>
                                    <div id="advancedResultsTable" class="results-table-container">
                                        <table class="results-table">
                                            <thead>
                                                <tr>
                                                    <th>Campo</th>
                                                    <th>Tipo</th>
                                                    <th>Datos RAW</th>
                                                    <th>Datos Parseados</th>
                                                </tr>
                                            </thead>
                                            <tbody id="advancedResultsBody">
                                                <tr>
                                                    <td colspan="4" style="text-align: center; color: var(--muted);">No hay datos parseados</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="instructions">
                        <p><strong>Instrucciones:</strong></p>
                        <ul>
                            <li>Haz clic en una ROI para seleccionarla (borde verde)</li>
                            <li>Presiona <strong>Delete</strong> o <strong>Suprimir</strong> para eliminar la ROI seleccionada</li>
                            <li>Arrastra para mover y usa la esquina inferior derecha para redimensionar</li>
                            <li>Usa las pesta√±as para diferentes tipos de extracci√≥n</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para vista ampliada de im√°genes -->
    <div id="imageModal" class="modal">
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <img id="modalImage" class="modal-content" src="" alt="Vista ampliada">
    </div>

    <footer>
        <p class="muted">Herramienta de edici√≥n de ROIs para DUI de El Salvador</p>
    </footer>

    <script>
    // Plantilla JSON Inicial
    let TEMPLATE = {
        template_name: "DUI_El_Salvador",
        metadata: {
            expected_width: 1000,
            expected_height: 600
        },
        regions: []
    };

    let currentScaleX = 1;
    let currentScaleY = 1;
    let canvasTopOffset = 0;
    let canvasLeftOffset = 0;
    let selectedROI = null;
    let selectedROIIndex = -1;
    let ocrResults = {};
    let imageResults = {};
    let codesResults = {};
    let advancedResults = {};

    // Inicializar la aplicaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar el panel de propiedades
        document.getElementById('propertiesPanel').classList.add('active');
    });

    // Agregar event listener para la tecla Delete
    document.addEventListener('keydown', handleKeyDown);

    function handleKeyDown(e) {
        if ((e.key === 'Delete' || e.key === 'Suprimir' || e.keyCode === 46 || e.keyCode === 8) && selectedROIIndex !== -1) {
            e.preventDefault();
            deleteROI(selectedROIIndex);
        }
    }

    document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                displayImageAndDrawROIs(img);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function displayImageAndDrawROIs(img) {
        const canvas = document.getElementById('roiCanvas');
        const container = document.getElementById('canvasContainer');
        const placeholder = document.getElementById('placeholderText');
        const saveButton = document.getElementById('saveButton');
        
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        canvas.style.display = 'block';
        canvas.style.maxWidth = 'none';
        placeholder.style.display = 'none';
        saveButton.style.display = 'block';

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        document.querySelectorAll('.roi-box').forEach(box => box.remove());
        
        const templateWidth = TEMPLATE.metadata.expected_width;
        const templateHeight = TEMPLATE.metadata.expected_height;
        currentScaleX = canvas.width / templateWidth;
        currentScaleY = canvas.height / templateHeight;

        const canvasRect = canvas.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        canvasLeftOffset = canvasRect.left - containerRect.left;
        canvasTopOffset = canvasRect.top - containerRect.top;

        TEMPLATE.regions.forEach((region, index) => {
            createROIBox(region, index);
        });
        
        updateImageInfo(canvas.width, canvas.height);
        updateROICount();
        clearAllResults();
        
        // Deseleccionar cualquier ROI al cargar nueva imagen
        deselectAllROIs();
    }

    function createROIBox(region, index) {
        const { x, y, width, height } = region.coordinates;
        const container = document.getElementById('canvasContainer');

        const scaledX = x * currentScaleX;
        const scaledY = y * currentScaleY;
        const scaledWidth = width * currentScaleX;
        const scaledHeight = height * currentScaleY;
        
        const roiBox = document.createElement('div');
        roiBox.classList.add('roi-box');
        roiBox.dataset.roiIndex = index; 

        let fieldClass = '';
        let labelText = region.field_name;

        switch(region.field_type) {
            case 'data_field': fieldClass = 'data-field-box'; break;
            case 'label': fieldClass = 'label-box'; break;
            case 'static_text': fieldClass = 'static-text-box'; break;
            case 'roi': fieldClass = 'roi-area-box'; break;
            case 'mrz': fieldClass = 'mrz-box'; break;
            case 'pdf417': fieldClass = 'pdf417-box'; break;
            case 'qr': fieldClass = 'qr-box'; break;
            case 'barcode': fieldClass = 'barcode-box'; break;
            case 'url': fieldClass = 'url-box'; break;
            default: fieldClass = 'static-text-box';
        }
        roiBox.classList.add(fieldClass);

        const left = canvasLeftOffset + scaledX;
        const top = canvasTopOffset + scaledY;

        roiBox.style.left = `${left}px`;
        roiBox.style.top = `${top}px`;
        roiBox.style.width = `${scaledWidth}px`;
        roiBox.style.height = `${scaledHeight}px`;

        if (scaledWidth > 50 && scaledHeight > 10) {
            roiBox.textContent = labelText;
        }

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('delete-button');
        deleteButton.innerHTML = '√ó';
        deleteButton.title = 'Eliminar ROI';
        deleteButton.addEventListener('click', function(e) {
            e.stopPropagation();
            deleteROI(index);
        });
        roiBox.appendChild(deleteButton);

        roiBox.addEventListener('mousedown', handleROIAdjust);
        roiBox.addEventListener('click', function(e) {
            e.stopPropagation();
            selectROI(index, roiBox);
        });
        
        new ResizeObserver(handleROIResize).observe(roiBox);
        container.appendChild(roiBox);
    }

    // FUNCI√ìN PARA SELECCIONAR ROI
    function selectROI(index, roiBox) {
        if (selectedROI) {
            selectedROI.classList.remove('selected');
        }
        
        selectedROI = roiBox;
        selectedROIIndex = index;
        roiBox.classList.add('selected');
        
        document.getElementById('selectedRoi').textContent = `Seleccionada: ${TEMPLATE.regions[index].field_name}`;
        
        // Mostrar propiedades de la ROI seleccionada
        showROIProperties(index);
    }

    // FUNCI√ìN PARA MOSTRAR PROPIEDADES DE LA ROI SELECCIONADA
    function showROIProperties(index) {
        const roi = TEMPLATE.regions[index];
        const propertiesPanel = document.getElementById('propertiesPanel');
        const noSelectionMessage = document.getElementById('noSelectionMessage');
        const propertiesForm = document.getElementById('propertiesForm');
        
        // Ocultar mensaje de no selecci√≥n y mostrar formulario
        noSelectionMessage.style.display = 'none';
        propertiesForm.style.display = 'block';
        
        // Llenar formulario con datos de la ROI
        document.getElementById('propertyName').value = roi.field_name;
        document.getElementById('propertyType').value = roi.field_type;
        document.getElementById('propertyContent').value = roi.content || '';
        document.getElementById('propertyX').value = roi.coordinates.x;
        document.getElementById('propertyY').value = roi.coordinates.y;
        document.getElementById('propertyWidth').value = roi.coordinates.width;
        document.getElementById('propertyHeight').value = roi.coordinates.height;
    }

    // FUNCI√ìN PARA ACTUALIZAR ROI SELECCIONADA
    function updateSelectedROI() {
        if (selectedROIIndex === -1) return;
        
        const roi = TEMPLATE.regions[selectedROIIndex];
        const oldName = roi.field_name;
        
        // Obtener nuevos valores del formulario
        const newName = document.getElementById('propertyName').value.trim();
        const newType = document.getElementById('propertyType').value;
        const newContent = document.getElementById('propertyContent').value.trim();
        const newX = parseInt(document.getElementById('propertyX').value);
        const newY = parseInt(document.getElementById('propertyY').value);
        const newWidth = parseInt(document.getElementById('propertyWidth').value);
        const newHeight = parseInt(document.getElementById('propertyHeight').value);
        
        // Validaciones
        if (!newName) {
            alert('El nombre del campo no puede estar vac√≠o');
            return;
        }
        
        // Verificar si el nombre ya existe (excepto para la ROI actual)
        if (newName !== oldName && TEMPLATE.regions.some(region => region.field_name === newName)) {
            alert('Ya existe una ROI con ese nombre. Por favor, use un nombre √∫nico.');
            return;
        }
        
        // Actualizar propiedades de la ROI
        roi.field_name = newName;
        roi.field_type = newType;
        roi.content = newContent;
        roi.coordinates.x = newX;
        roi.coordinates.y = newY;
        roi.coordinates.width = newWidth;
        roi.coordinates.height = newHeight;
        
        // Actualizar data_type seg√∫n el tipo de campo
        if (['roi', 'mrz', 'pdf417', 'qr', 'barcode', 'url'].includes(newType)) {
            roi.data_type = 'image';
        } else {
            roi.data_type = 'text';
        }
        
        // Actualizar visualizaci√≥n
        const canvas = document.getElementById('roiCanvas');
        if (canvas.style.display !== 'none') {
            const img = new Image();
            img.onload = function() {
                displayImageAndDrawROIs(img);
                // Reseleccionar la ROI actualizada
                const updatedROIBox = document.querySelector(`.roi-box[data-roi-index="${selectedROIIndex}"]`);
                if (updatedROIBox) {
                    selectROI(selectedROIIndex, updatedROIBox);
                }
            };
            img.src = canvas.toDataURL();
        }
        
        // Actualizar informaci√≥n en la interfaz
        document.getElementById('selectedRoi').textContent = `Seleccionada: ${newName}`;
        
        alert(`ROI "${oldName}" actualizada exitosamente.`);
    }

    // FUNCI√ìN PARA DESELECCIONAR TODAS LAS ROIs
    function deselectAllROIs() {
        if (selectedROI) {
            selectedROI.classList.remove('selected');
            selectedROI = null;
            selectedROIIndex = -1;
            document.getElementById('selectedRoi').textContent = 'Ninguna ROI seleccionada';
            
            // Ocultar formulario y mostrar mensaje de no selecci√≥n
            document.getElementById('noSelectionMessage').style.display = 'block';
            document.getElementById('propertiesForm').style.display = 'none';
        }
    }

    // Evento para deseleccionar al hacer clic fuera de las ROIs
    document.getElementById('canvasContainer').addEventListener('click', function(e) {
        if (e.target === this) {
            deselectAllROIs();
        }
    });

    let startX, startY, startLeft, startTop;

    // FUNCI√ìN PARA REDIMENSIONAR (Manejada por el navegador, pero necesitamos capturar el final)
    function handleROIResize(entries) {
        entries.forEach(entry => {
            const roiBox = entry.target;
            if (!selectedROI) {
                updateTemplateCoordinates(roiBox);
            }
        });
    }

    // FUNCI√ìN PARA MOVER (Arrastrar)
    function handleROIAdjust(e) {
        if (e.target !== e.currentTarget || e.offsetX > e.target.offsetWidth - 15 && e.offsetY > e.target.offsetHeight - 15) {
            return; 
        }

        selectedROI = e.currentTarget;
        selectedROIIndex = parseInt(selectedROI.dataset.roiIndex);
        selectedROI.classList.add('resizing');
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseFloat(selectedROI.style.left);
        startTop = parseFloat(selectedROI.style.top);

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    }

    function handleMouseMove(e) {
        if (!selectedROI) return;

        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        selectedROI.style.left = `${startLeft + dx}px`;
        selectedROI.style.top = `${startTop + dy}px`;
    }

    function handleMouseUp(e) {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        
        if (selectedROI) {
            selectedROI.classList.remove('resizing');
            updateTemplateCoordinates(selectedROI);
        }
    }

    // **FUNCI√ìN CLAVE: Desescalar y actualizar el objeto TEMPLATE**
    function updateTemplateCoordinates(roiBox) {
        const roiIndex = parseInt(roiBox.dataset.roiIndex);
        if (isNaN(roiIndex) || roiIndex < 0) return;

        const scaledX = parseFloat(roiBox.style.left) - canvasLeftOffset;
        const scaledY = parseFloat(roiBox.style.top) - canvasTopOffset;
        const scaledWidth = roiBox.offsetWidth;
        const scaledHeight = roiBox.offsetHeight;

        const templateX = Math.round(scaledX / currentScaleX);
        const templateY = Math.round(scaledY / currentScaleY);
        const templateWidth = Math.round(scaledWidth / currentScaleX);
        const templateHeight = Math.round(scaledHeight / currentScaleY);

        TEMPLATE.regions[roiIndex].coordinates.x = templateX;
        TEMPLATE.regions[roiIndex].coordinates.y = templateY;
        TEMPLATE.regions[roiIndex].coordinates.width = templateWidth;
        TEMPLATE.regions[roiIndex].coordinates.height = templateHeight;
    }

    // FUNCI√ìN PARA ACTUALIZAR INFORMACI√ìN DE LA IMAGEN
    function updateImageInfo(width, height) {
        document.getElementById('imageDimensions').textContent = `Tama√±o: ${width} √ó ${height} px`;
        document.getElementById('imageScale').textContent = `Escala: ${currentScaleX.toFixed(2)}:1`;
    }

    // FUNCI√ìN PARA ACTUALIZAR CONTADOR DE ROIs
    function updateROICount() {
        const roiCount = TEMPLATE.regions.length;
        document.getElementById('roiCount').textContent = `${roiCount} ROIs cargadas`;
    }

    // FUNCI√ìN PARA ELIMINAR ROI
    function deleteROI(index) {
        if (confirm(`¬øEst√° seguro de que desea eliminar la ROI "${TEMPLATE.regions[index].field_name}"?`)) {
            TEMPLATE.regions.splice(index, 1);
            
            deselectAllROIs();
            
            const canvas = document.getElementById('roiCanvas');
            if (canvas.style.display !== 'none') {
                const img = new Image();
                img.onload = function() {
                    displayImageAndDrawROIs(img);
                };
                img.src = canvas.toDataURL();
            }
            
            updateROICount();
        }
    }

    // FUNCI√ìN PARA AGREGAR NUEVA ROI
    function addNewROI() {
        const roiType = document.getElementById('roiType').value;
        const roiName = document.getElementById('roiName').value.trim();
        const roiContent = document.getElementById('roiContent').value.trim();
        
        if (!roiName) {
            alert('Por favor, ingrese un nombre para la ROI');
            return;
        }
        
        if (TEMPLATE.regions.some(region => region.field_name === roiName)) {
            alert('Ya existe una ROI con ese nombre. Por favor, use un nombre √∫nico.');
            return;
        }
        
        const newROI = {
            field_name: roiName,
            field_type: roiType,
            content: roiContent || roiName,
            coordinates: {
                x: 50,
                y: 50,
                width: 100,
                height: 30
            },
            data_type: ['roi', 'mrz', 'pdf417', 'qr', 'barcode', 'url'].includes(roiType) ? 'image' : 'text'
        };
        
        TEMPLATE.regions.push(newROI);
        
        const canvas = document.getElementById('roiCanvas');
        if (canvas.style.display !== 'none') {
            const img = new Image();
            img.onload = function() {
                displayImageAndDrawROIs(img);
            };
            img.src = canvas.toDataURL();
        }
        
        updateROICount();
        
        document.getElementById('roiName').value = '';
        document.getElementById('roiContent').value = '';
        
        alert(`ROI "${roiName}" agregada exitosamente.`);
    }

    // FUNCI√ìN PARA IMPORTAR PLANTILLA
    function importTemplate(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedTemplate = JSON.parse(e.target.result);
                
                if (!importedTemplate.template_name || !importedTemplate.regions || !importedTemplate.metadata) {
                    throw new Error('El archivo no tiene la estructura correcta de plantilla');
                }
                
                TEMPLATE = importedTemplate;
                
                deselectAllROIs();
                
                const canvas = document.getElementById('roiCanvas');
                if (canvas.style.display !== 'none') {
                    const img = new Image();
                    img.onload = function() {
                        displayImageAndDrawROIs(img);
                    };
                    img.src = canvas.toDataURL();
                }
                
                updateROICount();
                
                alert('Plantilla importada exitosamente');
            } catch (error) {
                alert('Error al importar la plantilla: ' + error.message);
            }
        };
        reader.readAsText(file);
        
        event.target.value = '';
    }

    // FUNCI√ìN PARA EXPORTAR PLANTILLA
    function exportTemplate() {
        const json = JSON.stringify(TEMPLATE, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${TEMPLATE.template_name}_template.json`;
        link.click();
    }

    function saveTemplateToJSON() {
        const json = JSON.stringify(TEMPLATE, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'adjusted_salvador_id_card_template.json';
        link.click();
        alert('Plantilla guardada como adjusted_salvador_id_card_template.json');
    }

    // FUNCIONES PARA TABS
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    // FUNCIONES PARA OCR DE TEXTO
    async function extractTextFromROIs() {
        const canvas = document.getElementById('roiCanvas');
        if (canvas.style.display === 'none') {
            alert('Por favor, carga una imagen primero');
            return;
        }

        const textROIs = TEMPLATE.regions.filter(region => 
            region.field_type === 'data_field' && region.data_type === 'text'
        );

        if (textROIs.length === 0) {
            alert('No hay ROIs de tipo datos (data_field) con data_type text para procesar');
            return;
        }

        const progressDiv = document.getElementById('ocrProgress');
        const progressFill = document.getElementById('progressFill');
        const progressStatus = document.getElementById('progressStatus');
        progressDiv.style.display = 'block';
        
        clearOCRResults();
        ocrResults = {};

        for (let i = 0; i < textROIs.length; i++) {
            const roi = textROIs[i];
            const progress = ((i / textROIs.length) * 100).toFixed(0);
            
            progressFill.style.width = `${progress}%`;
            progressStatus.textContent = `Procesando ${roi.field_name}... (${i + 1}/${textROIs.length})`;

            try {
                const result = await processROIWithOCR(canvas, roi);
                ocrResults[roi.field_name] = result;
                updateOCRResultsTable();
                
            } catch (error) {
                console.error(`Error procesando ROI ${roi.field_name}:`, error);
                ocrResults[roi.field_name] = {
                    text: 'Error en procesamiento',
                    confidence: 0
                };
            }
        }

        progressFill.style.width = '100%';
        progressStatus.textContent = `Procesamiento completado (${textROIs.length} ROIs)`;

        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);

        alert(`Extracci√≥n de texto completada. Se procesaron ${textROIs.length} ROIs.`);
    }

    async function processROIWithOCR(canvas, roi) {
        const { x, y, width, height } = roi.coordinates;
        
        const scaledX = x * currentScaleX;
        const scaledY = y * currentScaleY;
        const scaledWidth = width * currentScaleX;
        const scaledHeight = height * currentScaleY;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = scaledWidth;
        tempCanvas.height = scaledHeight;
        const tempCtx = tempCanvas.getContext('2d');

        tempCtx.drawImage(
            canvas,
            scaledX, scaledY, scaledWidth, scaledHeight,
            0, 0, scaledWidth, scaledHeight
        );

        const { data } = await Tesseract.recognize(
            tempCanvas,
            'spa',
            {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        // Progreso detallado
                    }
                }
            }
        );

        return {
            text: data.text.trim(),
            confidence: data.confidence
        };
    }

    function updateOCRResultsTable() {
        const tbody = document.getElementById('ocrResultsBody');
        tbody.innerHTML = '';

        if (Object.keys(ocrResults).length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--muted);">No hay resultados a√∫n</td></tr>';
            return;
        }

        for (const [fieldName, result] of Object.entries(ocrResults)) {
            const row = document.createElement('tr');
            
            let confidenceClass = 'confidence';
            if (result.confidence >= 80) confidenceClass += ' high';
            else if (result.confidence >= 60) confidenceClass += ' medium';
            else confidenceClass += ' low';

            row.innerHTML = `
                <td>${fieldName}</td>
                <td>${result.text || 'No se detect√≥ texto'}</td>
                <td><span class="${confidenceClass}">${result.confidence.toFixed(1)}%</span></td>
            `;
            
            tbody.appendChild(row);
        }
    }

    function clearOCRResults() {
        ocrResults = {};
        updateOCRResultsTable();
    }

    // FUNCIONES PARA CAPTURA DE IM√ÅGENES
    async function extractImagesFromROIs() {
        const canvas = document.getElementById('roiCanvas');
        if (canvas.style.display === 'none') {
            alert('Por favor, carga una imagen primero');
            return;
        }

        const imageROIs = TEMPLATE.regions.filter(region => 
            region.data_type === 'image'
        );

        if (imageROIs.length === 0) {
            alert('No hay ROIs de tipo imagen para capturar');
            return;
        }

        const progressDiv = document.getElementById('imageProgress');
        const progressFill = document.getElementById('imageProgressFill');
        const progressStatus = document.getElementById('imageProgressStatus');
        progressDiv.style.display = 'block';
        
        clearImageResults();
        imageResults = {};

        for (let i = 0; i < imageROIs.length; i++) {
            const roi = imageROIs[i];
            const progress = ((i / imageROIs.length) * 100).toFixed(0);
            
            progressFill.style.width = `${progress}%`;
            progressStatus.textContent = `Capturando ${roi.field_name}... (${i + 1}/${imageROIs.length})`;

            try {
                const result = await captureROIImage(canvas, roi);
                imageResults[roi.field_name] = result;
                updateImageResultsTable();
                
            } catch (error) {
                console.error(`Error capturando ROI ${roi.field_name}:`, error);
                imageResults[roi.field_name] = {
                    base64: 'Error en captura',
                    size: '0 KB'
                };
            }
        }

        progressFill.style.width = '100%';
        progressStatus.textContent = `Captura completada (${imageROIs.length} im√°genes)`;

        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);

        alert(`Captura de im√°genes completada. Se procesaron ${imageROIs.length} ROIs.`);
    }

    function captureROIImage(canvas, roi) {
        const { x, y, width, height } = roi.coordinates;
        
        const scaledX = x * currentScaleX;
        const scaledY = y * currentScaleY;
        const scaledWidth = width * currentScaleX;
        const scaledHeight = height * currentScaleY;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = scaledWidth;
        tempCanvas.height = scaledHeight;
        const tempCtx = tempCanvas.getContext('2d');

        tempCtx.drawImage(
            canvas,
            scaledX, scaledY, scaledWidth, scaledHeight,
            0, 0, scaledWidth, scaledHeight
        );

        const base64 = tempCanvas.toDataURL('image/png');
        const size = Math.round((base64.length * 3) / 4) / 1024;

        return {
            base64: base64,
            size: `${size.toFixed(1)} KB`,
            preview: base64
        };
    }

    function updateImageResultsTable() {
        const tbody = document.getElementById('imageResultsBody');
        tbody.innerHTML = '';

        if (Object.keys(imageResults).length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">No hay im√°genes capturadas</td></tr>';
            return;
        }

        for (const [fieldName, result] of Object.entries(imageResults)) {
            const row = document.createElement('tr');
            
            const previewHtml = result.preview && result.preview !== 'Error en captura' 
                ? `<img src="${result.preview}" class="image-preview" onclick="openModal('${result.preview}')" alt="${fieldName}">`
                : 'Error';

            const shortBase64 = result.base64 && result.base64 !== 'Error en captura'
                ? result.base64.substring(0, 50) + '...'
                : 'Error';

            row.innerHTML = `
                <td>${fieldName}</td>
                <td>${previewHtml}</td>
                <td>${result.size}</td>
                <td>
                    <div class="base64-container" title="Haz clic para copiar" onclick="copyToClipboard('${fieldName}')">
                        ${shortBase64}
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        }
    }

    function clearImageResults() {
        imageResults = {};
        updateImageResultsTable();
    }

    // FUNCIONES PARA EXTRACCI√ìN DE C√ìDIGOS
    async function extractCodesFromROIs() {
        const canvas = document.getElementById('roiCanvas');
        if (canvas.style.display === 'none') {
            alert('Por favor, carga una imagen primero');
            return;
        }

        const codeROIs = TEMPLATE.regions.filter(region => 
            ['qr', 'barcode', 'url'].includes(region.field_type)
        );

        if (codeROIs.length === 0) {
            alert('No hay ROIs de tipo QR, Barcode o URL para procesar');
            return;
        }

        const progressDiv = document.getElementById('codesProgress');
        const progressFill = document.getElementById('codesProgressFill');
        const progressStatus = document.getElementById('codesProgressStatus');
        progressDiv.style.display = 'block';
        
        clearCodesResults();
        codesResults = {};

        for (let i = 0; i < codeROIs.length; i++) {
            const roi = codeROIs[i];
            const progress = ((i / codeROIs.length) * 100).toFixed(0);
            
            progressFill.style.width = `${progress}%`;
            progressStatus.textContent = `Procesando ${roi.field_name}... (${i + 1}/${codeROIs.length})`;

            try {
                let result;
                switch(roi.field_type) {
                    case 'qr':
                        result = await processQRCode(canvas, roi);
                        break;
                    case 'barcode':
                        result = await processBarcode(canvas, roi);
                        break;
                    case 'url':
                        result = await processURL(canvas, roi);
                        break;
                }
                codesResults[roi.field_name] = result;
                updateCodesResultsTable();
                
            } catch (error) {
                console.error(`Error procesando ROI ${roi.field_name}:`, error);
                codesResults[roi.field_name] = {
                    data: 'Error en procesamiento',
                    status: 'Error',
                    type: roi.field_type.toUpperCase()
                };
            }
        }

        progressFill.style.width = '100%';
        progressStatus.textContent = `Procesamiento completado (${codeROIs.length} c√≥digos)`;

        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);
    }

    async function processQRCode(canvas, roi) {
        const imageData = getROIImageData(canvas, roi);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        
        if (code) {
            return {
                data: code.data,
                status: 'status-success',
                statusText: '‚úÖ Detectado',
                type: 'QR Code'
            };
        } else {
            return {
                data: 'No se detect√≥ c√≥digo QR',
                status: 'status-error',
                statusText: '‚ùå No detectado',
                type: 'QR Code'
            };
        }
    }

    async function processBarcode(canvas, roi) {
        return new Promise((resolve) => {
            try {
                // Simulaci√≥n de decodificaci√≥n de c√≥digo de barras
                const simulatedData = "123456789012";
                resolve({
                    data: simulatedData,
                    status: 'status-success',
                    statusText: '‚úÖ Detectado',
                    type: 'Barcode'
                });
            } catch (error) {
                resolve({
                    data: 'Error en decodificaci√≥n',
                    status: 'status-error',
                    statusText: '‚ùå Error',
                    type: 'Barcode'
                });
            }
        });
    }

    async function processURL(canvas, roi) {
        const textResult = await processROIWithOCR(canvas, roi);
        let urlText = textResult.text.trim();
        
        if (urlText && !urlText.startsWith('http')) {
            if (urlText.includes('.') && !urlText.includes(' ')) {
                urlText = 'https://' + urlText;
            }
        }
        
        const isValidUrl = urlText.startsWith('http');
        
        return {
            data: urlText,
            status: isValidUrl ? 'status-success' : 'status-warning',
            statusText: isValidUrl ? '‚úÖ URL v√°lida' : '‚ö†Ô∏è Texto convertido',
            type: 'URL',
            formattedUrl: isValidUrl ? urlText : null
        };
    }

    // FUNCIONES PARA PROCESAMIENTO AVANZADO (MRZ y PDF417)
    async function extractAllFromROIs() {
        const canvas = document.getElementById('roiCanvas');
        if (canvas.style.display === 'none') {
            alert('Por favor, carga una imagen primero');
            return;
        }

        const advancedROIs = TEMPLATE.regions.filter(region => 
            ['mrz', 'pdf417'].includes(region.field_type)
        );

        if (advancedROIs.length === 0) {
            alert('No hay ROIs de tipo MRZ o PDF417 para procesar');
            return;
        }

        const progressDiv = document.getElementById('advancedProgress');
        const progressFill = document.getElementById('advancedProgressFill');
        const progressStatus = document.getElementById('advancedProgressStatus');
        progressDiv.style.display = 'block';
        
        clearAdvancedResults();
        advancedResults = {};

        for (let i = 0; i < advancedROIs.length; i++) {
            const roi = advancedROIs[i];
            const progress = ((i / advancedROIs.length) * 100).toFixed(0);
            
            progressFill.style.width = `${progress}%`;
            progressStatus.textContent = `Procesando ${roi.field_name}... (${i + 1}/${advancedROIs.length})`;

            try {
                let result;
                switch(roi.field_type) {
                    case 'mrz':
                        result = await processMRZ(canvas, roi);
                        break;
                    case 'pdf417':
                        result = await processPDF417(canvas, roi);
                        break;
                }
                advancedResults[roi.field_name] = result;
                updateAdvancedResultsTable();
                
            } catch (error) {
                console.error(`Error procesando ROI ${roi.field_name}:`, error);
                advancedResults[roi.field_name] = {
                    rawData: 'Error en procesamiento',
                    parsedData: {},
                    type: roi.field_type.toUpperCase()
                };
            }
        }

        progressFill.style.width = '100%';
        progressStatus.textContent = `Procesamiento completado (${advancedROIs.length} elementos)`;

        setTimeout(() => {
            progressDiv.style.display = 'none';
        }, 2000);
    }

    async function processMRZ(canvas, roi) {
        const textResult = await processROIWithOCR(canvas, roi);
        const rawText = textResult.text;
        const parsedData = parseMRZ(rawText);
        
        return {
            rawData: rawText,
            parsedData: parsedData,
            type: 'MRZ',
            base64: await captureROIImageBase64(canvas, roi)
        };
    }

    async function processPDF417(canvas, roi) {
        const base64 = await captureROIImageBase64(canvas, roi);
        const decodedData = simulatePDF417Decoding();
        
        return {
            rawData: decodedData.raw,
            parsedData: decodedData.parsed,
            type: 'PDF417',
            base64: base64
        };
    }

    // FUNCIONES DE PARSEO
    function parseMRZ(mrzText) {
        const lines = mrzText.split('\n').filter(line => line.trim().length > 0);
        const parsed = {};
        
        if (lines.length >= 2) {
            const line1 = lines[0];
            if (line1.length >= 30) {
                parsed.documentType = line1.substring(0, 2);
                parsed.issuingCountry = line1.substring(2, 5);
                parsed.documentNumber = line1.substring(5, 14);
                parsed.optionalData = line1.substring(15, 30);
            }
            
            const line2 = lines[1];
            if (line2.length >= 30) {
                parsed.birthDate = parseMRZDate(line2.substring(0, 6));
                parsed.sex = line2.substring(7, 8);
                parsed.expirationDate = parseMRZDate(line2.substring(8, 14));
                parsed.nationality = line2.substring(15, 18);
                parsed.optionalData2 = line2.substring(18, 29);
            }
        }
        
        return parsed;
    }

    function parseMRZDate(mrzDate) {
        if (mrzDate.length === 6) {
            const year = parseInt(mrzDate.substring(0, 2));
            const month = parseInt(mrzDate.substring(2, 4));
            const day = parseInt(mrzDate.substring(4, 6));
            return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/20${year.toString().padStart(2, '0')}`;
        }
        return mrzDate;
    }

    function simulatePDF417Decoding() {
        return {
            raw: "PDF417 Raw Data Simulation - Documento de Identificaci√≥n Salvadore√±o",
            parsed: {
                documentType: "DUI",
                issuingCountry: "SLV",
                documentNumber: "123456789012",
                holderName: "JUAN CARLOS PEREZ GARCIA",
                birthDate: "15/05/1985",
                expirationDate: "15/05/2030",
                nationality: "SALVADORE√ëO",
                issueDate: "15/05/2020"
            }
        };
    }

    // FUNCIONES AUXILIARES
    function getROIImageData(canvas, roi) {
        const { x, y, width, height } = roi.coordinates;
        const scaledX = x * currentScaleX;
        const scaledY = y * currentScaleY;
        const scaledWidth = width * currentScaleX;
        const scaledHeight = height * currentScaleY;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = scaledWidth;
        tempCanvas.height = scaledHeight;
        const tempCtx = tempCanvas.getContext('2d');

        tempCtx.drawImage(
            canvas,
            scaledX, scaledY, scaledWidth, scaledHeight,
            0, 0, scaledWidth, scaledHeight
        );

        return tempCtx.getImageData(0, 0, scaledWidth, scaledHeight);
    }

    async function captureROIImageBase64(canvas, roi) {
        const { x, y, width, height } = roi.coordinates;
        const scaledX = x * currentScaleX;
        const scaledY = y * currentScaleY;
        const scaledWidth = width * currentScaleX;
        const scaledHeight = height * currentScaleY;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = scaledWidth;
        tempCanvas.height = scaledHeight;
        const tempCtx = tempCanvas.getContext('2d');

        tempCtx.drawImage(
            canvas,
            scaledX, scaledY, scaledWidth, scaledHeight,
            0, 0, scaledWidth, scaledHeight
        );

        return tempCanvas.toDataURL('image/png');
    }

    // FUNCIONES DE ACTUALIZACI√ìN DE TABLAS
    function updateCodesResultsTable() {
        const tbody = document.getElementById('codesResultsBody');
        tbody.innerHTML = '';

        if (Object.keys(codesResults).length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">No hay c√≥digos detectados</td></tr>';
            return;
        }

        for (const [fieldName, result] of Object.entries(codesResults)) {
            const row = document.createElement('tr');
            
            let dataDisplay = result.data;
            if (result.formattedUrl) {
                dataDisplay = `<a href="${result.formattedUrl}" class="url-link" target="_blank">${result.formattedUrl}</a>`;
            }
            
            row.innerHTML = `
                <td>${fieldName}</td>
                <td>${result.type}</td>
                <td>${dataDisplay}</td>
                <td><span class="code-status ${result.status}">${result.statusText}</span></td>
            `;
            
            tbody.appendChild(row);
        }
    }

    function updateAdvancedResultsTable() {
        const tbody = document.getElementById('advancedResultsBody');
        tbody.innerHTML = '';

        if (Object.keys(advancedResults).length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">No hay datos parseados</td></tr>';
            return;
        }

        for (const [fieldName, result] of Object.entries(advancedResults)) {
            const row = document.createElement('tr');
            
            const parsedDataHtml = Object.entries(result.parsedData)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
            
            row.innerHTML = `
                <td>${fieldName}</td>
                <td>${result.type}</td>
                <td><div class="raw-data">${result.rawData}</div></td>
                <td>${parsedDataHtml || 'No se pudieron parsear datos'}</td>
            `;
            
            tbody.appendChild(row);
        }
    }

    function clearCodesResults() {
        codesResults = {};
        updateCodesResultsTable();
    }

    function clearAdvancedResults() {
        advancedResults = {};
        updateAdvancedResultsTable();
    }

    function clearAllResults() {
        clearOCRResults();
        clearImageResults();
        clearCodesResults();
        clearAdvancedResults();
    }

    // FUNCIONES PARA MODAL Y UTILIDADES
    function openModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageSrc;
        modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
    }

    function copyToClipboard(fieldName) {
        const base64 = imageResults[fieldName]?.base64;
        if (base64 && base64 !== 'Error en captura') {
            navigator.clipboard.writeText(base64).then(() => {
                alert(`Base64 de ${fieldName} copiado al portapapeles`);
            }).catch(err => {
                console.error('Error al copiar: ', err);
                alert('Error al copiar al portapapeles');
            });
        }
    }

    // Cerrar modal al hacer clic fuera de la imagen
    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    </script>
</body>
</html>
