<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DocMapper DUI (Back/Front) · PDF417 · MRZ · OCR</title>
<!-- ZXing UMD (PDF417) -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/umd/index.min.js"></script>
<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
<style>
  :root{
    color-scheme: dark;
    --bg:#0b0f14; --panel:#111827; --muted:#94a3b8;
    --ink:#e5e7eb; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --roi:#10b981; --roi-sel:#60a5fa; --roi-handle:#eab308;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    background:linear-gradient(180deg,#07090d 0%, #0b1220 100%); color:var(--ink);
  }
  header,footer{padding:10px 16px;background:transparent}
  header h1{font-size:18px;margin:8px 0 12px 0;color:#cbd5e1}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .bar .group{
    background:var(--panel); padding:8px; border-radius:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center
  }
  label{font-size:12px; color:var(--muted)}
  input[type="file"], select, input[type="text"], textarea, button{
    background:#0f172a; color:var(--ink); border:1px solid #1f2937; border-radius:10px; padding:8px 10px; font-size:13px
  }
  button{cursor:pointer}
  button.primary{background:#0b3b22; border-color:#134e4a}
  button.primary:hover{background:#0e4a2a}
  button.warn{background:#3a2a0a; border-color:#7c5800}
  button.danger{background:#3a0a0a; border-color:#7c1f1f}
  #work{
    display:grid; grid-template-columns: 1fr 360px; gap:12px; padding:12px;
  }
  #canvasWrap{
    background:#0b1320; border:1px solid #1f2937; border-radius:14px; padding:12px;
    overflow:auto; max-height:72vh;
  }
  #stage{
    position:relative; /* image size defines area */
    image-rendering:auto; /* keep quality */
    margin:auto;
  }
  #doc{
    display:block; max-width:none; height:auto; user-select:none; -webkit-user-drag:none;
    visibility:hidden;
  }
  .roi{
    position:absolute; border:2px solid var(--roi); border-radius:8px; box-shadow:0 0 0 1px rgba(16,185,129,.3) inset;
    background:rgba(16,185,129,.06);
    cursor:move;
  }
  .roi[data-type="mrz"]{border-color:#f97316; background:rgba(249,115,22,.06)}
  .roi[data-type="pdf417"]{border-color:#22c55e; background:rgba(34,197,94,.06)}
  .roi.selected{outline:2px solid var(--roi-sel); box-shadow:0 0 0 1px rgba(96,165,250,.5)}
  .handle{
    position:absolute; width:12px; height:12px; background:var(--roi-handle); border:2px solid #111; border-radius:50%;
  }
  .handle.nw{left:-7px; top:-7px} .handle.ne{right:-7px; top:-7px}
  .handle.sw{left:-7px; bottom:-7px} .handle.se{right:-7px; bottom:-7px}
  #side{
    background:var(--panel); border:1px solid #1f2937; border-radius:14px; padding:12px; overflow:auto; max-height:72vh;
  }
  #side h3{margin:6px 0 8px 0; font-size:14px; color:#e2e8f0}
  table{width:100%; border-collapse:collapse; font-size:12px}
  th,td{border-bottom:1px dashed #334155; padding:6px; vertical-align:top}
  th{color:#cbd5e1; text-align:left}
  code.small{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11px; color:#a7f3d0}
  .small{font-size:11px; color:var(--muted)}
  .row{display:flex; gap:8px; align-items:center}
  #jsonOut{width:100%; height:160px}
  a.badge{
    font-size:10px; padding:3px 7px; border:1px solid #334155; border-radius:999px; text-decoration:none; color:#cbd5e1
  }
</style>
</head>
<body>
<header>
  <h1>DocMapper DUI · PDF417 · MRZ · OCR (Dark)</h1>
  <div class="bar">
    <div class="group">
      <label>Imagen</label>
      <input id="fileImg" type="file" accept="image/*"/>
      <button id="btnFit" title="Ajustar scroll al ancho de imagen">Centrar</button>
    </div>
    <div class="group">
      <label>Acción</label>
      <button id="btnDraw" class="primary">Dibujar ROI</button>
      <button id="btnSelect">Seleccionar/Editar</button>
      <select id="roiType">
        <option value="text">Texto (OCR)</option>
        <option value="pdf417">PDF417</option>
        <option value="mrz">MRZ</option>
      </select>
      <input id="roiName" type="text" placeholder="Nombre del campo (Address, City, ...)" style="min-width:240px"/>
      <button id="btnAdd">Añadir ROI vacío</button>
    </div>
    <div class="group">
      <label>Plantilla</label>
      <input id="fileTpl" type="file" accept="application/json"/>
      <button id="btnImport">Importar JSON</button>
      <button id="btnExport" class="warn">Exportar JSON</button>
      <button id="btnClear" class="danger">Limpiar ROIs</button>
    </div>
    <div class="group">
      <label>Extracción</label>
      <select id="ocrLang" title="Idioma OCR Tesseract">
        <option value="eng" selected>Inglés (eng)</option>
        <option value="spa">Español (spa)</option>
        <option value="fra">Francés (fra)</option>
        <option value="ita">Italiano (ita)</option>
      </select>
      <button id="btnExtract" class="primary">Extraer Todo</button>
    </div>
  </div>
</header>

<div id="work">
  <div id="canvasWrap">
    <div id="stage">
      <img id="doc" alt="Documento"/>
    </div>
    <div class="small" style="margin-top:8px">
      Consejo: <em>Zoom del navegador</em> no afecta el cálculo; las coordenadas se guardan relativas a la imagen original (0–1).
    </div>
  </div>
  <aside id="side">
    <h3>ROIs (click para seleccionar)</h3>
    <div id="roiList" class="small">Sin ROIs…</div>
    <h3 style="margin-top:14px">JSON de Plantilla</h3>
    <textarea id="jsonOut" spellcheck="false" placeholder='{"template_name":"...","regions":[...]}'></textarea>
    <div class="row" style="justify-content:space-between;margin:8px 0 12px 0">
      <span class="small">Las coordenadas se guardan en <code class="small">rel: {x,y,w,h}</code>.</span>
      <a id="dlJson" class="badge" href="#" download="template.json" style="display:none">Descargar</a>
    </div>
    <h3>Resultados</h3>
    <table id="tbl">
      <thead><tr>
        <th>#</th><th>Campo</th><th>Tipo</th><th>Valor / Mensaje</th><th>ROI (base64)</th>
      </tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </aside>
</div>

<footer class="small">
  Hecho para DUI (frente/dorso) con soporte de códigos <strong>PDF417</strong>, <strong>MRZ</strong> y <strong>OCR</strong> tradicional.
</footer>

<script>
/* -------------------- Estado & utilidades -------------------- */
const $ = sel => document.querySelector(sel);
const stage = $('#stage');
const img = $('#doc');
let mode = 'draw';           // 'draw' | 'select'
let rois = [];               // {id,name,type,abs:{x,y,w,h},rel:{x,y,w,h},el,handles}
let selected = null;         // roi obj

function uuid(){ return 'r'+Math.random().toString(36).slice(2,9) }

function naturalRect(){
  return { x:0, y:0, w:img.naturalWidth, h:img.naturalHeight };
}
function relFromAbs(abs){
  const R = naturalRect();
  return { x: abs.x/R.w, y: abs.y/R.h, w: abs.w/R.w, h: abs.h/R.h };
}
function absFromRel(rel){
  const R = naturalRect();
  return { x: Math.round(rel.x*R.w), y: Math.round(rel.y*R.h),
           w: Math.round(rel.w*R.w), h: Math.round(rel.h*R.h) };
}

function ensureImageLoaded(){
  if(!img.src || img.style.visibility!=='visible') throw new Error('Primero carga una imagen.');
}

/* -------------------- Carga de imagen -------------------- */
document.addEventListener('DOMContentLoaded', () => {
  $('#btnDraw').classList.add('primary');
  $('#fileImg').addEventListener('change', onPickImage);
  $('#btnFit').addEventListener('click', () => stage.scrollIntoView({behavior:'smooth',block:'center'}));
  $('#btnDraw').addEventListener('click', ()=>{ mode='draw'; $('#btnDraw').classList.add('primary'); $('#btnSelect').classList.remove('primary') });
  $('#btnSelect').addEventListener('click', ()=>{ mode='select'; $('#btnSelect').classList.add('primary'); $('#btnDraw').classList.remove('primary') });
  $('#btnAdd').addEventListener('click', addEmptyROI);
  $('#btnExport').addEventListener('click', exportTemplate);
  $('#btnImport').addEventListener('click', importTemplateFromFile);
  $('#fileTpl').addEventListener('change', () => {/* noop (file read in button) */});
  $('#btnClear').addEventListener('click', clearROIs);
  $('#btnExtract').addEventListener('click', extractAll);
  stage.addEventListener('pointerdown', stagePointerDown);
});

function onPickImage(e){
  const file = e.target.files?.[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  img.onload = () => {
    // Ajustar contenedor al tamaño natural
    stage.style.width = img.naturalWidth+'px';
    stage.style.height = img.naturalHeight+'px';
    img.style.visibility = 'visible';
  };
  img.src = url;
}

/* -------------------- Crear/Editar ROIs -------------------- */
function addEmptyROI(){
  try{ ensureImageLoaded(); }catch(err){ alert(err.message); return; }
  const type = $('#roiType').value;
  const name = $('#roiName').value.trim() || (type.toUpperCase()+'_'+(rois.length+1));
  const R = naturalRect();
  // ROI centrado pequeño
  const w = Math.round(R.w*0.25), h = Math.round(R.h*0.08);
  const abs = {x: Math.round(R.w*0.375), y: Math.round(R.h*0.46), w, h};
  const rel = relFromAbs(abs);
  createROI({id: uuid(), name, type, abs, rel});
}
function createROI({id,name,type,abs,rel}){
  const el = document.createElement('div');
  el.className = 'roi';
  el.dataset.id = id;
  el.dataset.type = type;
  position(el, abs);
  // handles
  ['nw','ne','sw','se'].forEach(pos=>{
    const h = document.createElement('div');
    h.className = 'handle '+pos;
    el.appendChild(h);
  });
  el.addEventListener('pointerdown', onRoiPointerDown);
  stage.appendChild(el);
  const roi = {id,name,type,abs,rel,el};
  rois.push(roi);
  selectROI(roi);
  refreshList();
}
function position(el, abs){
  el.style.left = abs.x+'px'; el.style.top = abs.y+'px';
  el.style.width = abs.w+'px'; el.style.height = abs.h+'px';
}

function refreshList(){
  const box = $('#roiList');
  if(rois.length===0){ box.innerHTML='Sin ROIs…'; return; }
  box.innerHTML = '';
  rois.forEach((r,i)=>{
    const line = document.createElement('div');
    line.className='row'; line.style.justifyContent='space-between';
    line.style.padding='4px 0';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${i+1}.</strong> ${escapeHtml(r.name)} <span class="small">(${r.type})</span>`;
    const right = document.createElement('div');
    right.innerHTML = `
      <button data-act="focus" data-id="${r.id}">Ir</button>
      <button data-act="rename" data-id="${r.id}">Renombrar</button>
      <button data-act="type" data-id="${r.id}">Tipo</button>
      <button class="danger" data-act="del" data-id="${r.id}">Del</button>
    `;
    line.appendChild(left); line.appendChild(right); box.appendChild(line);
  });
  box.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      const id = ev.target.dataset.id;
      const roi = rois.find(r=>r.id===id);
      const act = ev.target.dataset.act;
      if(act==='focus'){ selectROI(roi,true); }
      if(act==='rename'){
        const nv = prompt('Nuevo nombre de campo:', roi.name);
        if(nv){ roi.name = nv.trim(); refreshList(); }
      }
      if(act==='type'){
        const t = prompt('Tipo (text/pdf417/mrz):', roi.type);
        if(t && ['text','pdf417','mrz'].includes(t.toLowerCase())){ roi.type = t.toLowerCase(); roi.el.dataset.type = roi.type; refreshList(); }
      }
      if(act==='del'){ deleteROI(roi.id); }
    });
  });
  updateJSONPreview();
}
function deleteROI(id){
  const idx = rois.findIndex(r=>r.id===id);
  if(idx>=0){
    stage.removeChild(rois[idx].el);
    rois.splice(idx,1);
    selected = null;
    refreshList();
  }
}
function selectROI(roi, scroll=false){
  if(selected?.el) selected.el.classList.remove('selected');
  selected = roi;
  if(roi?.el) roi.el.classList.add('selected');
  if(scroll) roi.el.scrollIntoView({behavior:'smooth',block:'center',inline:'center'});
}

/* ----- Dibujo en el stage ----- */
let drawStart=null, drawTemp=null, currentHandle=null, moveOffset=null;

function stagePointerDown(ev){
  if(mode!=='draw') return;
  if(ev.target!==stage && ev.target!==img) return;
  try{ ensureImageLoaded(); }catch(err){ alert(err.message); return; }
  const start = stageCoords(ev);
  drawStart = start;
  drawTemp = document.createElement('div');
  drawTemp.className = 'roi';
  drawTemp.dataset.type = $('#roiType').value;
  stage.appendChild(drawTemp);
  position(drawTemp, {x:start.x,y:start.y,w:1,h:1});
  window.addEventListener('pointermove', stagePointerMove);
  window.addEventListener('pointerup', stagePointerUp, {once:true});
}
function stagePointerMove(ev){
  if(!drawStart || !drawTemp) return;
  const cur = stageCoords(ev);
  const x = Math.min(drawStart.x, cur.x);
  const y = Math.min(drawStart.y, cur.y);
  const w = Math.abs(drawStart.x - cur.x);
  const h = Math.abs(drawStart.y - cur.y);
  position(drawTemp, {x,y,w,h});
}
function stagePointerUp(ev){
  const rect = rectFromEl(drawTemp);
  stage.removeChild(drawTemp);
  drawTemp = null; drawStart = null;
  if(rect.w<8 || rect.h<8) return; // ignore tiny
  const name = ($('#roiName').value.trim() || ($('#roiType').value.toUpperCase()+'_'+(rois.length+1)));
  createROI({id:uuid(), name, type:$('#roiType').value, abs:rect, rel:relFromAbs(rect)});
  mode='select'; $('#btnSelect').classList.add('primary'); $('#btnDraw').classList.remove('primary');
}

/* ----- Mover/redimensionar ROI existente ----- */
function onRoiPointerDown(ev){
  const el = ev.currentTarget;
  const roi = rois.find(r=>r.id===el.dataset.id);
  selectROI(roi);
  ev.stopPropagation();

  const isHandle = ev.target.classList.contains('handle');
  const start = stageCoords(ev);
  const startRect = rectFromEl(el);

  if(isHandle){
    currentHandle = {which: ev.target.classList[1], start, startRect};
    window.addEventListener('pointermove', onResizeMove);
    window.addEventListener('pointerup', onResizeUp, {once:true});
  }else{
    moveOffset = {dx: start.x - startRect.x, dy: start.y - startRect.y, w: startRect.w, h: startRect.h};
    window.addEventListener('pointermove', onMoveMove);
    window.addEventListener('pointerup', onMoveUp, {once:true});
  }
}
function onMoveMove(ev){
  if(!selected || !moveOffset) return;
  const cur = stageCoords(ev);
  const nx = clamp(cur.x - moveOffset.dx, 0, img.naturalWidth - moveOffset.w);
  const ny = clamp(cur.y - moveOffset.dy, 0, img.naturalHeight - moveOffset.h);
  selected.abs = {x:nx,y:ny,w:moveOffset.w,h:moveOffset.h};
  selected.rel = relFromAbs(selected.abs);
  position(selected.el, selected.abs);
  updateJSONPreview();
}
function onMoveUp(){ moveOffset=null; }

function onResizeMove(ev){
  if(!selected || !currentHandle) return;
  const cur = stageCoords(ev);
  const {which, startRect} = currentHandle;
  let {x,y,w,h} = startRect;
  const min=8;

  if(which.includes('n')){ h += (y-cur.y); y = cur.y; }
  if(which.includes('w')){ w += (x-cur.x); x = cur.x; }
  if(which.includes('s')){ h = Math.max(min, cur.y - y); }
  if(which.includes('e')){ w = Math.max(min, cur.x - x); }

  // clamp dentro de la imagen
  x = clamp(x,0,img.naturalWidth); y = clamp(y,0,img.naturalHeight);
  w = clamp(w, min, img.naturalWidth - x);
  h = clamp(h, min, img.naturalHeight - y);

  selected.abs = {x,y,w,h};
  selected.rel = relFromAbs(selected.abs);
  position(selected.el, selected.abs);
  updateJSONPreview();
}
function onResizeUp(){ currentHandle=null; }

/* -------------------- Exportar / Importar JSON -------------------- */
function buildTemplateObject(name='DUI_Template'){
  const regions = rois.map(r=>({
    field_name: r.name,
    field_type: (r.type==='text'?'data_field':'roi'),
    data_type: r.type==='text'?'text':r.type, // text | pdf417 | mrz
    rel: {...r.rel}
  }));
  return { template_name: name, regions };
}
function updateJSONPreview(){
  const tpl = buildTemplateObject('Current_Template');
  $('#jsonOut').value = JSON.stringify(tpl, null, 2);
}
function exportTemplate(){
  const name = prompt('Nombre de la plantilla', 'DUI_El_Salvador_Custom') || 'template';
  const tpl = buildTemplateObject(name);
  const blob = new Blob([JSON.stringify(tpl,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = $('#dlJson');
  a.href = url; a.download = `${name}.json`; a.style.display='inline-block';
  a.click();
}
async function importTemplateFromFile(){
  const f = $('#fileTpl').files?.[0];
  if(!f){ alert('Selecciona un archivo JSON.'); return; }
  const txt = await f.text();
  try{
    const tpl = JSON.parse(txt);
    applyTemplate(tpl);
    $('#jsonOut').value = JSON.stringify(tpl,null,2);
  }catch(e){ alert('JSON inválido.'); }
}
function applyTemplate(tpl){
  try{ ensureImageLoaded(); }catch(err){ alert('Cargar imagen antes de importar la plantilla.'); return; }
  clearROIs(false);
  (tpl.regions||[]).forEach(reg=>{
    const type = (reg.data_type==='text' || reg.field_type==='data_field') ? 'text' : (reg.data_type||'text');
    const abs = absFromRel(reg.rel);
    createROI({id:uuid(), name:reg.field_name||'field', type, abs, rel:reg.rel});
  });
  refreshList();
}
function clearROIs(confirmAsk=true){
  if(confirmAsk && !confirm('¿Eliminar todos los ROIs?')) return;
  rois.forEach(r=>r.el.remove());
  rois = []; selected=null; refreshList();
}

/* -------------------- Extracción -------------------- */
async function extractAll(){
  try{ ensureImageLoaded(); }catch(err){ alert(err.message); return; }
  const lang = $('#ocrLang').value || 'eng';
  const tbody = $('#rows'); tbody.innerHTML='';

  // canvas de recorte
  const c = document.createElement('canvas');
  const cx = c.getContext('2d',{willReadFrequently:true});

  for(let i=0;i<rois.length;i++){
    const r = rois[i];
    // recortar
    c.width = r.abs.w; c.height = r.abs.h;
    cx.clearRect(0,0,c.width,c.height);
    cx.drawImage(img, r.abs.x, r.abs.y, r.abs.w, r.abs.h, 0,0,r.abs.w,r.abs.h);
    const dataURL = c.toDataURL('image/png');

    let value = '';
    let ok = true;
    try{
      if(r.type==='pdf417'){
        value = await decodePDF417FromDataURL(dataURL);
        if(!value) { ok=false; value='No se detectó PDF417 (intentando OCR fallback)…'; }
        if(!value){ value = await ocrText(dataURL,'eng', {whitelist:'A-Z0-9', psm:6}); }
      }else if(r.type==='mrz'){
        const raw = await ocrText(dataURL, 'eng', {whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ<0123456789', psm:6});
        const parsed = parseMRZ(raw);
        value = parsed.ok ? JSON.stringify(parsed.fields) : ('MRZ RAW:\n'+raw.trim());
        ok = parsed.ok;
      }else{
        value = await ocrText(dataURL, lang);
      }
    }catch(e){
      ok=false; value='Error: '+(e.message||e);
    }

    // fila
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><strong>${escapeHtml(r.name)}</strong></td>
      <td>${r.type.toUpperCase()}</td>
      <td><pre style="white-space:pre-wrap;margin:0;max-width:260px">${escapeHtml(String(value))}</pre></td>
      <td><a href="${dataURL}" target="_blank">abrir</a></td>
    `;
    if(!ok) tr.style.opacity=.85;
    tbody.appendChild(tr);
  }
}

/* --- Tesseract helpers --- */
async function ocrText(dataURL, lang='eng', opts={}){
  // opts: {whitelist, psm}
  const cfg = {};
  if(opts.whitelist) cfg.tessedit_char_whitelist = opts.whitelist;
  if(opts.psm) cfg.presets = { single_block:false, oem:1, psm:opts.psm };
  const { data: { text } } = await Tesseract.recognize(dataURL, lang, { logger: m=>{/*console.log(m)*/},  ...(Object.keys(cfg).length?{config:cfg}:{}) });
  return text;
}

/* --- PDF417 with ZXing --- */
async function decodePDF417FromDataURL(dataURL){
  return new Promise((resolve)=>{
    const imgEl = new Image();
    imgEl.onload = async () => {
      try{
        // Use BrowserPDF417Reader from ZXing UMD
        const reader = new ZXing.BrowserPDF417Reader();
        const luminance = ZXing.HTMLCanvasElementLuminanceSourceFactory.createFromImageElement(imgEl);
        const binB = new ZXing.GlobalHistogramBinarizer(luminance);
        const bb = new ZXing.BinaryBitmap(binB);
        const result = reader.decodeBitmap(bb);
        resolve(result?.getText?.() || '');
      }catch(e){
        resolve('');
      }
    };
    imgEl.src = dataURL;
  });
}

/* --- MRZ Parser (TD1/TD3) --- */
function parseMRZ(raw){
  // Normaliza y une líneas de MRZ (acepta 2 o 3 líneas)
  const lines = raw.split(/\r?\n/).map(s=>s.replace(/[^A-Z0-9<]/g,'').trim()).filter(Boolean);
  if(lines.length<2) return {ok:false, msg:'MRZ no detectada', fields:null};
  // Intenta TD3: 2 líneas de 44
  if(lines.length===2 && (lines[0].length>=36 && lines[1].length>=36)){
    const L1 = pad(lines[0],44), L2 = pad(lines[1],44);
    const docType = L1.substring(0,2);
    const issuer = L1.substring(2,5);
    const names = L1.substring(5).split('<<');
    const surname = names[0].replace(/<+/g,' ').trim();
    const given = (names[1]||'').replace(/<+/g,' ').trim();
    const number = L2.substring(0,9).replace(/</g,'');
    const nationality = L2.substring(10,13).replace(/</g,'');
    const birth = L2.substring(13,19);
    const sex = L2.substring(20,21).replace('<','X');
    const expiry = L2.substring(21,27);
    return {ok:true, type:'TD3', fields:{docType,issuer,surname,given,number,nationality,birth,sex,expiry}};
  }
  // Intenta TD1: 3 líneas de 30
  if(lines.length>=3){
    const L1 = pad(lines[0],30), L2=pad(lines[1],30), L3=pad(lines[2],30);
    const docType=L1.substring(0,2), issuer=L1.substring(2,5);
    const number=L1.substring(5,14).replace(/</g,'');
    const birth=L2.substring(0,6), sex=L2.substring(7,8).replace('<','X'), expiry=L2.substring(8,14);
    const nationality=L2.substring(15,18).replace(/</g,'');
    const namePart=L3.split('<<'); const surname=(namePart[0]||'').replace(/<+/g,' ').trim();
    const given=(namePart[1]||'').replace(/<+/g,' ').trim();
    return {ok:true, type:'TD1', fields:{docType,issuer,number,birth,sex,expiry,nationality,surname,given}};
  }
  return {ok:false, msg:'Formato MRZ no reconocido', fields:null};
}
function pad(s,len){ return (s||'').padEnd(len,'<').substring(0,len); }

/* -------------------- Helpers gráficos/geom -------------------- */
function stageCoords(ev){
  const r = stage.getBoundingClientRect();
  const x = clamp(Math.round(ev.clientX - r.left), 0, img.naturalWidth);
  const y = clamp(Math.round(ev.clientY - r.top), 0, img.naturalHeight);
  return {x,y};
}
function rectFromEl(el){
  return {
    x: parseInt(el.style.left||'0',10),
    y: parseInt(el.style.top||'0',10),
    w: parseInt(el.style.width||'0',10),
    h: parseInt(el.style.height||'0',10),
  }
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

/* -------------------- Tips de uso --------------------
1) Carga la imagen del documento (se mantiene en su tamaño natural).
2) Importa tu JSON de plantilla (o dibuja ROIs y exporta).
3) Ajusta ROIs con el mouse (mover y redimensionar con las manecillas).
4) Pulsa “Extraer Todo” para ver resultados en la tabla. 
   - PDF417: ZXing sobre el recorte (base64).
   - MRZ: OCR (Tesseract) + parser TD1/TD3 (soporta líneas más largas).
   - Texto: OCR multilenguaje (selector).
------------------------------------------------------ */
</script>
</body>
</html>
