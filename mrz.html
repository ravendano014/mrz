<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lector MRZ con Persistente + Beep ‚Äî C√°mara + Parser</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; --text:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(180deg,#0b1220,#111827);color:var(--text)}
    header{padding:1.25rem 1rem 0.5rem;max-width:1000px;margin:auto}
    h1{margin:0 0 .25rem;font-size:clamp(1.25rem,2.5vw,1.6rem)}
    p.lead{margin:.25rem 0 1rem;color:var(--muted)}
    .wrap{max-width:1000px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
    .grid{display:grid;grid-template-columns:1fr;gap:1rem}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 6px 28px rgba(0,0,0,.35)}
    .card h2{font-size:1rem;margin:0 0 .25rem;color:#cbd5e1}
    .pad{padding:1rem}
    .controls{display:flex;flex-wrap:wrap;gap:.5rem;margin:.5rem 0 0}
    button, .btn{appearance:none;border:1px solid #1f2937;background:#0b1220;color:var(--text);padding:.6rem .9rem;border-radius:10px;cursor:pointer}
    button:hover{border-color:#374151}
    .primary{background:var(--accent);border-color:transparent;color:#052e16;font-weight:700}
    .danger{background:var(--danger);color:#fff;border-color:transparent}
    .muted{color:var(--muted)}
    .stage{position:relative;border-radius:16px;overflow:hidden;background:#000}
    video{width:100%;display:block;max-height:60vh;object-fit:cover}
    canvas.hidden{display:none}
    .frame{position:absolute;inset:auto 10% 10% 10%; height:26%; border:4px solid #22c55e;border-radius:8px;box-shadow:0 0 0 3px rgba(34,197,94,.15) inset}
    .frame::after{content:""; position:absolute; left:6px; right:6px; top:50%; height:2px; background:#22c55e66}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .out{white-space:pre-wrap; word-break:break-word; background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:.75rem; min-height:3.5rem}
    dl{margin:.25rem 0;display:grid;grid-template-columns:max-content 1fr;gap:.25rem .75rem}
    dt{color:#9ca3af}
    dd{margin:0}
    .hint{font-size:.92rem;color:#a3e635}
    footer{opacity:.7;text-align:center;padding:1rem}
    a{color:#93c5fd}
    .results-table {width:100%;border-collapse:collapse;margin-top:.5rem;font-size:.875rem}
    .results-table th, .results-table td {padding:.5rem;text-align:left;border-bottom:1px solid #1f2937}
    .results-table th {color:#9ca3af;font-weight:600;width:40%}
    .results-table tr:last-child td {border-bottom:none}
    .check-ok {color:#22c55e}
    .check-fail {color:#ef4444}
    .json-container {position:relative}
    .copy-json-btn {position:absolute;top:.5rem;right:.5rem}
    .thumb {margin-top:.5rem; max-width:100%; border-radius:8px; border:1px solid #1f2937}
  </style>
</head>
<body>
  <header>
    <h1>Extractor de MRZ ‚Äî Persistente + Beep</h1>
    <p class="lead">Activa <strong>Persistente</strong> para que el lector intente detectar MRZ autom√°ticamente y capture la imagen cuando se confirme. Se reproduce un beep al detectar MRZ.</p>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card pad">
        <h2>Vista de c√°mara</h2>
        <p class="hint">Alinea la MRZ dentro del recuadro verde.</p>
        <div id="stage" class="stage">
          <video id="video" playsinline muted></video>
          <div class="frame" aria-label="√Årea objetivo para MRZ"></div>
          <canvas id="snapshot" class="hidden"></canvas>
        </div>

        <div class="controls">
          <button id="start" class="primary">‚ñ∂ Iniciar c√°mara</button>
          <button id="stop" class="danger" disabled>‚ñ† Detener</button>
          <button id="capture" disabled>üì∏ Capturar y extraer MRZ</button>

          <label style="display:flex;align-items:center;gap:.5rem;margin-left:auto">
            <input id="rear" type="checkbox" checked/> C√°mara trasera
          </label>
        </div>

        <div class="controls" style="margin-top:.5rem">
          <label style="display:flex;align-items:center;gap:.5rem">
            <input id="persistent" type="checkbox" /> <span class="muted">Persistente (auto-scan)</span>
          </label>
          <label style="display:flex;align-items:center;gap:.5rem;margin-left:1rem">
            Throttle: <input id="throttle" type="range" min="500" max="3000" step="250" value="1500"/> <small id="throttleVal" class="muted">1500ms</small>
          </label>
        </div>

        <div id="captured-thumb"></div>

        <small class="muted">Privacidad: el video y las im√°genes no salen del dispositivo; OCR con Tesseract.js en el cliente.</small>
      </div>

      <aside class="card pad">
        <h2>Resultado</h2>
        <div id="status" class="muted">Listo.</div>
        <div id="output" class="out mono" aria-live="polite"></div>
        <div class="controls">
          <button id="copy" class="btn" disabled>Copiar MRZ</button>
          <button id="clear" class="btn" disabled>Limpiar</button>
        </div>

        <div class="controls" style="margin-top:.5rem">
          <button id="parse" class="primary" disabled>üß© Parsear MRZ</button>
        </div>

        <div class="format-guide">
          <strong>Gu√≠a:</strong> TD1: 3√ó30 ¬∑ TD2: 2√ó36 ¬∑ TD3: 2√ó44
        </div>

        <h3 style="margin-top:1rem">MRZ Parser (JSON)</h3>
        <div class="json-container">
          <div id="decoded" class="out mono" aria-live="polite" style="min-height:6rem; max-height:20rem; overflow-y:auto"></div>
          <button id="copy-json" class="btn copy-json-btn" disabled>üìã Copiar JSON</button>
        </div>

        <h3 style="margin-top:1rem">Qu√© se detecta</h3>
        <dl>
          <dt>TD1</dt><dd>3 l√≠neas √ó 30 caracteres (ID tarjetas)</dd>
          <dt>TD2</dt><dd>2 l√≠neas √ó 36 caracteres</dd>
          <dt>TD3</dt><dd>2 l√≠neas √ó 44 caracteres (pasaportes)</dd>
        </dl>
      </aside>
    </section>

    <section class="card pad">
      <h2>C√≥mo usar</h2>
      <ol>
        <li>Inicia la c√°mara.</li>
        <li>Activa <strong>Persistente</strong> si quieres que detecte autom√°ticamente (throttle controla la frecuencia de intentos).</li>
        <li>Coloca el documento dentro del recuadro y espera el beep: la imagen se guardar√° y el MRZ aparecer√°.</li>
        <li>Usa <em>Capturar y extraer MRZ</em> para extracci√≥n manual.</li>
      </ol>
    </section>
  </main>

  <footer>Hecho con <a href="https://tesseract.projectnaptha.com/" target="_blank" rel="noreferrer noopener">Tesseract.js</a> y <code>getUserMedia</code>.</footer>

  <!-- Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const video = $('#video');
    const canvas = $('#snapshot');
    const startBtn = $('#start');
    const stopBtn = $('#stop');
    const capBtn = $('#capture');
    const statusEl = $('#status');
    const outputEl = $('#output');
    const copyBtn = $('#copy');
    const clearBtn = $('#clear');
    const parseBtn = $('#parse');
    const decodedEl = $('#decoded');
    const rearCbx = $('#rear');
    const persistentCbx = $('#persistent');
    const throttleRange = $('#throttle');
    const throttleVal = $('#throttleVal');
    const capturedThumb = $('#captured-thumb');
    const copyJsonBtn = $('#copy-json');

    let stream = null;
    let persistentTimer = null;
    let lastDetected = 0;
    let audioCtx = null;

    function setBusy(isBusy, msg='') {
      statusEl.textContent = isBusy ? (msg || 'Procesando‚Ä¶') : (msg || 'Listo.');
      startBtn.disabled = isBusy || !!stream;
      stopBtn.disabled = isBusy || !stream;
      capBtn.disabled = isBusy || !stream;
      const has = outputEl.textContent.trim().length > 0;
      copyBtn.disabled = !has;
      clearBtn.disabled = !has;
      parseBtn.disabled = !has;
      copyJsonBtn.disabled = !has || !decodedEl.textContent.trim();
      if(!has) {
        decodedEl.textContent = '';
      }
    }

    throttleRange.addEventListener('input', ()=> throttleVal.textContent = throttleRange.value + 'ms');

    async function startCamera(){
      try{
        setBusy(true,'Abriendo c√°mara‚Ä¶');
        const constraints = {
          audio:false,
          video:{ facingMode: rearCbx.checked ? { ideal: 'environment'} : 'user', width:{ideal:1920}, height:{ideal:1080} }
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        setBusy(false,'C√°mara lista.');
        if(persistentCbx.checked) startPersistent();
      }catch(err){
        console.error(err);
        setBusy(false,'No se pudo acceder a la c√°mara: ' + (err.message||err.name));
      }
    }

    function stopCamera(){
      stopPersistent();
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
        video.srcObject = null;
      }
      setBusy(false,'C√°mara detenida.');
    }

    function getMRZCrop(){
      const rect = document.getElementById('stage').getBoundingClientRect();
      const frame = document.querySelector('.frame').getBoundingClientRect();
      const vw = video.videoWidth, vh = video.videoHeight;
      if(!vw || !vh) throw new Error('Video no listo a√∫n.');
      const scaleX = vw / rect.width;
      const scaleY = vh / rect.height;
      const sx = (frame.left - rect.left) * scaleX;
      const sy = (frame.top - rect.top) * scaleY;
      const sw = frame.width * scaleX;
      const sh = frame.height * scaleY;
      canvas.width = sw; canvas.height = sh;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);
      return canvas;
    }

    function normalizeMRZ(text){
      const allowed = /[A-Z0-9<]/g;
      const lines = text
        .toUpperCase()
        .replace(/\s+/g,'\n')
        .split(/\n+/)
        .map(l => (l.match(allowed)||[]).join(''))
        .filter(l=>l.length>=25);
      const take = (n,len) => {
        for(let i=0;i+n-1<lines.length;i++){
          const group = lines.slice(i,i+n);
          if(group.every(l=>Math.abs(l.length-len)<=2)) return group;
        }
        return null;
      };
      let group = take(3,30) || take(2,44) || take(2,36);
      if(group) return group.map(l=>l.padEnd(group[0].length,'<')).join('\n');
      const top = lines.sort((a,b)=>b.length-a.length).slice(0,3);
      return top.join('\n');
    }

    // Play beep using WebAudio
    function beep(durationMs = 120, freq=1000, volume=0.08) {
      try {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        setTimeout(()=>{ osc.stop(); }, durationMs);
      } catch(e) {
        console.warn('No se pudo reproducir beep:', e);
      }
    }

    async function captureAndOCR({auto=false} = {}) {
      try{
        setBusy(true,'Reconociendo MRZ‚Ä¶');
        const crop = getMRZCrop();
        // OCR: whitelist MRZ
        const { data } = await Tesseract.recognize(crop, 'eng', {
          logger: m => { if(m.status==='recognizing text') statusEl.textContent = `Reconociendo‚Ä¶ ${(m.progress*100).toFixed(0)}%`; },
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ<0123456789'
        });
        const cleaned = normalizeMRZ(data.text||'').trim();
        outputEl.textContent = cleaned;
        setBusy(false, cleaned ? 'MRZ extra√≠da.' : 'No se detect√≥ MRZ clara.');
        if(cleaned) {
          // auto actions: beep + save image if called from persistent OR auto flag
          const now = Date.now();
          // evita detecciones repetidas inmediatas
          if(now - lastDetected > 900) {
            lastDetected = now;
            beep();
            // show thumbnail and provide download link
            const thumbData = canvas.toDataURL('image/jpeg', 0.9);
            capturedThumb.innerHTML = `
              <div style="margin-top:.5rem">
                <img class="thumb" src="${thumbData}" alt="Captura MRZ"/>
                <div style="margin-top:.5rem;display:flex;gap:.5rem">
                  <a class="btn" href="${thumbData}" download="mrz-capture-${now}.jpg">‚¨á Guardar imagen</a>
                  <button id="openInNew" class="btn">Abrir</button>
                </div>
              </div>
            `;
            const btnOpen = document.getElementById('openInNew');
            if(btnOpen) btnOpen.addEventListener('click', ()=> window.open(thumbData));
            // optionally auto-parse
            const parsed = parseMRZ(cleaned);
            decodedEl.textContent = JSON.stringify(parsed, null, 2);
            displayResults(parsed);
            copyJsonBtn.disabled = false;
          }
        }
      }catch(err){
        console.error(err);
        setBusy(false,'Error durante OCR: ' + (err.message||err));
      }
    }

    // Persistent scanning control
    function startPersistent(){
      stopPersistent();
      if(!stream) return;
      const ms = parseInt(throttleRange.value,10) || 1500;
      persistentTimer = setInterval(async () => {
        // Only attempt when video has data
        if(video.readyState < 2) return;
        try {
          await captureAndOCR({auto:true});
        } catch(e) { console.error('Persistente error', e); }
      }, ms);
      statusEl.textContent = 'Modo persistente activo.';
    }

    function stopPersistent(){
      if(persistentTimer) { clearInterval(persistentTimer); persistentTimer = null; statusEl.textContent = 'Modo persistente detenido.'; }
    }

    // MRZ parsing utilities (copiado y simplificado de tu versi√≥n original)
    function mrzCharValue(ch){
      if(ch>='0' && ch<='9') return ch.charCodeAt(0)-48;
      if(ch>='A' && ch<='Z') return ch.charCodeAt(0)-55;
      return 0;
    }
    function mrzCheckDigit(data){
      const weights = [7,3,1];
      let sum=0; for(let i=0;i<data.length;i++){ sum += mrzCharValue(data[i])*weights[i%3]; }
      return String(sum%10);
    }
    function splitNames(nameField){
      const [surname, rest=''] = nameField.split('<<');
      const given = rest.replace(/<+/g,' ').trim().replace(/\s+/g,' ');
      return { surname: surname.replace(/<+/g,' ').trim(), givenNames: given };
    }
    function parseDateYYMMDD(s){
      const yy=s.slice(0,2), mm=s.slice(2,4), dd=s.slice(4,6);
      return { yy, mm, dd };
    }
    function detectFormat(lines){
      const L = lines.map(l=>l.length);
      if(lines.length===3 && L.every(n=>n>=28 && n<=32)) return 'TD1';
      if(lines.length===2 && L.every(n=>n>=43 && n<=45)) return 'TD3';
      if(lines.length===2 && L.every(n=>n>=35 && n<=37)) return 'TD2';
      return 'UNKNOWN';
    }
    function formatDateDisplay(dateObj) {
      if (!dateObj || !dateObj.yy) return '';
      const year = parseInt(dateObj.yy) < 50 ? `20${dateObj.yy}` : `19${dateObj.yy}`;
      return `${dateObj.yy}${dateObj.mm}${dateObj.dd} (${year}-${dateObj.mm}-${dateObj.dd})`;
    }

    function displayResults(parsed) {
      const resultsBody = document.getElementById('results-body') || (() => {
        const tbody = document.createElement('tbody'); document.querySelector('.results-table')?.appendChild(tbody); return tbody;
      })();
      // If no .results-table in DOM create it
      let table = document.querySelector('.results-table');
      if(!table){
        const container = document.createElement('div'); container.style.marginTop = '.5rem';
        container.innerHTML = `<table class="results-table"><tbody id="results-body"></tbody></table>`;
        document.querySelector('aside .pad').insertBefore(container, document.querySelector('.json-container'));
        table = document.querySelector('.results-table');
      }
      const body = table.tBodies[0] || resultsBody;
      body.innerHTML = '';
      if (!parsed.format || parsed.format === 'UNKNOWN') return;
      const checks = parsed.checks || {};
      let validChecks = 0, totalChecks = 0;
      Object.values(checks).forEach(c => { if(c!==undefined){ totalChecks++; if(c) validChecks++; }});
      addRow(body,'Formato detectado', parsed.format);
      addRow(body,'Checks', `${validChecks} de ${totalChecks} OK`, validChecks===totalChecks);
      if(parsed.documentNumber) addRow(body,'Document Number', parsed.documentNumber);
      if(parsed.birthDate) addRow(body,'Birth (YYMMDD)', formatDateDisplay(parsed.birthDate));
      if(parsed.expiryDate) addRow(body,'Expiry (YYMMDD)', formatDateDisplay(parsed.expiryDate));
    }
    function addRow(body,label,value,isValid){
      const row = document.createElement('tr');
      const a = document.createElement('td'); a.textContent = label;
      const b = document.createElement('td'); b.textContent = value;
      if(isValid!==undefined) b.className = isValid ? 'check-ok' : 'check-fail';
      row.appendChild(a); row.appendChild(b); body.appendChild(row);
    }

    function parseMRZ(text){
      const lines = text.split(/\n+/).map(l=>l.trim()).filter(Boolean);
      const format = detectFormat(lines);
      const res = { format, raw: lines };
      try{
        if(format==='TD3'){
          const [L1,L2] = lines.map(l=>l.padEnd(44,'<'));
          res.documentCode = L1.slice(0,2); res.issuingState = L1.slice(2,5);
          Object.assign(res, splitNames(L1.slice(5,44)));
          res.documentNumber = L2.slice(0,9).replace(/<+/g,'');
          res.documentNumberCheck = L2.slice(9,10);
          res.nationality = L2.slice(10,13);
          res.birthDate = parseDateYYMMDD(L2.slice(13,19));
          res.birthDateCheck = L2.slice(19,20);
          res.sex = L2.slice(20,21);
          res.expiryDate = parseDateYYMMDD(L2.slice(21,27));
          res.expiryDateCheck = L2.slice(27,28);
          res.optionalNumber = L2.slice(28,42).replace(/<+/g,'');
          res.finalCheck = L2.slice(43,44);
          res.checks = {
            documentNumber: mrzCheckDigit(L2.slice(0,9)) === res.documentNumberCheck,
            birthDate: mrzCheckDigit(L2.slice(13,19)) === res.birthDateCheck,
            expiryDate: mrzCheckDigit(L2.slice(21,27)) === res.expiryDateCheck
          };
          return res;
        }
        if(format==='TD2'){
          const [L1,L2] = lines.map(l=>l.padEnd(36,'<'));
          res.documentCode = L1.slice(0,2); res.issuingState = L1.slice(2,5);
          Object.assign(res, splitNames(L1.slice(5,36)));
          res.documentNumber = L2.slice(0,9).replace(/<+/g,'');
          res.documentNumberCheck = L2.slice(9,10);
          res.nationality = L2.slice(10,13);
          res.birthDate = parseDateYYMMDD(L2.slice(13,19));
          res.birthDateCheck = L2.slice(19,20);
          res.sex = L2.slice(20,21);
          res.expiryDate = parseDateYYMMDD(L2.slice(21,27));
          res.expiryDateCheck = L2.slice(27,28);
          res.optionalData = L2.slice(28,35).replace(/<+/g,'');
          res.finalCheck = L2.slice(35,36);
          res.checks = {
            documentNumber: mrzCheckDigit(L2.slice(0,9)) === res.documentNumberCheck,
            birthDate: mrzCheckDigit(L2.slice(13,19)) === res.birthDateCheck,
            expiryDate: mrzCheckDigit(L2.slice(21,27)) === res.expiryDateCheck
          };
          return res;
        }
        if(format==='TD1'){
          const [A,B,C] = lines.map(l=>l.padEnd(30,'<'));
          res.documentCode = A.slice(0,2); res.issuingState = A.slice(2,5);
          res.documentNumber = A.slice(5,14).replace(/<+/g,'');
          res.documentNumberCheck = A.slice(14,15);
          res.optionalData1 = A.slice(15,30).replace(/<+/g,'');
          res.birthDate = parseDateYYMMDD(B.slice(0,6));
          res.birthDateCheck = B.slice(6,7);
          res.sex = B.slice(7,8);
          res.expiryDate = parseDateYYMMDD(B.slice(8,14));
          res.expiryDateCheck = B.slice(14,15);
          res.nationality = B.slice(15,18);
          res.optionalData2 = B.slice(18,29).replace(/<+/g,'');
          res.finalCheck = B.slice(29,30);
          Object.assign(res, splitNames(C.slice(0,30)));
          res.checks = {
            documentNumber: mrzCheckDigit(A.slice(5,14)) === res.documentNumberCheck,
            birthDate: mrzCheckDigit(B.slice(0,6)) === res.birthDateCheck,
            expiryDate: mrzCheckDigit(B.slice(8,14)) === res.expiryDateCheck
          };
          return res;
        }
      }catch(e){ res.error = String(e); }
      return res;
    }

    // Event bindings
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    capBtn.addEventListener('click', ()=> captureAndOCR({auto:false}));

    video.addEventListener('loadedmetadata', ()=>{ capBtn.disabled = false; stopBtn.disabled = false; startBtn.disabled = true; });
    video.addEventListener('emptied', ()=>{ capBtn.disabled = true; stopBtn.disabled = true; startBtn.disabled = false; });

    copyBtn.addEventListener('click', async ()=> {
      const txt = outputEl.textContent.trim();
      if(!txt) return;
      await navigator.clipboard.writeText(txt);
      statusEl.textContent = 'MRZ copiada al portapapeles.';
    });

    copyJsonBtn.addEventListener('click', async ()=>{
      const txt = decodedEl.textContent.trim();
      if(!txt) return;
      await navigator.clipboard.writeText(txt);
      statusEl.textContent = 'JSON copiado al portapapeles.';
    });

    clearBtn.addEventListener('click', ()=> {
      outputEl.textContent=''; decodedEl.textContent=''; capturedThumb.innerHTML=''; setBusy(false,'Listo.');
    });

    parseBtn.addEventListener('click', ()=>{
      const raw = outputEl.textContent.trim();
      if(!raw) return;
      const parsed = parseMRZ(raw);
      decodedEl.textContent = JSON.stringify(parsed, null, 2);
      displayResults(parsed);
      copyJsonBtn.disabled = false;
      statusEl.textContent = parsed && parsed.format ? `MRZ parseada (${parsed.format}).` : 'No se pudo parsear.';
    });

    // Persistent checkbox behavior
    persistentCbx.addEventListener('change', ()=>{
      if(persistentCbx.checked) startPersistent();
      else stopPersistent();
    });
    throttleRange.addEventListener('change', ()=>{
      if(persistentCbx.checked) startPersistent();
    });

    // Initialize state
    setBusy(false,'Listo.');
  </script>
</body>
</html>
