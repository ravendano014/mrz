<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeScanner + ROI Editor (Dark) ‚Äî PDF417 / MRZ / OCR</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#12192a; --muted:#1a2338; --text:#e8ecf1; --sub:#98a2b3; --accent:#6ea8fe; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --br:14px; --gap:14px;
      --line:#2a3452; --handle:#cbd5e1; --roi-text:#60a5fa; --roi-barcode:#f97316; --roi-pdf417:#22c55e; --roi-mrz:#e11d48; --roi-image:#a855f7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    h1{font-size:18px;margin:0 0 8px}
    h2{font-size:16px;margin:0 0 8px}
    .app{display:grid;grid-template-columns: 420px 1fr; gap:var(--gap); padding:var(--gap)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--br);padding:var(--gap);}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    .muted{color:var(--sub)}
    label{font-size:12px;color:var(--sub)}
    input[type="text"],input[type="number"],select{background:#0f1626;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    input[type="file"]{color:var(--sub)}
    button{background:#0f1626;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:8px 12px;cursor:pointer}
    button:hover{border-color:var(--accent)}
    button.primary{background:linear-gradient(180deg,#1b2b4f,#152343);border-color:#2e3c62}
    button.ok{border-color:#14532d;background:#0a1f12}
    button.warn{border-color:#7c4a0b;background:#1e1508}
    button.ghost{background:transparent}
    .tag{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:999px;font-size:11px;color:var(--sub)}

    /* Layout specifics */
    .video{width:100%;max-width:100%;border-radius:10px;border:1px solid var(--line);background:#050913}
    .preview img{max-width:100%;border:1px dashed var(--line);border-radius:10px}
    .grid2{display:grid;grid-template-columns: 1fr 1fr; gap:var(--gap)}
    .tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tools .right{margin-left:auto}

    /* Editor */
    .editor-wrap{position:relative;background:var(--muted);border-radius:var(--br);border:1px solid var(--line);overflow:hidden;min-height:420px}
    canvas#editor{display:block;width:100%;height:100%;}
    .overlay{pointer-events:none;position:absolute;inset:0}

    /* ROI visuals */
    .roi{position:absolute;border:2px solid var(--roi-text);border-radius:8px;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset}
    .roi[data-type="barcode"]{border-color:var(--roi-barcode)}
    .roi[data-type="pdf417"]{border-color:var(--roi-pdf417)}
    .roi[data-type="mrz"]{border-color:var(--roi-mrz)}
    .roi[data-type="image"]{border-color:var(--roi-image)}
    .roi.selected{outline:2px solid var(--accent);outline-offset:2px}
    .handle{position:absolute;width:10px;height:10px;background:var(--handle);border-radius:4px;border:1px solid #0b1222;pointer-events:auto}
    .handle.nw{left:-6px;top:-6px}
    .handle.ne{right:-6px;top:-6px}
    .handle.sw{left:-6px;bottom:-6px}
    .handle.se{right:-6px;bottom:-6px}
    .handle.n{top:-6px;left:calc(50% - 5px)}
    .handle.s{bottom:-6px;left:calc(50% - 5px)}
    .handle.w{left:-6px;top:calc(50% - 5px)}
    .handle.e{right:-6px;top:calc(50% - 5px)}
    .roi .title{position:absolute;left:0;top:-20px;font-size:11px;color:#d1d8e6;background:#101728;border:1px solid var(--line);padding:2px 6px;border-radius:6px}

    .sidebar{display:grid;grid-template-rows:auto auto 1fr;gap:var(--gap)}
    .list{max-height:220px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:6px;background:#101728}
    .list .item{display:flex;gap:8px;align-items:center;padding:6px 8px;border-radius:8px;cursor:pointer}
    .list .item:hover{background:#0d1526}
    .list .item.active{background:#13203b;border:1px solid #26395f}
    .item .dot{width:8px;height:8px;border-radius:999px;display:inline-block}

    .log{white-space:pre-wrap;background:#0f1626;border:1px solid var(--line);border-radius:10px;padding:8px;min-height:120px;max-height:240px;overflow:auto}
    .tbl{width:100%;border-collapse:collapse;font-size:13px}
    .tbl th,.tbl td{border:1px solid var(--line);padding:6px 8px;text-align:left}
    .tbl th{background:#0f1626;color:#c7d2fe}

    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: C√°mara + Decodificaci√≥n (se mantiene y ampl√≠a) -->
    <section class="card col" id="left">
      <div>
        <h1>üì∑ C√°mara y Decodificador</h1>
        <div class="muted small">Mantiene "Procesar imagen (PDF417)". A√±adidos: captura al editor.</div>
      </div>
      <video id="video" class="video" autoplay muted playsinline></video>
      <div class="tools">
        <button id="startButton" class="primary">Iniciar c√°mara</button>
        <button id="stopButton">Detener</button>
        <button id="changeButton">Cambiar c√°mara</button>
        <span class="tag">Stream ‚Üí lectura en vivo</span>
        <div class="right"></div>
        <button id="snapToEditor" class="ok">üì∏ Capturar al editor</button>
      </div>

      <div class="col">
        <div class="row">
          <input type="file" id="myFile" accept="image/png, image/jpeg" />
          <button id="clearButton" class="ghost">Limpiar vista previa</button>
          <button id="decodeButton" class="primary">Procesar imagen (PDF417)</button>
        </div>
        <div class="preview" id="preview"></div>
      </div>

      <div class="grid2">
        <div>
          <h2>Resultado ‚Äî C√°mara</h2>
          <div id="result" class="log"></div>
        </div>
        <div>
          <h2>Resultado ‚Äî Imagen</h2>
          <div id="resultImg" class="log"></div>
        </div>
      </div>

      <div class="col">
        <h2>üìë DUI (parseo tras PDF417)</h2>
        <table class="tbl" id="duiTable"></table>
      </div>
    </section>

    <!-- RIGHT: Editor con ROIs, OCR, MRZ, PDF417, Barcode -->
    <section class="card col" id="right">
      <div class="tools">
        <h1>üñºÔ∏è Editor de ROIs</h1>
        <div class="right"></div>
        <label class="small">Zoom <input type="range" id="zoom" min="10" max="400" step="5" value="100"/></label>
        <span id="zoomPct" class="tag">100%</span>
      </div>
      <div class="row">
        <button id="loadPreviewToEditor">Cargar imagen de la vista previa</button>
        <input type="file" id="openImage" accept="image/*" />
        <button id="addRoi">+ Nueva ROI</button>
        <select id="newRoiType">
          <option value="text">text (OCR)</option>
          <option value="barcode">barcode</option>
          <option value="pdf417">pdf417</option>
          <option value="mrz">mrz</option>
          <option value="image">image (captura)</option>
        </select>
        <button id="exportTpl">Exportar plantilla</button>
        <input type="file" id="importTpl" accept="application/json" />
      </div>

      <div class="editor-wrap" id="editorWrap">
        <canvas id="editor" width="1280" height="720"></canvas>
        <div class="overlay" id="overlay"></div>
      </div>

      <div class="grid2">
        <div class="sidebar">
          <div>
            <h2>ROIs</h2>
            <div class="list" id="roiList"></div>
          </div>
          <div class="col">
            <h2>Propiedades</h2>
            <div class="col">
              <label>Nombre <input type="text" id="propName"/></label>
              <label>Tipo
                <select id="propType">
                  <option value="text">text</option>
                  <option value="barcode">barcode</option>
                  <option value="pdf417">pdf417</option>
                  <option value="mrz">mrz</option>
                  <option value="image">image</option>
                </select>
              </label>
              <div class="row">
                <label>X <input type="number" id="propX" step="1"/></label>
                <label>Y <input type="number" id="propY" step="1"/></label>
                <label>W <input type="number" id="propW" step="1"/></label>
                <label>H <input type="number" id="propH" step="1"/></label>
              </div>
              <div class="row">
                <button id="btnExtract" class="primary">Extraer este ROI</button>
                <button id="btnDelete" class="warn">Eliminar ROI</button>
              </div>
              <div class="row">
                <button id="btnExtractAll">Extraer TODOS</button>
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <h2>Resultados</h2>
          <div class="log" id="log"></div>
          <h2>MRZ (parseado)</h2>
          <table class="tbl" id="mrzTable"></table>
        </div>
      </div>
    </section>
  </div>

  <!-- Dependencias: ZXing + Tesseract. Si ya usas una copia local de zxing.js, puedes comentar la CDN. -->
  <script src="https://unpkg.com/@zxing/library@0.21.2/umd/index.min.js"></script>
  <script>
    // Si existe zxing.js local, √∫salo (opcional). Debe exponer ZXing en window.
    // <script src="zxing.js"></script>
  </script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

  <script>
  /*************************
   * UTILIDADES GENERALES  *
   *************************/
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const logEl = $('#log');
  const duiTable = $('#duiTable');
  const mrzTable = $('#mrzTable');
  function log(msg){
    const time = new Date().toLocaleTimeString();
    logEl.textContent += `[${time}] ${msg}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function clearTable(t){ while(t.firstChild) t.removeChild(t.firstChild); }
  function fillTable(t, obj){
    clearTable(t);
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>Campo</th><th>Valor</th></tr>';
    t.appendChild(thead);
    const tbody = document.createElement('tbody');
    for(const [k,v] of Object.entries(obj||{})){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = k;
      const td2 = document.createElement('td'); td2.textContent = typeof v==='string'? v : JSON.stringify(v);
      tr.append(td1,td2); tbody.appendChild(tr);
    }
    t.appendChild(tbody);
  }

  /*************************
   * SECCI√ìN: C√ÅMARA BASE  *
   *************************/
  const video = $('#video');
  let codeReader = null;
  let streamObj = null;
  let CameraMode = 'user'; // 'environment'

  function ensureZXing(){
    if (!window.ZXing || !window.ZXing.BrowserMultiFormatReader) {
      throw new Error('ZXing no est√° disponible. Verifica la carga de la librer√≠a.');
    }
    if (!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
    return codeReader;
  }

  async function startCam(){
    try{
      await navigator.mediaDevices.getUserMedia({video:{facingMode: CameraMode}}).then(stream=>{
        streamObj = stream; video.srcObject = stream;
        ensureZXing().decodeFromStream(stream, video, (result, err)=>{
          if(result){ onLiveDecode(result); }
          if(err && !(err instanceof ZXing.NotFoundException)){
            $('#result').textContent = String(err);
          }
        });
      });
    }catch(e){ console.error(e); }
  }
  function stopCam(){
    if(streamObj){ streamObj.getTracks().forEach(t=> t.stop()); streamObj=null; }
  }
  function changeCam(){
    if(streamObj) stopCam();
    CameraMode = (CameraMode==='user')? 'environment':'user';
    startCam();
  }

  // Botones c√°mara
  $('#startButton').addEventListener('click', startCam);
  $('#stopButton').addEventListener('click', stopCam);
  $('#changeButton').addEventListener('click', changeCam);

  // Vista previa de archivo + decodificaci√≥n imagen (se mantiene)
  $('#myFile').addEventListener('change', ()=>{
    const files = $('#myFile').files;
    const preview = $('#preview');
    while(preview.firstChild) preview.removeChild(preview.firstChild);
    if(files && files[0]){
      const img = new Image(); img.src = URL.createObjectURL(files[0]); img.width=360; img.onload=()=>{};
      preview.appendChild(img);
    }
  });
  $('#clearButton').addEventListener('click', ()=>{
    const preview = $('#preview');
    while(preview.firstChild) preview.removeChild(preview.firstChild);
  });

  $('#decodeButton').addEventListener('click', async()=>{
    const prev = $('#preview'); if(!prev.firstChild) return;
    const img = prev.firstChild.cloneNode(true);
    try{
      const res = await ensureZXing().decodeFromImage(img);
      $('#resultImg').textContent = res.text || String(res);
      // Intentar parsear DUI si es PDF417
      try{ const parsed = parseDUISV(res.text||''); if(parsed && Object.keys(parsed).length){ fillTable(duiTable, parsed); } }catch{}
    }catch(err){ $('#resultImg').textContent = String(err); }
  });

  function onLiveDecode(result){
    // Mostrar resultados en vivo. Si fuera CODE_128 se podr√≠a derivar a tu parseador externo.
    const out = { format: result.getBarcodeFormat? String(result.getBarcodeFormat()) : result.format, text: result.text };
    $('#result').textContent = JSON.stringify(out, null, 2);
    // Intentar parseo DUI si parece PDF417
    try{ const parsed = parseDUISV(result.text||''); if(parsed && Object.keys(parsed).length){ fillTable(duiTable, parsed); } }catch{}
  }

  // Capturar frame al editor
  $('#snapToEditor').addEventListener('click', ()=>{
    if(!video.videoWidth){ log('‚ö†Ô∏è La c√°mara no est√° lista.'); return; }
    const tmp = document.createElement('canvas');
    tmp.width = video.videoWidth; tmp.height = video.videoHeight;
    const ctx = tmp.getContext('2d'); ctx.drawImage(video,0,0);
    const dataURL = tmp.toDataURL('image/png');
    loadImageToEditor(dataURL);
    log('üì∏ Frame de c√°mara enviado al editor.');
  });

  /*************************
   * SECCI√ìN: EDITOR ROIs  *
   *************************/
  const editor = $('#editor');
  const overlay = $('#overlay');
  const wrap = $('#editorWrap');
  const ctx = editor.getContext('2d');
  let baseImg = null; // {image:HTMLImageElement, naturalW, naturalH}
  let zoom = 1.0; let zoomPctEl = $('#zoomPct');

  // ROIs almacenados en coordenadas NATURALES (respecto a la imagen base)
  let rois = []; // {id,name,type,x,y,w,h}
  let activeId = null;
  let mode = 'idle'; // 'idle'|'creating'|'dragging'|'resizing'
  let createType = 'text';
  let dragStart = null; // {x,y}
  let resizeHandle = null; // 'nw','ne','sw','se','n','s','w','e'

  function setZoom(pct){
    zoom = Math.max(.1, Math.min(4, pct/100));
    $('#zoom').value = Math.round(zoom*100);
    zoomPctEl.textContent = `${Math.round(zoom*100)}%`;
    render();
  }
  $('#zoom').addEventListener('input', e=> setZoom(parseInt(e.target.value,10)) );

  // Cargar imagen en editor
  $('#openImage').addEventListener('change', ()=>{
    const f = $('#openImage').files?.[0]; if(!f) return;
    const url = URL.createObjectURL(f); loadImageToEditor(url);
  });
  $('#loadPreviewToEditor').addEventListener('click', ()=>{
    const prev = $('#preview'); if(!prev.firstChild) return log('‚ö†Ô∏è No hay imagen en vista previa.');
    const url = prev.firstChild.src; loadImageToEditor(url);
  });

  function loadImageToEditor(src){
    const img = new Image(); img.onload = ()=>{
      baseImg = {image:img, naturalW: img.naturalWidth, naturalH: img.naturalHeight};
      // Ajustar canvas manteniendo proporciones
      const maxW = wrap.clientWidth; const maxH = Math.max(420, wrap.clientHeight);
      const ratio = img.naturalWidth/img.naturalHeight;
      let cw = maxW, ch = Math.round(maxW/ratio);
      if(ch>600){ ch=600; cw = Math.round(ch*ratio); }
      editor.width = cw; editor.height = ch;
      setZoom(100);
      rois = []; activeId = null; refreshRoiList();
      render();
    }; img.src = src;
  }

  function naturalToCanvas(r){
    if(!baseImg) return {x:0,y:0,w:0,h:0};
    const scale = (editor.width/baseImg.naturalW)*zoom;
    return { x: r.x*scale, y: r.y*scale, w: r.w*scale, h: r.h*scale };
  }
  function canvasToNatural(x,y){
    if(!baseImg) return {x:0,y:0};
    const scale = (editor.width/baseImg.naturalW)*zoom;
    return { x: x/scale, y: y/scale };
  }

  function render(){
    ctx.fillStyle = '#0b1426'; ctx.fillRect(0,0,editor.width,editor.height);
    if(baseImg){
      // Dibuja imagen al tama√±o de canvas (zoom aplicado via overlay)
      ctx.drawImage(baseImg.image, 0,0, editor.width, editor.height);
    }
    drawOverlay();
  }

  function drawOverlay(){
    overlay.innerHTML = '';
    if(!baseImg) return;
    for(const r of rois){
      const c = naturalToCanvas(r);
      const div = document.createElement('div');
      div.className = 'roi' + (r.id===activeId? ' selected':'');
      div.style.left = `${c.x}px`; div.style.top = `${c.y}px`;
      div.style.width = `${c.w}px`; div.style.height = `${c.h}px`;
      div.dataset.id = r.id; div.dataset.type = r.type;
      // t√≠tulo
      const title = document.createElement('div'); title.className='title'; title.textContent = `${r.name||r.type}`; div.appendChild(title);
      // asas
      ['nw','ne','sw','se','n','s','w','e'].forEach(h=>{
        const hd = document.createElement('div'); hd.className = `handle ${h}`; hd.dataset.handle=h; hd.dataset.id=r.id;
        hd.addEventListener('pointerdown', onHandleDown);
        div.appendChild(hd);
      });
      // drag
      div.addEventListener('pointerdown', onRoiDown);
      overlay.appendChild(div);
    }
  }

  function onRoiDown(ev){
    const id = ev.currentTarget.dataset.id;
    activeId = id; refreshProps(); refreshRoiList();
    mode='dragging'; dragStart = {cx:ev.clientX, cy:ev.clientY};
    ev.preventDefault();
    window.addEventListener('pointermove', onDragMove);
    window.addEventListener('pointerup', onDragUp, {once:true});
  }
  function onDragMove(ev){
    if(mode!=='dragging') return;
    const r = rois.find(x=>x.id===activeId); if(!r) return;
    const dx = ev.clientX - dragStart.cx; const dy = ev.clientY - dragStart.cy; dragStart.cx = ev.clientX; dragStart.cy = ev.clientY;
    // convierto delta canvas‚Üínatural
    const natDelta = canvasToNatural(dx,dy);
    r.x += natDelta.x; r.y += natDelta.y;
    clampRoi(r);
    drawOverlay(); refreshPropsInputs();
  }
  function onDragUp(){ mode='idle'; window.removeEventListener('pointermove', onDragMove); }

  function onHandleDown(ev){
    resizeHandle = ev.currentTarget.dataset.handle; activeId = ev.currentTarget.dataset.id;
    refreshProps(); refreshRoiList();
    mode='resizing'; dragStart = {cx:ev.clientX, cy:ev.clientY};
    ev.stopPropagation(); ev.preventDefault();
    window.addEventListener('pointermove', onResizeMove);
    window.addEventListener('pointerup', onResizeUp, {once:true});
  }
  function onResizeMove(ev){
    if(mode!=='resizing') return;
    const r = rois.find(x=>x.id===activeId); if(!r) return;
    const dx = ev.clientX - dragStart.cx; const dy = ev.clientY - dragStart.cy; dragStart.cx = ev.clientX; dragStart.cy = ev.clientY;
    const d = canvasToNatural(dx,dy);
    const min=8; // px naturales
    if(['w','nw','sw'].includes(resizeHandle)){ r.x += d.x; r.w -= d.x; }
    if(['e','ne','se'].includes(resizeHandle)){ r.w += d.x; }
    if(['n','nw','ne'].includes(resizeHandle)){ r.y += d.y; r.h -= d.y; }
    if(['s','sw','se'].includes(resizeHandle)){ r.h += d.y; }
    r.w = Math.max(min, r.w); r.h = Math.max(min, r.h);
    clampRoi(r);
    drawOverlay(); refreshPropsInputs();
  }
  function onResizeUp(){ mode='idle'; resizeHandle=null; window.removeEventListener('pointermove', onResizeMove); }

  function clampRoi(r){
    if(!baseImg) return; const W=baseImg.naturalW, H=baseImg.naturalH;
    r.x = Math.max(0, Math.min(W - r.w, r.x));
    r.y = Math.max(0, Math.min(H - r.h, r.y));
  }

  // Crear ROI
  $('#addRoi').addEventListener('click', ()=>{
    createType = $('#newRoiType').value;
    mode='creating';
    log(`‚ûï Arrastra sobre la imagen para crear ROI (${createType}).`);
  });

  overlay.addEventListener('pointerdown', ev=>{
    if(mode!=='creating') return;
    const rect = editor.getBoundingClientRect();
    const cx = ev.clientX - rect.left; const cy = ev.clientY - rect.top;
    const startNat = canvasToNatural(cx,cy);
    const tmp = { id: crypto.randomUUID(), name:`${createType}-${rois.length+1}`, type:createType, x:startNat.x,y:startNat.y,w:10,h:10 };
    activeId = tmp.id; rois.push(tmp); refreshRoiList(); drawOverlay();
    function move(ev2){
      const x2 = Math.max(0, Math.min(rect.width, ev2.clientX - rect.left));
      const y2 = Math.max(0, Math.min(rect.height, ev2.clientY - rect.top));
      const n2 = canvasToNatural(x2,y2);
      tmp.w = Math.abs(n2.x - startNat.x); tmp.h = Math.abs(n2.y - startNat.y);
      tmp.x = Math.min(startNat.x, n2.x); tmp.y = Math.min(startNat.y, n2.y);
      clampRoi(tmp); drawOverlay(); refreshPropsInputs();
    }
    function up(){ window.removeEventListener('pointermove', move); window.removeEventListener('pointerup', up); mode='idle'; }
    window.addEventListener('pointermove', move); window.addEventListener('pointerup', up, {once:true});
  });

  // Lista y propiedades
  function refreshRoiList(){
    const list = $('#roiList'); list.innerHTML='';
    for(const r of rois){
      const it=document.createElement('div'); it.className='item'+(r.id===activeId?' active':''); it.dataset.id=r.id;
      const dot=document.createElement('span'); dot.className='dot'; dot.style.background=getTypeColor(r.type);
      const nm=document.createElement('span'); nm.textContent = `${r.name||r.type}`; nm.style.color='#e2e8f0';
      const tp=document.createElement('span'); tp.className='tag'; tp.textContent=r.type;
      it.append(dot,nm,tp); it.addEventListener('click',()=>{ activeId=r.id; refreshRoiList(); refreshProps(); });
      list.appendChild(it);
    }
    drawOverlay();
  }
  function getTypeColor(t){
    return {'text':'#60a5fa','barcode':'#f97316','pdf417':'#22c55e','mrz':'#e11d48','image':'#a855f7'}[t]||'#60a5fa';
  }
  function refreshProps(){
    const r = rois.find(x=>x.id===activeId);
    $('#propName').value = r? (r.name||'') : '';
    $('#propType').value = r? r.type : 'text';
    refreshPropsInputs();
  }
  function refreshPropsInputs(){
    const r = rois.find(x=>x.id===activeId); if(!r){ ['propX','propY','propW','propH'].forEach(id=> $('#'+id).value=''); return; }
    $('#propX').value = Math.round(r.x);
    $('#propY').value = Math.round(r.y);
    $('#propW').value = Math.round(r.w);
    $('#propH').value = Math.round(r.h);
  }
  $('#propName').addEventListener('input', e=>{ const r=rois.find(x=>x.id===activeId); if(r){ r.name=e.target.value; refreshRoiList(); }});
  $('#propType').addEventListener('change', e=>{ const r=rois.find(x=>x.id===activeId); if(r){ r.type=e.target.value; refreshRoiList(); }});
  ['propX','propY','propW','propH'].forEach(id=>{
    $('#'+id).addEventListener('change', e=>{
      const r=rois.find(x=>x.id===activeId); if(!r) return; r[id.slice(-1).toLowerCase()] = parseFloat(e.target.value)||0; clampRoi(r); drawOverlay();
    });
  });
  $('#btnDelete').addEventListener('click', ()=>{ rois = rois.filter(x=>x.id!==activeId); activeId=null; refreshRoiList(); refreshProps(); });

  // Exportar/Importar plantillas (coordenadas relativas)
  $('#exportTpl').addEventListener('click', ()=>{
    if(!baseImg) return log('‚ö†Ô∏è Carga una imagen antes de exportar plantilla.');
    const rel = rois.map(r=>({id:r.id, name:r.name, type:r.type, x:r.x/baseImg.naturalW, y:r.y/baseImg.naturalH, w:r.w/baseImg.naturalW, h:r.h/baseImg.naturalH}));
    const blob = new Blob([JSON.stringify({imageW:baseImg.naturalW,imageH:baseImg.naturalH, rois:rel},null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='plantilla_rois.json'; a.click();
  });
  $('#importTpl').addEventListener('change', async()=>{
    const f = $('#importTpl').files?.[0]; if(!f) return; if(!baseImg) return log('‚ö†Ô∏è Carga una imagen antes de importar.');
    const txt = await f.text(); const json = JSON.parse(txt);
    rois = json.rois.map(r=>({id:crypto.randomUUID(), name:r.name, type:r.type, x:r.x*baseImg.naturalW, y:r.y*baseImg.naturalH, w:r.w*baseImg.naturalW, h:r.h*baseImg.naturalH}));
    activeId = rois[0]?.id||null; refreshRoiList(); refreshProps();
  });

  // Extracciones
  $('#btnExtract').addEventListener('click', ()=>{ const r=rois.find(x=>x.id===activeId); if(r) extractROI(r); });
  $('#btnExtractAll').addEventListener('click', async()=>{
    for(const r of rois){ await extractROI(r); }
  });

  async function extractROI(r){
    if(!baseImg) return log('‚ö†Ô∏è No hay imagen.');
    const crop = cropCanvas(r);
    if(r.type==='image'){
      const data = crop.toDataURL('image/png');
      log(`üñºÔ∏è ${r.name}: captura base64 (${data.length} chars)`);
      return data;
    }
    if(r.type==='text'){
      const { data: { text } } = await Tesseract.recognize(crop, 'eng+spa', { logger: m=>{} });
      log(`üî§ ${r.name}:\n${text.trim()}`);
      return text;
    }
    if(r.type==='barcode' || r.type==='pdf417'){
      try{
        const img = await canvasToImage(crop);
        const res = await ensureZXing().decodeFromImage(img);
        log(`üè∑Ô∏è ${r.name}: ${res.text}`);
        if(r.type==='pdf417'){
          try{ const parsed = parseDUISV(res.text||''); if(parsed && Object.keys(parsed).length){ fillTable(duiTable, parsed); } }catch{}
        }
        return res.text;
      }catch(e){ log(`‚ùå ${r.name}: ${e}`); return ''; }
    }
    if(r.type==='mrz'){
      // MRZ: OCR + parseo
      const { data: { text } } = await Tesseract.recognize(crop, 'eng', { logger:m=>{} });
      const lines = text.split(/\r?\n/).map(s=>s.replace(/\s+/g,'').toUpperCase()).filter(Boolean);
      const parsed = parseMRZ(lines);
      if(parsed) { fillTable(mrzTable, parsed); log(`üõÑ ${r.name}: MRZ parseado.`); }
      else { log(`‚ÑπÔ∏è ${r.name}: MRZ no reconocido.\n${lines.join('\n')}`); }
      return parsed;
    }
  }

  function cropCanvas(r){
    const c = document.createElement('canvas'); c.width = Math.max(1, Math.round(r.w)); c.height = Math.max(1, Math.round(r.h));
    const cctx = c.getContext('2d');
    // Dibujar en coordenadas NATURALES ‚Üí escalar a crop
    cctx.drawImage(baseImg.image, r.x, r.y, r.w, r.h, 0,0, c.width, c.height);
    return c;
  }
  async function canvasToImage(c){
    return await new Promise(res=>{ const img = new Image(); img.onload=()=>res(img); img.src = c.toDataURL('image/png'); });
  }

  // Redibujar cuando cambia tama√±o contenedor
  const ro = new ResizeObserver(()=> render()); ro.observe(wrap);

  /*************************
   * PARSEADORES (DUI/MRZ) *
   *************************/
  // ‚ö†Ô∏è Heur√≠stico para PDF417 del DUI de El Salvador. Ajusta si tu fuente difiere.
  function parseDUISV(raw){
    if(!raw) return null;
    const s = raw.replace(/[\u0000-\u001f]/g,' ').replace(/[\s\|]+/g,' ').trim();
    // Tokens potenciales separados por '^', '/', ',' o espacio m√∫ltiple
    const tokens = raw.split(/[\^\|,\n\r]+/).map(t=>t.trim()).filter(Boolean);
    // Buscar n√∫mero DUI (7‚Äì9 d√≠gitos)
    let numero = (s.match(/\b\d{7,9}\b/)||[])[0]||'';
    // Buscar n√∫mero de emisi√≥n (1‚Äì3)
    let emision = (s.match(/\b(\d{1,3})\b(?!.*\b\d{1,3}\b)/)||[])[1]||'';
    // Heur√≠stica de nombres/apellidos: busca 2 apellidos seguidos de nombres
    let primerApellido='', segundoApellido='', nombres='';
    // Encuentra secuencia de 2-3 tokens alfab√©ticos largos en may√∫sculas
    const alpha = tokens.filter(t=>/^[A-Z√Å√â√ç√ì√ö√ë ]{2,}$/.test(t));
    if(alpha.length>=3){ primerApellido=alpha[0]; segundoApellido=alpha[1]; nombres=alpha.slice(2).join(' '); }
    // Firma digital: √∫ltimo bloque largo base64/ASCII extendido si existe
    let firma = (raw.match(/[A-Za-z0-9+\/]{16,}={0,2}/g)||[]).slice(-1)[0]||'';

    const out = {};
    if(numero) out["N√∫mero de DUI"] = numero;
    if(primerApellido) out["Primer Apellido"] = primerApellido;
    if(segundoApellido||nombres) out["Segundo Apellido y Nombres"] = [segundoApellido,nombres].filter(Boolean).join(' ');
    if(emision) out["N√∫mero de Emisi√≥n"] = emision;
    if(firma) out["Firma Digital"] = firma;
    // Si est√° muy vac√≠o, no retornes nada
    return Object.keys(out).length? out : null;
  }

  // MRZ gen√©rico TD3 (2√ó44) y TD1 (3√ó30)
  function parseMRZ(lines){
    if(!lines || !lines.length) return null;
    // TD3 pasaporte: 2 l√≠neas de 44
    if(lines.length>=2 && lines[0].length>=40 && lines[1].length>=40){
      const l1 = lines[0].padEnd(44,'<'); const l2 = lines[1].padEnd(44,'<');
      if(l1[0]==='P'){
        const issuing = l1.slice(2,5).replace(/</g,'');
        const namesRaw = l1.slice(5).replace(/</g,' ').trim();
        const doc = l2.slice(0,9).replace(/</g,'');
        const nationality = l2.slice(10,13).replace(/</g,'');
        const birth = l2.slice(13,19);
        const sex = l2.slice(20,21);
        const expiry = l2.slice(21,27);
        const personal = l2.slice(28,42).replace(/</g,'');
        return { Tipo:'TD3', Pa√≠sEmisor:issuing, Documento:doc, Nacionalidad:nationality, Nacimiento:fmtDateYYMMDD(birth), Sexo:sex, Expira:fmtDateYYMMDD(expiry), Nombre: namesRaw, Extra: personal };
      }
    }
    // TD1 ID: 3√ó30
    if(lines.length>=3 && lines[0].length>=28 && lines[1].length>=28 && lines[2].length>=28){
      const a = lines[0].padEnd(30,'<'); const b = lines[1].padEnd(30,'<'); const c = lines[2].padEnd(30,'<');
      const doc = a.slice(5,14).replace(/</g,'');
      const issuing = a.slice(2,5).replace(/</g,'');
      const birth = b.slice(0,6);
      const sex = b.slice(7,8);
      const expiry = b.slice(8,14);
      const nationality = b.slice(15,18).replace(/</g,'');
      const namesRaw = c.replace(/</g,' ').trim();
      return { Tipo:'TD1', Pa√≠sEmisor:issuing, Documento:doc, Nacionalidad:nationality, Nacimiento:fmtDateYYMMDD(birth), Sexo:sex, Expira:fmtDateYYMMDD(expiry), Nombre:namesRaw };
    }
    return null;
  }
  function fmtDateYYMMDD(s){ if(!/^[0-9]{6}$/.test(s)) return s; const yy=s.slice(0,2), mm=s.slice(2,4), dd=s.slice(4,6); return `20${yy}-${mm}-${dd}`; }

  </script>
</body>
</html>
