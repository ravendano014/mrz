<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PDF417 ‚Äî C√°mara / Imagen, ROI, Raw, JSON, Tabla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ====== Librer√≠as por CDN ====== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/inferencejs@1.1.3"></script>
  <!-- ZXing UMD (compatible con PDF417) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

  <style>
    :root{
      --bg:#0b0f12; --fg:#e6edf3; --muted:#93a1ad; --accent:#39d353; --danger:#ff6b6b;
      --panel:#0f1419; --card:#11161c; --line:#1b2631; --btn:#1a2633; --btn2:#14202b; --yellow:#ffd866;
    }
    *{ box-sizing:border-box }
    html,body{height:100%;margin:0}
    body{
      background:linear-gradient(180deg,var(--bg),#050709 60%); color:var(--fg);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden;
    }
    #stage{ 
      position:fixed; 
      inset:0; 
      background:#000;
      z-index: 1;
    }
    #video{
      position:absolute; 
      inset:0; 
      width:100%; 
      height:100%; 
      object-fit:contain; 
      background:#000; 
      display: block !important;
      z-index: 1;
    }
    #overlay{ 
      position:absolute; 
      inset:0; 
      width:100%; 
      height:100%; 
      object-fit:contain; 
      pointer-events:none; 
      z-index: 2;
    }

    #panel{
      position:fixed; 
      top:0; 
      right:0; 
      height:100%; 
      width:min(420px, 42vw);
      background:linear-gradient(180deg,var(--panel),#0b1117); 
      border-left:1px solid var(--line);
      padding:14px 14px 88px; 
      overflow:auto; 
      box-shadow:-8px 0 24px rgba(0,0,0,.35);
      z-index: 3;
    }
    #panel h1{ font-size:16px; margin:0 0 8px; letter-spacing:.3px }
    .sub{ color:var(--muted); font-size:12px; margin:0 0 12px }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
    button{
      background:var(--btn); color:var(--fg); border:1px solid var(--line); border-radius:10px; padding:8px 10px;
      cursor:pointer; font-weight:600;
    }
    button:hover{ background:var(--btn2) }
    button.primary{ border-color:#254a2f; background:#13281a }
    button.success{ border-color:#224e37; background:#10261d }
    button.warn{ border-color:#4a3b17; background:#241d0c }
    button.danger{ border-color:#4f1f1f; background:#281012; color:#ffdede }
    .ghost{ background:transparent }

    textarea, pre, input[type="text"]{
      width:100%; background:var(--card); color:var(--fg); border:1px solid var(--line);
      border-radius:10px; padding:8px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    textarea{ min-height:110px; resize:vertical }
    .grid{ display:grid; gap:8px; }
    .split2{ grid-template-columns:1fr 1fr }
    .status{
      position:fixed; left:12px; right:calc(min(420px, 42vw) + 12px); bottom:12px;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px; border-radius:12px; background:#0d1318cc; backdrop-filter: blur(4px);
      border:1px solid var(--line);
      z-index: 4;
    }
    .pill{ padding:4px 8px; border-radius:999px; font-weight:700; letter-spacing:.3px; border:1px solid var(--line); background:#0f161ccc }
    .ok{ color:#c9ffd9; border-color:#1f4e2c; background:#0e2316 }
    .bad{ color:#ffd3d3; border-color:#5a1f1f; background:#2a1010 }
    .info{ color:#d2e8ff; border-color:#1d3f61; background:#0f1f2d }
    .hint{ color:#ffe8b5; border-color:#4a3b17; background:#241d0c }
    table{
      width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--line);
      border-radius:10px; overflow:hidden; display:block; max-height:260px; overflow:auto;
    }
    th,td{ padding:8px; border-bottom:1px solid var(--line); text-align:left; font-size:13px }
    th{ position:sticky; top:0; background:#0f1820; z-index:1 }
    .fps{ margin-left:auto }
    .hr{ height:1px; background:var(--line); margin:10px 0 }
    .note{ color:var(--muted); font-size:12px }
    .spacer{ height:6px }
    .hidden{ display:none !important }
    .preview{ width:100%; aspect-ratio:4/3; border:1px dashed #2a3b4d; border-radius:10px; background:#0b0f12; display:grid; place-items:center; overflow:hidden; }
    .preview canvas, .preview img{ width:100%; height:100%; object-fit:contain }
    .tag{ font-size:11px; color:#9fb3c8 }
    .badge{ padding:2px 6px; border-radius:6px; border:1px solid var(--line); background:#0e141a; color:#ffd866; font-weight:700 }
    
    /* Mensaje de ayuda */
    .help-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(15, 20, 25, 0.9);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      max-width: 300px;
      z-index: 5;
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body>

  <!-- Escenario c√°mara -->
  <div id="stage">
    <div class="help-message" id="helpMessage">
      <h3>Inicia la c√°mara</h3>
      <p>Haz clic en "‚ñ∂ Iniciar c√°mara" para comenzar</p>
    </div>
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <!-- Panel -->
  <aside id="panel">
    <h1>PDF417 ‚Äî c√°mara e imagen</h1>
    <p class="sub">Inicia la c√°mara o carga una imagen; detecta, captura ROI, extrae raw y parsea a JSON + tabla.</p>

    <!-- C√°mara -->
    <div class="row">
      <button id="btnStart" class="primary">‚ñ∂ Iniciar c√°mara</button>
      <button id="btnStop" class="danger">‚ñ† Detener c√°mara</button>
      <button id="btnFlip">‚Ü∫ Cambiar c√°mara</button>
      <span class="badge">Detecci√≥n: InferenceJS</span>
    </div>

    <!-- Imagen -->
    <div class="row">
      <input id="fileImage" type="file" accept="image/*" class="hidden" />
      <button id="btnPick" class="warn">üñºÔ∏è Cargar imagen</button>
      <button id="btnDetectImg" class="">üîé Detectar en imagen</button>
      <span class="tag" id="tag-detector">Decoder: auto (BarcodeDetector/ZXing)</span>
    </div>

    <div class="hr"></div>

    <!-- Acciones comunes -->
    <div class="row">
      <button id="btnCapture" class="warn">‚ßâ Capturar ROI (fuente activa)</button>
      <button id="btnDecode" class="success">‚á£ Extraer (raw)</button>
      <button id="btnParse">{} Parsear JSON</button>
    </div>

    <div class="spacer"></div>
    <div class="grid">
      <label>Texto crudo (raw PDF417)</label>
      <textarea id="txtRaw" placeholder="Aqu√≠ aparecer√° el texto extra√≠do‚Ä¶"></textarea>
    </div>

    <div class="spacer"></div>
    <div class="grid split2">
      <div>
        <label>JSON parseado</label>
        <textarea id="txtJson" placeholder='{"campo":"valor", ‚Ä¶}'></textarea>
      </div>
      <div>
        <label>Previsualizaci√≥n / ROI</label>
        <div class="preview"><canvas id="roiCanvas"></canvas></div>
      </div>
    </div>

    <div class="spacer"></div>
    <div class="grid">
      <label>Tabla</label>
      <table id="tbl"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- Vista de imagen cargada -->
    <div class="spacer"></div>
    <div class="grid">
      <label>Imagen cargada (detecci√≥n offline)</label>
      <div class="preview"><canvas id="imgCanvasPreview"></canvas></div>
      <p class="note">Consejo: usa im√°genes n√≠tidas, sin reflejos y con el c√≥digo ocupando buena parte del encuadre.</p>
    </div>
  </aside>

  <div class="status" id="status">
    <span class="pill info" id="sCam">C√°mara: detenida</span>
    <span class="pill info" id="sModel">Modelo: cargando‚Ä¶</span>
    <span class="pill info" id="sDec">Decoder: inicializando‚Ä¶</span>
    <span class="pill ok hidden" id="sHit">Detectado</span>
    <span class="pill bad hidden" id="sMiss">Sin detecci√≥n</span>
    <span class="pill info fps" id="sFPS">FPS: ‚Äî</span>
  </div>

  <script>
  (function(){
    const { InferenceEngine, CVImage } = inferencejs;
    const ZX = window.ZXing; // UMD
    const $ = window.jQuery;

    // ====== Elementos ======
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const octx = overlay.getContext('2d');
    const roiCanvas = document.getElementById('roiCanvas');
    const roictx = roiCanvas.getContext('2d');
    const imgCanvasPreview = document.getElementById('imgCanvasPreview');
    const ipctx = imgCanvasPreview.getContext('2d');
    const helpMessage = document.getElementById('helpMessage');

    const sCam = $('#sCam'), sModel = $('#sModel'), sDec = $('#sDec'), sHit = $('#sHit'), sMiss = $('#sMiss'), sFPS = $('#sFPS');
    const tagDetector = $('#tag-detector');

    // ====== Estado ======
    let facingMode = 'environment';
    let stream = null;
    let running = false;
    let sourceMode = 'video'; // 'video' | 'image'

    const engine = new InferenceEngine();
    let workerId = null;
    let rafId = 0;
    let lastBBox = null; // para c√°mara
    let lastBBoxImg = null; // para imagen
    let lastTS = performance.now(), fpsSMA = [];

    // Imagen cargada (canvas de trabajo oculto, tama√±o nativo)
    const imgCanvasFull = document.createElement('canvas');
    const ifctx = imgCanvasFull.getContext('2d');

    // Decodificador
    let hasBarcodeDetector = ('BarcodeDetector' in window);
    let nativePdf417Supported = false;
    let pdfReader = null; // ZXing BrowserPDF417Reader

    // ====== Utilidades ======
    function setCanvasToVideoSize() {
      const vw = video.videoWidth || 1280;
      const vh = video.videoHeight || 720;
      overlay.width = vw; overlay.height = vh;
    }
    
    function updateFPS() {
      const now = performance.now();
      const delta = now - lastTS;
      lastTS = now;
      const fps = 1000 / delta;
      fpsSMA.push(fps);
      if (fpsSMA.length > 20) fpsSMA.shift();
      const avg = fpsSMA.reduce((a,b)=>a+b,0)/fpsSMA.length || 0;
      sFPS.text(`FPS: ${avg.toFixed(0)}`);
    }
    
    function paintBoxesCanvas(ctx, boxes, color='#39d353'){
      ctx.lineWidth = 4; ctx.font = '16px ui-monospace';
      boxes.forEach(p=>{
        const { x,y,width,height } = p.bbox;
        ctx.strokeStyle = color;
        ctx.strokeRect(x - width/2, y - height/2, width, height);
        ctx.fillStyle = '#13281a';
        const label = `${p.class} ${(p.confidence*100|0)}%`;
        const tw = ctx.measureText(label).width + 10;
        ctx.fillRect(x - width/2, y - height/2 - 22, tw, 20);
        ctx.fillStyle = '#c9ffd9';
        ctx.fillText(label, x - width/2 + 5, y - height/2 - 7);
      });
    }
    
    function paintBoxesVideo(preds){
      octx.clearRect(0,0,overlay.width,overlay.height);
      if (!preds || !preds.length) return;
      paintBoxesCanvas(octx, preds);
    }
    
    function setHit(ok){
      if (ok){ sHit.removeClass('hidden'); sMiss.addClass('hidden'); }
      else { sMiss.removeClass('hidden'); sHit.addClass('hidden'); }
    }
    
    function escapeHtml(str){
      return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }
    
    function renderTable(obj){
      const $tb = $('#tbl tbody'); $tb.empty();
      if (!obj || typeof obj!=='object') return;
      Object.entries(obj).forEach(([k,v])=>{
        let val = (typeof v==='object') ? JSON.stringify(v) : String(v);
        if (val.length > 300) val = val.slice(0,300)+'‚Ä¶';
        $tb.append(`<tr><td>${escapeHtml(k)}</td><td>${escapeHtml(val)}</td></tr>`);
      });
    }

    // ====== C√°mara ======
    async function startCamera(){
      stopCamera();
      try{
        // Forzar dimensiones espec√≠ficas
        const constraints = { 
          video: { 
            facingMode,
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }, 
          audio: false 
        };
        
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        
        // Esperar a que el video est√© listo
        await new Promise((resolve) => {
          video.onloadedmetadata = resolve;
        });
        
        await video.play();
        setCanvasToVideoSize();
        sCam.removeClass('bad info').addClass('ok').text(`C√°mara: activa (${facingMode})`);
        sourceMode = 'video';
        running = true;
        
        // Ocultar mensaje de ayuda
        helpMessage.classList.add('hidden');
        
        loopDetect();
        
      }catch(err){
        sCam.removeClass('ok info').addClass('bad').text('C√°mara: error - ' + err.message);
        console.error('Error c√°mara:', err);
        
        // Mostrar mensaje de error
        helpMessage.innerHTML = '<h3>Error de c√°mara</h3><p>' + err.message + '</p>';
        helpMessage.classList.remove('hidden');
      }
    }
    
    function stopCamera(){
      running = false;
      if (rafId) cancelAnimationFrame(rafId);
      if (stream){ 
        stream.getTracks().forEach(t=>t.stop()); 
        stream = null; 
      }
      sCam.removeClass('ok info').addClass('bad').text('C√°mara: detenida');
      
      // Mostrar mensaje de ayuda
      helpMessage.innerHTML = '<h3>Inicia la c√°mara</h3><p>Haz clic en "‚ñ∂ Iniciar c√°mara" para comenzar</p>';
      helpMessage.classList.remove('hidden');
      
      // Limpiar overlay
      octx.clearRect(0,0,overlay.width,overlay.height);
    }

    // ====== Modelo ======
    async function loadModel(){
      try{
        sModel.removeClass('ok bad').addClass('info').text('Modelo: cargando‚Ä¶');
        workerId = await engine.startWorker(
          "pdf417-kl4vz-hl0le", // tu modelo
          "1",
          "rf_hHUmNcZwoGhdPO3kyAlI6YY4R4m2"
        );
        sModel.removeClass('bad info').addClass('ok').text('Modelo: listo');
      }catch(e){
        sModel.removeClass('ok info').addClass('bad').text('Modelo: error');
        console.error(e);
      }
    }

    // ====== Decoder ======
    async function initDecoder(){
      let using = 'ZXing (fallback)';
      pdfReader = new ZX.BrowserPDF417Reader();
      if (hasBarcodeDetector) {
        try{
          const formats = await BarcodeDetector.getSupportedFormats?.();
          nativePdf417Supported = Array.isArray(formats) && formats.includes('pdf417');
        }catch{}
        if (nativePdf417Supported) using = 'BarcodeDetector (nativo)';
      }
      sDec.removeClass('bad info').addClass('ok').text('Decoder: listo');
      $('#tag-detector').text(`Decoder: ${using}`);
    }

    async function decodeFromCanvas(canvas){
      // 1) Nativo
      if (nativePdf417Supported) {
        try{
          const bd = new BarcodeDetector({ formats:['pdf417'] });
          const bitmap = await createImageBitmap(canvas);
          const codes = await bd.detect(bitmap);
          if (codes && codes.length) {
            const hit = codes.find(c=>c.rawValue) || codes[0];
            return hit.rawValue || '';
          }
        }catch(e){ /* fallback */ }
      }
      // 2) ZXing
      try{
        const url = canvas.toDataURL('image/png');
        const img = new Image();
        await new Promise(res=>{ img.onload=res; img.src=url; });
        if (typeof pdfReader.decodeFromImageElement === 'function') {
          const res = await pdfReader.decodeFromImageElement(img);
          return res?.getText?.() || res?.text || '';
        }
        if (typeof pdfReader.decodeOnceFromImageElement === 'function') {
          const res = await pdfReader.decodeOnceFromImageElement(img);
          return res?.getText?.() || res?.text || '';
        }
      }catch(e){}
      return '';
    }

    // ====== Detecci√≥n (loop c√°mara) ======
    async function loopDetect(){
      if (!running || !workerId || !video.videoWidth) { 
        rafId = requestAnimationFrame(loopDetect); 
        return; 
      }
      const image = new CVImage(video);
      try{
        const preds = await engine.infer(workerId, image);
        paintBoxesVideo(preds);
        if (preds && preds.length){
          const best = preds.find(p => (p.class||'').toLowerCase().includes('pdf')) || preds[0];
          lastBBox = best.bbox; setHit(true);
        } else { lastBBox = null; setHit(false); }
      }catch(e){ console.warn('infer error', e); }
      updateFPS();
      rafId = requestAnimationFrame(loopDetect);
    }

    // ====== Detecci√≥n en imagen ======
    function loadImageFile(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>{
          const img = new Image();
          img.onload = ()=>{
            // canvas de trabajo a tama√±o nativo
            imgCanvasFull.width = img.naturalWidth; imgCanvasFull.height = img.naturalHeight;
            ifctx.drawImage(img, 0, 0);
            // preview a tama√±o panel
            fitPreview(img);
            sourceMode = 'image';
            resolve();
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    function fitPreview(img){
      const W = imgCanvasPreview.width = imgCanvasPreview.clientWidth || 640;
      const H = imgCanvasPreview.height = imgCanvasPreview.clientHeight || 480;
      // ajustar con contain
      const rImg = img.naturalWidth / img.naturalHeight;
      const rPrev = W / H;
      let dw = W, dh = H, dx = 0, dy = 0;
      if (rPrev > rImg) { dw = H * rImg; dx = (W - dw)/2; }
      else { dh = W / rImg; dy = (H - dh)/2; }
      ipctx.clearRect(0,0,W,H);
      ipctx.fillStyle = '#000'; ipctx.fillRect(0,0,W,H);
      ipctx.drawImage(img, dx, dy, dw, dh);
    }
    
    async function detectOnImage(){
      if (!imgCanvasFull.width) return null;
      const image = new CVImage(imgCanvasFull);
      try{
        const preds = await engine.infer(workerId, image);
        // pintar en preview escalando bbox
        ipctx.drawImage(imgCanvasFull, 0, 0, imgCanvasPreview.width, imgCanvasPreview.height);
        if (preds && preds.length){
          const best = preds.find(p => (p.class||'').toLowerCase().includes('pdf')) || preds[0];
          lastBBoxImg = best.bbox; setHit(true);
          // escalar y dibujar bbox en preview
          const sx = imgCanvasPreview.width / imgCanvasFull.width;
          const sy = imgCanvasPreview.height / imgCanvasFull.height;
          paintBoxesCanvas(ipctx, [{bbox:{
            x: best.bbox.x * sx,
            y: best.bbox.y * sy,
            width: best.bbox.width * sx,
            height: best.bbox.height * sy
          }, class: best.class||'pdf417', confidence: best.confidence}], '#ffb347');
        } else {
          lastBBoxImg = null; setHit(false);
        }
      }catch(e){ console.warn('infer (img) error', e); }
    }

    // ====== Captura ROI (fuente activa) ======
    function captureROI(){
      if (sourceMode === 'video') {
        if (!lastBBox || !video.videoWidth) return null;
        const { x,y,width,height } = lastBBox;
        const sx = Math.max(0, (x - width/2) | 0);
        const sy = Math.max(0, (y - height/2) | 0);
        const sw = Math.min(overlay.width - sx, width | 0);
        const sh = Math.min(overlay.height - sy, height | 0);

        // frame actual del video ‚Üí roiCanvas
        const frame = document.createElement('canvas');
        frame.width = overlay.width; frame.height = overlay.height;
        const fctx = frame.getContext('2d');
        fctx.drawImage(video, 0, 0, frame.width, frame.height);

        roiCanvas.width = sw || 1; roiCanvas.height = sh || 1;
        roictx.clearRect(0,0,sw,sh);
        roictx.drawImage(frame, sx, sy, sw, sh, 0, 0, sw, sh);
        return { source:'video', sx, sy, sw, sh };
      } else { // 'image'
        if (!lastBBoxImg || !imgCanvasFull.width) return null;
        const { x,y,width,height } = lastBBoxImg;
        const sx = Math.max(0, (x - width/2) | 0);
        const sy = Math.max(0, (y - height/2) | 0);
        const sw = Math.min(imgCanvasFull.width - sx, width | 0);
        const sh = Math.min(imgCanvasFull.height - sy, height | 0);

        roiCanvas.width = sw || 1; roiCanvas.height = sh || 1;
        roictx.clearRect(0,0,sw,sh);
        roictx.drawImage(imgCanvasFull, sx, sy, sw, sh, 0, 0, sw, sh);
        return { source:'image', sx, sy, sw, sh };
      }
    }

    // ====== Parseo heur√≠stico ======
    function parsePdf417Raw(raw){
      const out = {};
      const trimmed = (raw||'').trim();
      out.raw_length = trimmed.length;
      const parts = trimmed.split('||').map(s=>s.trim()).filter(Boolean);
      if (parts.length > 1){
        const labels = ["Campo01","Campo02","Campo03","Campo04","Campo05","Campo06","Campo07","Campo08","Campo09","Campo10","Campo11","Campo12","Campo13","Campo14","Campo15","Campo16","Campo17","Campo18"];
        parts.forEach((p,i)=> out[labels[i] || `Campo${i+1}`] = p);
      } else {
        const byLine = trimmed.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
        if (byLine.length>1) out.lineas = byLine;
        else out.tokens = trimmed.split(/[\s|]+/).map(x=>x.trim()).filter(Boolean);
      }
      const dateISO = trimmed.match(/\b(19|20)\d{2}[-/](0[1-9]|1[0-2])[-/](0[1-9]|[12]\d|3[01])\b/);
      const dateLat = trimmed.match(/\b(0[1-9]|[12]\d|3[01])[-/](0[1-9]|1[0-2])[-/](19|20)\d{2}\b/);
      if (dateISO) out.fechaISO_detectada = dateISO[0];
      if (dateLat) out.fechaLat_detectada = dateLat[0];
      return out;
    }

    // ====== Eventos UI ======
    $('#btnStart').on('click', startCamera);
    $('#btnStop').on('click', stopCamera);
    $('#btnFlip').on('click', async ()=>{ 
      facingMode = (facingMode==='environment') ? 'user':'environment'; 
      if (running) await startCamera(); 
    });

    $('#btnPick').on('click', ()=> $('#fileImage').trigger('click'));
    $('#fileImage').on('change', async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      try{
        await loadImageFile(file);
        setHit(false);
        // tras cargar, intenta detectar en imagen autom√°ticamente
        await detectOnImage();
        // al trabajar con imagen, detenemos la c√°mara si estaba activa
        if (running) stopCamera();
      }catch(err){ console.error(err); }
    });

    $('#btnDetectImg').on('click', detectOnImage);

    $('#btnCapture').on('click', ()=>{
      const r = captureROI();
      if (!r) setHit(false);
    });

    $('#btnDecode').on('click', async ()=>{
      // si hay ROI, decodificar sobre ROI; si no, seg√∫n fuente activa
      let canvas = roiCanvas;
      if (canvas.width <= 2 || canvas.height <= 2){
        if (sourceMode === 'video'){
          const full = document.createElement('canvas');
          full.width = overlay.width; full.height = overlay.height;
          full.getContext('2d').drawImage(video, 0,0, full.width, full.height);
          canvas = full;
        } else {
          if (!imgCanvasFull.width){ setHit(false); return; }
          canvas = imgCanvasFull;
        }
      }
      const raw = await decodeFromCanvas(canvas);
      $('#txtRaw').val(raw || '');
      setHit(!!raw);
    });

    $('#btnParse').on('click', ()=>{
      const raw = $('#txtRaw').val();
      const json = parsePdf417Raw(raw);
      $('#txtJson').val(JSON.stringify(json, null, 2));
      renderTable(json);
    });

    // ====== Init ======
    (async function init(){
      await Promise.all([loadModel(), initDecoder()]);
    })();

    // Redimensiona overlay al cambiar tama√±o
    window.addEventListener('resize', ()=>{ if (video.videoWidth) setCanvasToVideoSize(); });

  })();
  </script>
</body>
</html>
